<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>muGen - AI Image Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Inter Font (Mac-like) */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        html, body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
        }

        /* Custom scrollbar for sidebar */
        .sidebar-scroll::-webkit-scrollbar { width: 4px; }
        .sidebar-scroll::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 4px; }
        .sidebar-scroll::-webkit-scrollbar-track { background-color: #1f2937; }

        /* Dynamic Noise Animation */
        .noise-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden; background: #111827; z-index: 10;
            display: none; opacity: 0; transition: opacity 0.3s ease-in-out;
        }
        .noise-container.active { display: block; opacity: 1; }
        .noise-container::before {
            content: ""; position: absolute; top: -50%; left: -50%;
            width: 200%; height: 200%;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 256 256'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
            background-size: 128px 128px; opacity: 0.15;
            animation: noise-animation 0.2s linear infinite;
        }
        @keyframes noise-animation {
            0% { transform: translate(0, 0); } 10% { transform: translate(-5%, -5%); }
            20% { transform: translate(-10%, 5%); } 30% { transform: translate(5%, -10%); }
            40% { transform: translate(-5%, 15%); } 50% { transform: translate(-10%, -5%); }
            60% { transform: translate(15%, 0); } 70% { transform: translate(0, 10%); }
            80% { transform: translate(-15%, 0); } 90% { transform: translate(10%, 5%); }
            100% { transform: translate(5%, 0); }
        }

        /* Custom Checkbox */
        .style-checkbox:checked + label {
            background-color: #4f46e5; border-color: #4f46e5; color: #ffffff;
        }
        .model-checkbox:checked + label {
            background-color: #3730a3; border-color: #4f46e5; color: #ffffff; font-weight: 500;
        }

        /* Modal styles */
        .modal {
            display: none; position: fixed; z-index: 50; inset: 0;
            overflow-y: auto; background-color: rgba(0, 0, 0, 0.7);
            align-items: center; justify-content: center;
        }
        .modal.flex { display: flex; }
        #auth-modal { z-index: 60; }
        #delete-confirm-modal { z-index: 60; }

        /* Modal Image Zoom */
        #modal-image-wrapper { transition: all 0.3s ease; }
        #modal-image {
            transition: transform 0.2s ease-out;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            transform-origin: top left;
        }

        /* Tooltip */
        [data-tooltip] { position: relative; }
        [data-tooltip]:hover::after {
            content: attr(data-tooltip); position: absolute; bottom: 110%;
            left: 50%; transform: translateX(-50%); background-color: #1f2937;
            color: #ffffff; padding: 4px 8px; border-radius: 4px;
            font-size: 12px; white-space: nowrap; z-index: 60;
            opacity: 1; transition: opacity 0.2s;
        }

        /* Chevron rotation */
        .rotate-180 { transform: rotate(180deg); }

        /* Drag over effect */
        .drag-over {
            border-style: dashed; border-color: #4f46e5; background-color: #1f2937;
        }

        /* History Marquee */
        .history-info-container {
            width: 100%; overflow: hidden; white-space: nowrap;
            position: absolute; bottom: 0; left: 0;
            background: rgba(0, 0, 0, 0.7); opacity: 0;
            transition: opacity 0.3s; pointer-events: none;
        }
        .group:hover .history-info-container { opacity: 1; }
        .history-info-text-wrapper {
            display: inline-block; white-space: nowrap;
            animation: marquee 25s linear infinite;
        }
        .history-info-text {
            display: inline-block; padding: 4px 12px;
            color: white; font-size: 10px;
        }
        @keyframes marquee {
            0%   { transform: translateX(0); }
            100% { transform: translateX(-50%); } 
        }

        /* Toast */
        #toast { max-width: 400px; word-break: break-word; }
        
        /* Image Card */
        .image-card {
            position: relative; background-color: #374151; /* gray-700 */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center;
            padding: 0.5rem; /* p-2 */
            text-align: center; overflow: hidden;
        }

        /* ‚òÖ‚òÖ‚òÖ ‰øÆÊ≠£ÁÆáÊâÄ (v13) ‚òÖ‚òÖ‚òÖ */
        /* „Åº„Åã„ÅóÁî®„Éï„Ç£„É´„Çø„Éº */
        .image-blurred {
            filter: blur(16px);
            transition: filter 0.2s ease-in-out;
        }
        /* BG„Éà„Ç∞„É´„Çπ„Ç§„ÉÉ„ÉÅ */
        .toggle-bg:checked + .toggle-label {
            background-color: #16a34a; /* green-600 */
        }
        .toggle-bg:checked + .toggle-label > span { /* afterÊì¨‰ººË¶ÅÁ¥†„ÅÆ‰ª£„Çè„Çä */
            transform: translateX(100%);
            border-color: #ffffff;
        }
        .toggle-label {
            transition: background-color 0.2s ease-in-out;
        }
        .toggle-label > span { /* afterÊì¨‰ººË¶ÅÁ¥†„ÅÆ‰ª£„Çè„Çä */
            transition: transform 0.2s ease-in-out;
        }
        /* ‚òÖ‚òÖ‚òÖ ‰øÆÊ≠£ÁÆáÊâÄ„Åì„Åì„Åæ„Åß ‚òÖ‚òÖ‚òÖ */
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen w-screen flex">

    <!-- (ÁúÅÁï•: v12„Å®Âêå„ÅòSVG„Ç¢„Ç§„Ç≥„É≥) -->
    <svg width="0" height="0" class="hidden">
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-x"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" id="icon-translate"><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-send"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" id="icon-stop"><circle cx="12" cy="12" r="10"></circle><rect x="9" y="9" width="6" height="6"></rect></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-image"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-copy"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-refresh"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-loader"><line x1="12" y1="2" x2="12" y2="6"></line><line x1="12" y1="18" x2="12" y2="22"></line><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line><line x1="2" y1="12" x2="6" y2="12"></line><line x1="18" y1="12" x2="22" y2="12"></line><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" id="icon-chevron-down"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" id="icon-upload"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" id="icon-x-circle"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" id="icon-lock"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" id="icon-zoom-in"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" id="icon-zoom-out"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="8" y1="11" x2="14" y2="11"></line></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" id="icon-zoom-reset"><path d="M3 2v6h6"></path><path d="M21 12A9 9 0 0 0 6 5.3L3 8"></path><path d="M21 22v-6h-6"></path><path d="M3 12a9 9 0 0 0 15 6.7l3-2.7"></path></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" id="icon-maximize"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"></path></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" id="icon-minimize"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" id="icon-eye"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" id="icon-eye-off"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" id="icon-trash"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></symbol>
        <!-- ‚òÖ‚òÖ‚òÖ ËøΩÂä† (v13) ‚òÖ‚òÖ‚òÖ -->
        <symbol xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" id="icon-cloud-lightning">
            <path d="M19 16.9A5 5 0 0 0 18 7h-1.26a8 8 0 1 0-11.62 9"></path><polyline points="13 11 9 17 15 17 11 23"></polyline>
        </symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" id="icon-clock">
            <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
        </symbol>
        <!-- ‚òÖ‚òÖ‚òÖ ËøΩÂä†„Åì„Åì„Åæ„Åß ‚òÖ‚òÖ‚òÖ -->
    </svg>

    <!-- (ÁúÅÁï•: v12„Å®Âêå„Åò„Çµ„Ç§„Éâ„Éê„ÉºHTML) -->
    <aside id="sidebar" class="bg-gray-800 h-screen w-64 p-4 flex flex-col flex-shrink-0 fixed z-30 transition-transform duration-300 ease-in-out -translate-x-full md:translate-x-0">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-xl font-bold text-white">muGen History</h1>
            <button id="close-sidebar" class="md:hidden text-gray-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-x"></use></svg>
            </button>
        </div>
        
        <div id="history-stats" class="mb-4 p-3 bg-gray-700 rounded-lg">
            <div class="flex justify-between text-sm">
                <span class="text-gray-300">Total Images:</span>
                <span id="stats-total-images" class="font-medium text-white">0</span>
            </div>
            <div class="flex justify-between text-sm mt-1">
                <span class="text-gray-300">Est. Cost (USD):</span>
                <span id="stats-cost-usd" class="font-medium text-white">$0.00</span>
            </div>
            <div class="flex justify-between text-sm mt-1">
                <span class="text-gray-300">Est. Cost (JPY):</span>
                <span id="stats-cost-jpy" class="font-medium text-white">¬•0</span>
            </div>
        </div>

        <div class="mt-4 pt-4 border-t border-gray-700">
            <button id="clear-history-button" class="w-full flex items-center justify-center gap-2 bg-red-800/50 hover:bg-red-700 text-red-200 py-2 px-4 rounded-lg transition" data-tooltip="Clear local history (requires password)">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-trash"></use></svg>
                <span>Clear History</span>
            </button>
        </div>

        <div id="history-container" class="flex-1 overflow-y-auto sidebar-scroll space-y-2 mt-4">
            <p class="text-gray-400 text-sm">No generated images yet.</p>
        </div>
    </aside>

    <main id="main-content" class="flex-1 flex flex-col transition-all duration-300 ease-in-out md:ml-64 min-h-screen">
        
        <!-- (ÁúÅÁï•: v12„Å®Âêå„Åò„Éò„ÉÉ„ÉÄ„ÉºHTML) -->
        <header class="flex-shrink-0 bg-gray-900/70 backdrop-blur-sm h-16 flex items-center px-6 shadow-md z-20">
            <button id="sidebar-toggle-button" class="text-gray-400 hover:text-white mr-4" data-tooltip="Toggle History">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-menu"></use></svg>
            </button>
            <div class="flex items-center space-x-2">
                <svg class="w-6 h-6 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-image"></use></svg>
                <span class="text-lg font-semibold text-white">muGen Image Generator</span>
            </div>
            <div class="flex space-x-2 ml-4">
                <div class="w-3 h-3 rounded-full bg-gray-700"></div>
                <div class="w-3 h-3 rounded-full bg-gray-700"></div>
                <div class="w-3 h-3 rounded-full bg-gray-700"></div>
            </div>
        </header>

        <!-- (ÁúÅÁï•: v12„Å®Âêå„ÅòÁîªÂÉè„Ç≥„É≥„ÉÜ„ÉäHTML) -->
        <div id="image-container" class="flex-1 flex items-center justify-center p-4 md:p-8 relative overflow-hidden">
            <div id="image-display" class="w-full h-full flex items-center justify-center bg-gray-800 rounded-lg shadow-inner relative border-2 border-transparent transition-all overflow-auto p-4"> 
                <div id="image-grid-container" class="w-full h-full grid gap-4">
                    <!-- (ÁîªÂÉè„Ç´„Éº„Éâ„ÅØJS„Å´„Çà„Å£„Å¶„Åì„Åì„Å´ËøΩÂä†„Åï„Çå„Åæ„Åô) -->
                </div>
        
                <div id="placeholder" class="text-gray-500 flex-col items-center justify-center p-8 text-center absolute inset-0 flex"> 
                    <svg class="w-24 h-24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-image"></use></svg>
                    <p class="mt-2">Your generated image(s) will appear here</p>
                    <p class="text-sm mt-4">or</p>
                    <button id="upload-image-button" type="button" class="mt-4 flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-lg transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-upload"></use></svg>
                        Upload Image to Edit
                    </button>
                    <input type="file" id="upload-image-input" class="hidden" accept="image/png, image/jpeg, image/webp">
                    <p class="text-xs text-gray-600 mt-2">You can also drag & drop an image here</p>
                </div>

                <div id="loading-animation" class="noise-container">
                    <div class="absolute inset-0 flex items-center justify-center">
                        <svg class="w-12 h-12 text-indigo-400 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-loader"></use></svg>
                    </div>
                </div>
            </div>
        </div>

        <footer id="prompt-footer" class="p-4 md:p-6 bg-gray-800/50 backdrop-blur-sm z-10 fixed bottom-0 w-full md:left-64 transition-all duration-300 ease-in-out">
            <form id="generation-form" class="max-w-4xl mx-auto">
                
                <div class="flex flex-wrap gap-4 mb-4" id="options-toolbar">
                    
                    <!-- (ÁúÅÁï•: v12„Å®Âêå„Åò„É¢„Éá„É´ÈÅ∏Êäû) -->
                    <div id="model-select-group" class="w-full md:w-auto relative">
                        <button type="button" id="models-toggle" class="flex justify-between items-center w-full p-2.5 rounded-lg bg-gray-700 border border-gray-600 hover:bg-gray-600 transition">
                            <label class="block text-sm font-medium text-white cursor-pointer">Models (Multiple)</label>
                            <svg id="models-chevron" class="w-5 h-5 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <use href="#icon-chevron-down"></use>
                            </svg>
                        </button>
                        <div id="models-container" class="hidden max-h-48 overflow-y-auto flex flex-col gap-1 p-2 bg-gray-900/80 backdrop-blur-sm border border-gray-700 rounded-lg mt-1">
                            <!-- JS„ÅßÊåøÂÖ• -->
                        </div>
                    </div>
                    
                    <!-- (ÁúÅÁï•: v12„Å®Âêå„Åò„Ç¢„Çπ„Éö„ÇØ„ÉàÊØî) -->
                    <div id="aspect-ratio-group">
                        <label for="aspect-ratio-select" class="block text-sm font-medium text-gray-300 mb-1">Aspect Ratio</label>
                        <select id="aspect-ratio-select" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5">
                            <option value="1:1">1:1 Square</option>
                            <option value="16:9">16:9 Landscape</option>
                            <option value="9:16">9:16 Portrait</option>
                            <option value="4:3">4:3 Standard</option>
                            <option value="3:2">3:2 Photo</option>
                        </select>
                    </div>
                    
                    <!-- ‚òÖ‚òÖ‚òÖ Â§âÊõ¥ (v13): „É©„Éô„É´Â§âÊõ¥ ‚òÖ‚òÖ‚òÖ -->
                    <div id="auto-retry-group">
                        <label for="auto-retry-select" class="block text-sm font-medium text-gray-300 mb-1">Auto Retry (FG)</label>
                        <select id="auto-retry-select" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5">
                            <option value="0">Off</option>
                            <option value="5">5 Times</option>
                            <option value="10">10 Times</option>
                            <option value="50">50 Times</option>
                            <option value="-1">Custom...</option>
                        </select>
                    </div>
                    
                    <div id="edit-with-flash-group" class="flex items-end gap-2">
                        <!-- (ÁúÅÁï•: v12„Å®Âêå„Åò Edit„Éú„Çø„É≥) -->
                        <button type="button" id="edit-with-flash-button" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-2.5 px-4 rounded-lg transition flex items-center gap-2" data-tooltip="Switch to Edit Mode with Gemini 2.5 Flash">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-edit"></use></svg>
                            Edit with 2.5 flash
                        </button>
                        <button type="button" id="edit-with-flash-2-0-button" class="bg-cyan-600 hover:bg-cyan-700 text-white text-sm font-medium py-2.5 px-4 rounded-lg transition flex items-center gap-2" data-tooltip="Switch to Edit Mode with Gemini 2.0 Flash">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-edit"></use></svg>
                            Edit with 2.0 flash
                        </button>
                        
                        <!-- (ÁúÅÁï•: v12„Å®Âêå„Åò Private Mode) -->
                        <div id="private-mode-group" class="flex items-end">
                            <div class="relative flex items-center gap-2 bg-gray-700 border border-gray-600 text-white text-sm rounded-lg p-2.5 h-full">
                                <input id="private-mode-toggle" type="checkbox" class="w-5 h-5 text-indigo-600 bg-gray-800 border-gray-600 rounded focus:ring-indigo-500">
                                <label for="private-mode-toggle" class="cursor-pointer font-medium" data-tooltip="Blur images upon generation">
                                    Private Mode
                                </label>
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-eye-off"></use></svg>
                            </div>
                        </div>
                        
                        <!-- ‚òÖ‚òÖ‚òÖ ËøΩÂä† (v13): BG„Éà„Ç∞„É´„Çπ„Ç§„ÉÉ„ÉÅ ‚òÖ‚òÖ‚òÖ -->
                        <div id="bg-mode-group" class="flex items-end">
                            <div class="relative flex items-center gap-2 bg-gray-700 border border-gray-600 text-white text-sm rounded-lg p-2.5 h-full">
                                <input id="bg-mode-toggle" type="checkbox" class="hidden toggle-bg">
                                <label for="bg-mode-toggle" class="relative inline-flex items-center cursor-pointer">
                                    <span class="w-10 h-5 bg-gray-600 rounded-full shadow-inner toggle-label">
                                        <span class="absolute left-0 w-5 h-5 bg-white border border-gray-300 rounded-full shadow-md transform" style="top: 0; left: 0;"></span>
                                    </span>
                                </label>
                                <label for="bg-mode-toggle" class="ml-2 cursor-pointer font-medium" data-tooltip="Background Mode (Page close OK)">
                                    BG Mode
                                </label>
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-cloud-lightning"></use></svg>
                            </div>
                        </div>
                        <!-- ‚òÖ‚òÖ‚òÖ ËøΩÂä†„Åì„Åì„Åæ„Åß ‚òÖ‚òÖ‚òÖ -->
                    </div>
                </div>

                <!-- (ÁúÅÁï•: v12„Å®Âêå„Åò Styles) -->
                <div class="mb-4">
                    <button type="button" id="styles-toggle" class="flex justify-between items-center w-full p-2 rounded-lg hover:bg-gray-700 transition">
                        <label class="block text-sm font-medium text-gray-300 cursor-pointer">Styles (Optional, multiple)</label>
                        <svg id="styles-chevron" class="w-5 h-5 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <use href="#icon-chevron-down"></use>
                        </svg>
                    </button>
                    <div id="selected-styles-preview" class="hidden flex-wrap gap-2 p-2 bg-gray-900/50 rounded-lg mt-2 cursor-pointer" data-tooltip="Click to edit styles">
                        <!-- Selected styles will be shown here -->
                    </div>
                    <div id="styles-container" class="hidden max-h-48 overflow-y-auto flex flex-wrap gap-2 p-3 bg-gray-700/50 rounded-lg mt-2">
                        <!-- JS„ÅßÊåøÂÖ• -->
                    </div>
                </div>

                <!-- (ÁúÅÁï•: v12„Å®Âêå„Åò Prompt Suggestions) -->
                <div id="prompt-suggestions-container" class="hidden mb-4 p-3 bg-gray-700/50 rounded-lg max-h-48 overflow-y-auto">
                    <p class="text-sm text-gray-300 mb-2">Multiple prompt suggestions found. Select desired prompts:</p>
                    <div id="prompt-suggestions-list" class="space-y-2">
                        <!-- ÁøªË®≥ÂÄôË£ú„ÅåJS„Å´„Çà„Å£„Å¶„Åì„Åì„Å´ËøΩÂä†„Åï„Çå„Åæ„Åô -->
                    </div>
                    <button type="button" id="apply-suggestions-button" class="mt-3 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium py-2 px-4 rounded-lg transition">
                        Set Selected Prompts
                    </button>
                </div>

                <!-- (ÁúÅÁï•: v12„Å®Âêå„Åò Edit Mode Indicator) -->
                <div id="edit-mode-indicator" class="hidden text-center text-indigo-300 text-sm font-medium p-2 bg-indigo-900/50 rounded-lg mt-3">
                    üé® Editing Mode - Subsequent generations will edit the current image. (Change model to Imagen 3.0 to exit)
                </div>

                <!-- (ÁúÅÁï•: v12„Å®Âêå„Åò Prompt Input) -->
                <div class="relative mt-4">
                    <textarea id="prompt-input" rows="2" class="block w-full p-4 pr-56 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:ring-indigo-500 focus:border-indigo-500 resize-none" placeholder="Enter your prompt... (Non-English will be translated)"></textarea>
                    
                    <div class="absolute bottom-3 right-44 flex space-x-2">
                         <button id="prompt-toggle-size-button" type="button" class="p-2 bg-gray-600 text-gray-400 rounded-lg hover:bg-gray-500 hover:text-gray-200 transition" data-tooltip="Toggle Size">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-maximize"></use></svg>
                        </button>
                         <button id="prompt-copy-button" type="button" class="p-2 bg-gray-600 text-gray-400 rounded-lg hover:bg-gray-500 hover:text-gray-200 transition" data-tooltip="Copy Prompt">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-copy"></use></svg>
                        </button>
                         <button id="prompt-clear-button" type="button" class="p-2 bg-gray-600 text-gray-400 rounded-lg hover:bg-gray-500 hover:text-gray-200 transition" data-tooltip="Clear Input">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-x-circle"></use></svg>
                        </button>
                    </div>

                    <div class="absolute bottom-3 right-3 flex space-x-2">
                        <button id="translate-button" type="button" class="p-2 bg-gray-600 text-gray-300 rounded-lg hover:bg-gray-500 transition" data-tooltip="Translate to English">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-translate"></use></svg>
                        </button>
                        <button id="generate-button" type="submit" class="p-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition" data-tooltip="Generate">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-send"></use></svg>
                        </button>
                    </div>
                </div>
            </form>
        </footer>
    </main>

    <!-- (ÁúÅÁï•: v12„Å®Âêå„Åò Image Modal) -->
    <div id="image-modal" class="modal">
        <div class="bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-6xl max-h-[95vh] flex flex-col p-4">
            <div id="modal-image-wrapper" class="flex-1 flex items-center justify-center overflow-auto bg-gray-900/50 rounded-lg min-h-[50vh] mb-4">
                <img id="modal-image" src="" class="max-w-full max-h-full object-contain">
            </div>
            <div class="bg-gray-900 rounded-b-lg p-4">
                <p class="text-sm text-gray-300 mb-2">Prompt:</p>
                <p id="modal-prompt" class="text-white bg-gray-700 p-3 rounded-lg max-h-24 overflow-y-auto"></p>
                <div class="flex flex-wrap gap-4 mt-4">
                    <button id="modal-copy" class="flex items-center space-x-2 bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-lg transition" data-tooltip="Copy Prompt">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-copy"></use></svg>
                        <span>Copy</span>
                    </button>
                    <button id="modal-regenerate" class="flex items-center space-x-2 bg-gray-600 hover:bg-gray-500 text-white py-2 px-4 rounded-lg transition" data-tooltip="Regenerate Image">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-refresh"></use></svg>
                        <span>Regenerate</span>
                    </button>
                    <button id="modal-edit" class="flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition" data-tooltip="Load this image for editing">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-edit"></use></svg>
                        <span>Edit</span>
                    </button>
                    <div class="flex items-center gap-2 ml-auto">
                        <button id="modal-zoom-out" class="flex items-center space-x-2 bg-gray-700 hover:bg-gray-600 text-white p-2.5 rounded-lg transition" data-tooltip="Zoom Out">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-zoom-out"></use></svg>
                        </button>
                        <button id="modal-zoom-in" class="flex items-center space-x-2 bg-gray-700 hover:bg-gray-600 text-white p-2.5 rounded-lg transition" data-tooltip="Zoom In">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-zoom-in"></use></svg>
                        </button>
                        <button id="modal-zoom-reset" class="flex items-center space-x-2 bg-gray-700 hover:bg-gray-600 text-white p-2.5 rounded-lg transition" data-tooltip="Reset Zoom">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-zoom-reset"></use></svg>
                        </button>
                    </div>
                </div>
            </div>
            <button id="modal-close" class="absolute top-4 right-4 text-gray-400 hover:text-white bg-gray-800/50 rounded-full p-1">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-x"></use></svg>
            </button>
        </div>
    </div>

    <!-- (ÁúÅÁï•: v12„Å®Âêå„Åò Toast) -->
    <div id="toast" class="fixed top-20 right-6 text-white py-3 px-4 rounded-lg shadow-lg transition-all duration-300 opacity-0 -translate-y-10 z-50">
        <div class="flex items-start justify-between">
            <p id="toast-message" class="flex-1 pr-4">Message</p>
            <div class="flex flex-col space-y-1">
                <button id="toast-close" class="text-white hover:text-gray-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-x"></use></svg>
                </button>
                <button id="toast-copy" class="hidden text-white hover:text-gray-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-copy"></use></svg>
                </button>
            </div>
        </div>
    </div>
    
    <!-- (ÁúÅÁï•: v12„Å®Âêå„Åò Auth Modal) -->
    <div id="auth-modal" class="modal flex">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6">
            <div class="flex items-center justify-center mb-4">
                <svg class="w-8 h-8 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-lock"></use></svg>
                <h2 class="text-xl font-bold text-white ml-2">Authentication Required</h2>
            </div>
            <p class="text-gray-400 text-center text-sm mb-4">Please enter the password to access muGen.</p>
            <form id="auth-form">
                <input type="password" id="auth-password" class="block w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Password" required>
                <p id="auth-error" class="text-red-400 text-sm mt-2 hidden"></p>
                <button id="auth-submit" type="submit" class="w-full mt-4 p-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-medium">
                    Login
                </button>
            </form>
        </div>
    </div>

    <!-- (ÁúÅÁï•: v12„Å®Âêå„Åò Delete Confirm Modal) -->
    <div id="delete-confirm-modal" class="modal"> 
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6">
            <div class="flex items-center justify-center mb-4">
                <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-trash"></use></svg>
                <h2 class="text-xl font-bold text-white ml-2">Clear History?</h2>
            </div>
            <p class="text-gray-400 text-center text-sm mb-4">This action is irreversible. Please enter your password to confirm deletion of all local history.</p>
            <form id="delete-confirm-form">
                <input type="password" id="delete-confirm-password" class="block w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Password" required>
                <p id="delete-confirm-error" class="text-red-400 text-sm mt-2 hidden"></p>
                <div class="flex gap-4 mt-4">
                     <button id="cancel-delete-button" type="button" class="w-full p-3 bg-gray-600 text-white rounded-lg hover:bg-gray-500 transition font-medium">
                        Cancel
                    </button>
                    <button id="confirm-delete-button" type="submit" class="w-full p-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-medium">
                        Delete
                    </button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // --- CONSTANTS & STATE (v13) ---
        const STYLES = [
            "Photorealistic", "Cinematic", "35mm film", "Black and white", "Impressionistic",
            "Surrealism", "Watercolour", "Ukiyo-e", "Cyberpunk", "Steampunk",
            "Fantasy art", "Minimalism", "Animation", "Ghibli-style", "Disney-style"
        ];
        const CUSTOM_STYLES_KEY = 'muGenCustomStyles';
        const MODELS = {
            // Imagen
            "imagen-4.0-ultra-generate-preview-06-06": { name: "Imagen 4.0 Ultra", type: "imagen" },
            "imagen-4.0-generate-preview-06-06": { name: "Imagen 4.0", type: "imagen" },
            "imagen-4.0-fast-generate-001": { name: "Imagen 4.0 Fast", type: "imagen" },
            "imagen-3.0-generate": { name: "Imagen 3.0", type: "imagen" },
            // Gemini (Edit)
            "gemini-2.5-flash-image-preview": { name: "Gemini 2.5 Flash Image", type: "gemini-edit" },
            "gemini-2.0-flash-preview-image-generation": { name: "Gemini 2.0 Flash Image", type: "gemini-edit" }
        };
        const PRICE_IMAGEN_USD = 0.02;
        const PRICE_GEMINI_FLASH_IMAGE_USD = 0.002;
        const PRICE_GEMINI_FLASH_IMAGE_2_0_USD = 0.002;
        const USD_JPY_RATE = 150; // ‰ªÆ„ÅÆÁÇ∫Êõø„É¨„Éº„Éà

        let db;
        let apiKeyCounter = 0; 
        let currentEditImageBase64 = null; 
        let isEditingMode = false;
        let lastEnterPress = 0; 
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        // ‚òÖ‚òÖ‚òÖ Â§âÊõ¥ (v13) ‚òÖ‚òÖ‚òÖ
        // FG („Éï„Ç©„Ç¢„Ç∞„É©„Ç¶„É≥„Éâ) Áî®„ÅÆÂ§âÊï∞
        let generationInProgress_FG = false; 
        let runningGenerations_FG = new Set(); 
        let currentFetchController_FG = null;
        
        // BG („Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ) Áî®„ÅÆ„Éù„Éº„É™„É≥„Ç∞Â§âÊï∞
        let isPolling_BG = false;
        let pollingIntervalId_BG = null;
        // ‚òÖ Â§âÊõ¥: Ë§áÊï∞„ÅÆBG„Ç∏„Éß„Éñ„ÇíÂêåÊôÇ„Å´„Éù„Éº„É™„É≥„Ç∞„Åß„Åç„Çã„Çà„ÅÜ„Å´Set„ÅßÁÆ°ÁêÜ
        let pollingJobs_BG = new Set(); // { jobId, cardId, modelName } „ÇíÊ†ºÁ¥ç
        
        const POLLING_INTERVAL = 5000; // 5Áßí
        // ‚òÖ‚òÖ‚òÖ Â§âÊõ¥„Åì„Åì„Åæ„Åß ‚òÖ‚òÖ‚òÖ
        
        let toastTimeoutId = null;
        let touchStartX = 0, touchStartY = 0, touchMoveX = 0;
        let modalZoomLevel = 1.0;
        const MAX_ZOOM = 10, MIN_ZOOM = 0.5;


        // --- DOM ELEMENTS (v13) ---
        // (ÁúÅÁï•: v12„Å®Âêå„ÅòË¶ÅÁ¥†)
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('main-content');
        const sidebarToggleButton = document.getElementById('sidebar-toggle-button');
        const closeSidebarBtn = document.getElementById('close-sidebar');
        const imageContainer = document.getElementById('image-container');
        const promptFooter = document.getElementById('prompt-footer');
        const generationForm = document.getElementById('generation-form');
        const promptInput = document.getElementById('prompt-input');
        const translateButton = document.getElementById('translate-button');
        const generateButton = document.getElementById('generate-button');
        const promptCopyButton = document.getElementById('prompt-copy-button');
        const promptClearButton = document.getElementById('prompt-clear-button');
        const promptToggleSizeButton = document.getElementById('prompt-toggle-size-button');
        const promptSuggestionsContainer = document.getElementById('prompt-suggestions-container');
        const promptSuggestionsList = document.getElementById('prompt-suggestions-list');
        const applySuggestionsButton = document.getElementById('apply-suggestions-button');
        const loadingAnimation = document.getElementById('loading-animation');
        const imageDisplay = document.getElementById('image-display');
        const imageGridContainer = document.getElementById('image-grid-container');
        const placeholder = document.getElementById('placeholder');
        const historyContainer = document.getElementById('history-container');
        const modelsToggleBtn = document.getElementById('models-toggle');
        const modelsContainer = document.getElementById('models-container');
        const modelsChevron = document.getElementById('models-chevron');
        const aspectRatioSelect = document.getElementById('aspect-ratio-select');
        const autoRetrySelect = document.getElementById('auto-retry-select');
        const imageModal = document.getElementById('image-modal');
        const modalImage = document.getElementById('modal-image');
        const modalPrompt = document.getElementById('modal-prompt');
        const modalCopy = document.getElementById('modal-copy');
        const modalRegenerate = document.getElementById('modal-regenerate');
        const modalClose = document.getElementById('modal-close');
        const modalEdit = document.getElementById('modal-edit');
        const modalImageWrapper = document.getElementById('modal-image-wrapper');
        const modalZoomIn = document.getElementById('modal-zoom-in');
        const modalZoomOut = document.getElementById('modal-zoom-out');
        const modalZoomReset = document.getElementById('modal-zoom-reset');
        const optionsToolbar = document.getElementById('options-toolbar');
        const modelSelectGroup = document.getElementById('model-select-group');
        const aspectRatioGroup = document.getElementById('aspect-ratio-group');
        const autoRetryGroup = document.getElementById('auto-retry-group');
        const editWithFlashButton = document.getElementById('edit-with-flash-button');
        const editWithFlash20Button = document.getElementById('edit-with-flash-2-0-button');
        const stylesToggleBtn = document.getElementById('styles-toggle');
        const stylesContainer = document.getElementById('styles-container');
        const stylesChevron = document.getElementById('styles-chevron');
        const selectedStylesPreview = document.getElementById('selected-styles-preview');
        const statsTotalImages = document.getElementById('stats-total-images');
        const statsCostUsd = document.getElementById('stats-cost-usd');
        const statsCostJpy = document.getElementById('stats-cost-jpy');
        const uploadImageButton = document.getElementById('upload-image-button');
        const uploadImageInput = document.getElementById('upload-image-input');
        const editModeIndicator = document.getElementById('edit-mode-indicator');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        const toastClose = document.getElementById('toast-close');
        const toastCopy = document.getElementById('toast-copy');
        const authModal = document.getElementById('auth-modal');
        const authForm = document.getElementById('auth-form');
        const authPassword = document.getElementById('auth-password');
        const authSubmit = document.getElementById('auth-submit');
        const authError = document.getElementById('auth-error');
        const clearHistoryButton = document.getElementById('clear-history-button');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const deleteConfirmForm = document.getElementById('delete-confirm-form');
        const deleteConfirmPassword = document.getElementById('delete-confirm-password');
        const deleteConfirmError = document.getElementById('delete-confirm-error');
        const confirmDeleteButton = document.getElementById('confirm-delete-button');
        const cancelDeleteButton = document.getElementById('cancel-delete-button');
        
        // ‚òÖ‚òÖ‚òÖ ËøΩÂä† (v13) ‚òÖ‚òÖ‚òÖ
        const bgModeToggle = document.getElementById('bg-mode-toggle');
        // ‚òÖ‚òÖ‚òÖ ËøΩÂä†„Åì„Åì„Åæ„Åß ‚òÖ‚òÖ‚òÖ


        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth(); 
            initDB();
            initSidebar();
            initStyles();
            initModels();
            initListeners(); // ‚òÖ Â§âÊõ¥„ÅÇ„Çä
            loadHistory();
            adjustMainContentPadding();
            updatePlaceholderVisibility();
            updateSelectedStylesPreview(false);
            
            // ‚òÖ v13: ÂàùÊúüUIÁä∂ÊÖã„ÇíË®≠ÂÆö
            handleBGModeToggle(); 
        });

        // --- ‚òÖ v13: AUTHENTICATION ---
        // (ÁúÅÁï•: v12„Å®Âêå„Åò checkAuth, handleAuthSubmit Èñ¢Êï∞)
        function checkAuth() {
            if (sessionStorage.getItem('muGenAuthenticated') === 'true') {
                authModal.classList.remove('flex');
            } else {
                authModal.classList.add('flex');
            }
        }
        async function handleAuthSubmit(event) {
            event.preventDefault();
            const password = authPassword.value;
            if (!password) return;
            setLoading(authSubmit, true);
            authError.classList.add('hidden');
            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'auth', password: password })
                });
                if (response.ok) {
                    sessionStorage.setItem('muGenAuthenticated', 'true');
                    authModal.classList.remove('flex');
                    showToast("Authentication successful!", "success");
                } else {
                    const data = await response.json();
                    throw new Error(data.error || "Authentication failed");
                }
            } catch (error) {
                console.error("Auth error:", error);
                authError.textContent = error.message;
                authError.classList.remove('hidden');
                showToast(error.message, "error");
            } finally {
                setLoading(authSubmit, false);
            }
        }


        // --- ‚òÖ v13: CUSTOM STYLE FUNCTIONS ---
        // (ÁúÅÁï•: v12„Å®Âêå„Åò getCustomStyles, saveCustomStyles, handleAddCustomStyle, handleRemoveCustomStyle Èñ¢Êï∞)
        function getCustomStyles() {
            try {
                const styles = localStorage.getItem(CUSTOM_STYLES_KEY);
                return styles ? JSON.parse(styles) : [];
            } catch (e) { console.error("Failed to parse custom styles:", e); return []; }
        }
        function saveCustomStyles(stylesArray) {
            try {
                localStorage.setItem(CUSTOM_STYLES_KEY, JSON.stringify(stylesArray));
            } catch (e) { console.error("Failed to save custom styles:", e); showToast("Failed to save custom style", "error"); }
        }
        function handleAddCustomStyle() {
            const newStyle = prompt("Enter new style name (e.g., 'Pixel art', 'Anime'):");
            if (newStyle && newStyle.trim().length > 0) {
                const trimmedStyle = newStyle.trim();
                const customStyles = getCustomStyles();
                const allStyles = [...STYLES, ...customStyles];
                if (allStyles.map(s => s.toLowerCase()).includes(trimmedStyle.toLowerCase())) {
                    showToast(`Style "${trimmedStyle}" already exists.`, "warning"); return;
                }
                customStyles.push(trimmedStyle);
                saveCustomStyles(customStyles);
                initStyles();
                showToast(`Style "${trimmedStyle}" added.`, "success");
            }
        }
        function handleRemoveCustomStyle(styleToRemove) {
            let customStyles = getCustomStyles();
            customStyles = customStyles.filter(s => s !== styleToRemove);
            saveCustomStyles(customStyles);
            initStyles();
            showToast(`Style "${styleToRemove}" removed.`, "success");
        }


        // --- ‚òÖ v13: IndexedDB functions ---
        // (ÁúÅÁï•: v12„Å®Âêå„Åò initDB, saveImageToDB, loadHistory, clearOldHistory, handleClearHistory Èñ¢Êï∞)
        function initDB() {
            const request = indexedDB.open("muGenDB", 1);
            request.onerror = (event) => { console.error("IndexedDB error:", event.target.errorCode); showToast("Database error. History may not work.", "error"); };
            request.onupgradeneeded = (event) => {
                db = event.target.result;
                const objectStore = db.createObjectStore("images", { keyPath: "id", autoIncrement: true });
                objectStore.createIndex("timestamp", "timestamp", { unique: false });
                objectStore.createIndex("prompt", "prompt", { unique: false });
                objectStore.createIndex("model", "model", { unique: false });
                objectStore.createIndex("aspectRatio", "aspectRatio", { unique: false });
                objectStore.createIndex("styles", "styles", { unique: false });
            };
            request.onsuccess = (event) => { db = event.target.result; console.log("IndexedDB initialized."); };
        }
        function saveImageToDB(prompt, translatedPrompt, base64Data, model, aspectRatio, styles) {
            if (!db) return;
            const transaction = db.transaction(["images"], "readwrite");
            const objectStore = transaction.objectStore("images");
            const newItem = {
                prompt: prompt, translatedPrompt: translatedPrompt, base64: base64Data,
                timestamp: new Date().getTime(), model: model, aspectRatio: aspectRatio, styles: styles
            };
            const request = objectStore.add(newItem);
            request.onsuccess = () => { console.log("Image saved to DB"); loadHistory(); };
            request.onerror = (event) => {
                console.error("Error saving to DB:", event.target.error);
                if (event.target.error.name === 'QuotaExceededError') {
                    showToast("History storage is full. Clearing old entries...", "warning");
                    clearOldHistory();
                }
            };
        }
        function loadHistory() {
            if (!db) return;
            const transaction = db.transaction(["images"], "readonly");
            const objectStore = transaction.objectStore("images");
            const index = objectStore.index("timestamp");
            const request = index.getAll(null, 500);
            request.onsuccess = () => {
                const items = request.result.reverse();
                historyContainer.innerHTML = "";
                let totalCostUSD = 0;
                if (items.length === 0) {
                    historyContainer.innerHTML = '<p class="text-gray-400 text-sm">No generated images yet.</p>';
                } else {
                    items.forEach(item => {
                        const div = document.createElement('div');
                        div.className = "cursor-pointer rounded-lg overflow-hidden relative group";
                        let infoParts = [
                            `[P] ${item.prompt || ''}`, `[M] ${item.model || 'unknown'}`, `[A] ${item.aspectRatio || 'N/A'}`
                        ];
                        if (item.styles && item.styles.length > 0) { infoParts.push(`[S] ${item.styles.join(', ')}`); }
                        const infoText = infoParts.join(' &nbsp;&nbsp;|&nbsp;&nbsp; ');
                        div.innerHTML = `
                            <img src="${item.base64}" alt="History thumbnail" class="w-full h-auto object-cover">
                            <div class="absolute inset-0 bg-black/70 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center p-2">
                                <button class="text-xs bg-blue-600 hover:bg-blue-700 text-white py-1 px-2 rounded" data-base64="${item.base64.split(',')[1]}" data-prompt="${escapeHTML(item.prompt)}">
                                    Edit
                                </button>
                            </div>
                            <div class="history-info-container">
                                <div class="history-info-text-wrapper">
                                    <span class="history-info-text">${infoText}</span>
                                    <span class="history-info-text">${infoText}</span> </div>
                            </div>
                        `;
                        div.querySelector('img').addEventListener('click', () => showImageInModal(item.base64, item.prompt, item.translatedPrompt, item.base64.split(',')[1]));
                        div.querySelector('button').addEventListener('click', (e) => {
                            e.stopPropagation();
                            const base64 = e.currentTarget.dataset.base64;
                            const prompt = e.currentTarget.dataset.prompt;
                            loadUploadedImage(`data:image/png;base64,${base64}`, prompt, false);
                            toggleEditMode(true, ['gemini-2.5-flash-image-preview']);
                        });
                        historyContainer.appendChild(div);

                        if (item.model === 'imagen-3.0-generate' || 
                            item.model === 'imagen-4.0-generate-preview-06-06' || 
                            item.model === 'imagen-4.0-ultra-generate-preview-06-06' ||
                            item.model === 'imagen-4.0-fast-generate-001') {
                            totalCostUSD += PRICE_IMAGEN_USD;
                        } else if (item.model === 'gemini-2.5-flash-image-preview') {
                            totalCostUSD += PRICE_GEMINI_FLASH_IMAGE_USD;
                        } else if (item.model === 'gemini-2.0-flash-preview-image-generation') { 
                            totalCostUSD += PRICE_GEMINI_FLASH_IMAGE_2_0_USD;
                        } else {
                            totalCostUSD += PRICE_IMAGEN_USD; // „Éá„Éï„Ç©„É´„Éà
                        }
                    });
                }
                statsTotalImages.textContent = items.length;
                statsCostUsd.textContent = `$${totalCostUSD.toFixed(3)}`;
                statsCostJpy.textContent = `¬•${Math.round(totalCostUSD * USD_JPY_RATE)}`;
            };
        }
        function clearOldHistory() {
            if (!db) return;
            db.transaction(["images"], "readwrite").objectStore("images").clear().onsuccess = () => {
                showToast("History storage was full. All history cleared.", "warning");
                loadHistory();
            };
        }
        async function handleClearHistory(event) {
            event.preventDefault();
            const password = deleteConfirmPassword.value;
            if (!password) {
                deleteConfirmError.textContent = "Password is required.";
                deleteConfirmError.classList.remove('hidden');
                return;
            }
            setLoading(confirmDeleteButton, true);
            deleteConfirmError.classList.add('hidden');
            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'auth', password: password })
                });
                if (response.ok) {
                    if (!db) { throw new Error("Database not initialized."); }
                    const request = db.transaction(["images"], "readwrite").objectStore("images").clear();
                    request.onsuccess = () => {
                        showToast("History cleared successfully!", "success");
                        loadHistory();
                        deleteConfirmModal.classList.remove('flex');
                    };
                    request.onerror = (e) => { throw new Error("Failed to clear database: " + e.target.error); };
                } else {
                    const data = await response.json();
                    throw new Error(data.error || "Authentication failed");
                }
            } catch (error) {
                console.error("History clear error:", error);
                deleteConfirmError.textContent = error.message;
                deleteConfirmError.classList.remove('hidden');
            } finally {
                setLoading(confirmDeleteButton, false);
            }
        }

        // --- ‚òÖ v13: UI INITIALIZATION ---
        // (ÁúÅÁï•: v12„Å®Âêå„Åò initSidebar, toggleSidebar Èñ¢Êï∞)
        function initSidebar() {
            sidebarToggleButton.addEventListener('click', toggleSidebar);
            closeSidebarBtn.addEventListener('click', () => toggleSidebar(false));
        }
        function toggleSidebar(forceOpen) {
            const isSidebarOpen = !sidebar.classList.contains('-translate-x-full');
            let shouldBeOpen;
            if (forceOpen === true) { shouldBeOpen = true; }
            else if (forceOpen === false) { shouldBeOpen = false; }
            else { shouldBeOpen = !isSidebarOpen; }
            if (!shouldBeOpen) {
                sidebar.classList.add('-translate-x-full');
                sidebar.classList.remove('md:translate-x-0');
                mainContent.classList.remove('md:ml-64');
                promptFooter.classList.remove('md:left-64'); 
            } else {
                sidebar.classList.remove('-translate-x-full');
                sidebar.classList.add('md:translate-x-0');
                mainContent.classList.add('md:ml-64');
                promptFooter.classList.add('md:left-64'); 
            }
        }
        
        // (ÁúÅÁï•: v12„Å®Âêå„Åò initStyles Èñ¢Êï∞)
        function initStyles() {
            const container = document.getElementById('styles-container');
            container.innerHTML = ""; 
            const allStyles = [...STYLES, ...getCustomStyles()];
            allStyles.forEach(style => {
                const isCustom = !STYLES.includes(style);
                const div = document.createElement('div');
                div.className = "flex items-center gap-1"; 
                const inputId = `style-${style.replace(/[^a-zA-Z0-9]/g, '-')}`;
                let labelClass = "cursor-pointer bg-gray-700 text-gray-300 border border-gray-600 rounded-full px-4 py-2 text-sm font-medium hover:bg-gray-600 transition";
                if (isCustom) {
                     labelClass = "cursor-pointer bg-teal-800 text-teal-100 border border-teal-600 rounded-l-full px-4 py-2 text-sm font-medium hover:bg-teal-700 transition";
                }
                div.innerHTML = `
                    <input type="checkbox" id="${inputId}" value="${style}" class="hidden style-checkbox">
                    <label for="${inputId}" class="${labelClass}">${escapeHTML(style)}</label>
                `;
                if (isCustom) {
                    const removeBtn = document.createElement('button');
                    removeBtn.type = "button";
                    removeBtn.className = "bg-teal-800 text-teal-200 border border-teal-600 border-l-0 rounded-r-full py-2 px-2 text-sm font-medium hover:bg-red-700 hover:text-white transition";
                    removeBtn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-x"></use></svg>`;
                    removeBtn.dataset.tooltip = "Remove style";
                    removeBtn.onclick = (e) => { e.stopPropagation(); handleRemoveCustomStyle(style); };
                    div.appendChild(removeBtn);
                }
                div.querySelector('input[type="checkbox"]').addEventListener('change', () => {
                    if (!stylesContainer.classList.contains('hidden')) {
                         updateSelectedStylesPreview(false);
                    } else {
                         updateSelectedStylesPreview(true);
                    }
                });
                container.appendChild(div);
            });
            const addBtnContainer = document.createElement('div');
            addBtnContainer.innerHTML = `
                <button type="button" id="add-style-button" class="cursor-pointer bg-gray-600 text-gray-300 border border-gray-500 rounded-full px-4 py-2 text-sm font-medium hover:bg-indigo-600 hover:text-white transition flex items-center gap-1" data-tooltip="Add custom style">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    Add
                </button>
            `;
            addBtnContainer.querySelector('#add-style-button').addEventListener('click', handleAddCustomStyle);
            container.appendChild(addBtnContainer);
        }

        // --- EVENT LISTENERS (v13) ---
        // ‚òÖ‚òÖ‚òÖ Â§âÊõ¥ (v13) ‚òÖ‚òÖ‚òÖ
        function initListeners() {
            // Ë™çË®º
            authForm.addEventListener('submit', handleAuthSubmit);
            
            // Â±•Ê≠¥ÂâäÈô§
            clearHistoryButton.addEventListener('click', () => {
                deleteConfirmModal.classList.add('flex');
                deleteConfirmPassword.value = '';
                deleteConfirmError.classList.add('hidden');
            });
            deleteConfirmForm.addEventListener('submit', handleClearHistory);
            cancelDeleteButton.addEventListener('click', () => {
                deleteConfirmModal.classList.remove('flex');
            });

            // ‚òÖ Â§âÊõ¥: „Éï„Ç©„Éº„É†„ÅÆÈÄÅ‰ø°ÂÖà„Çí handleGenerationSubmit („É´„Éº„Çø„Éº) „Å´
            generationForm.addEventListener('submit', handleGenerationSubmit); 
            
            // ÁøªË®≥
            translateButton.addEventListener('click', handleTranslate);
            
            // „Éó„É≠„É≥„Éó„Éà„Éú„Çø„É≥
            promptCopyButton.addEventListener('click', handlePromptCopy);
            promptClearButton.addEventListener('click', handlePromptClear);
            promptToggleSizeButton.addEventListener('click', handleTogglePromptSize);
            
            // ÁøªË®≥ÂÄôË£ú
            applySuggestionsButton.addEventListener('click', handleApplySuggestions);
            
            // „É¢„Éá„É´ÈÅ∏Êäû
            modelsToggleBtn.addEventListener('click', () => toggleModelsAccordion());
            
            // ÁîªÂÉè„É¢„Éº„ÉÄ„É´
            modalClose.addEventListener('click', () => imageModal.classList.remove('flex'));
            modalCopy.addEventListener('click', handleModalCopy);
            modalRegenerate.addEventListener('click', handleModalRegenerate);
            modalEdit.addEventListener('click', handleModalEdit);
            modalZoomIn.addEventListener('click', handleZoomIn);
            modalZoomOut.addEventListener('click', handleZoomOut);
            modalZoomReset.addEventListener('click', handleZoomReset);

            // Á∑®ÈõÜ„É¢„Éº„Éâ„Éú„Çø„É≥
            editWithFlashButton.addEventListener('click', () => toggleEditMode(true, ['gemini-2.5-flash-image-preview']));
            editWithFlash20Button.addEventListener('click', () => toggleEditMode(true, ['gemini-2.0-flash-preview-image-generation']));
            
            // „Éà„Éº„Çπ„Éà
            toastClose.addEventListener('click', () => hideToast());
            toastCopy.addEventListener('click', () => copyToastMessage());

            // „É™„Éà„É©„Ç§ÈÅ∏Êäû
            autoRetrySelect.addEventListener('change', handleAutoRetryChange);

            // „Çπ„Çø„Ç§„É´
            stylesToggleBtn.addEventListener('click', toggleStylesAccordion);
            selectedStylesPreview.addEventListener('click', () => {
                if (stylesContainer.classList.contains('hidden')) {
                    toggleStylesAccordion();
                }
            });
            
            // „Éó„É≠„É≥„Éó„ÉàÂÖ•Âäõ (Enter„Ç≠„Éº)
            promptInput.addEventListener('keydown', handlePromptKeydown);

            // D&D
            imageDisplay.addEventListener('dragover', handleDragOver);
            imageDisplay.addEventListener('dragleave', handleDragLeave);
            imageDisplay.addEventListener('drop', handleDrop);

            // „Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
            uploadImageButton.addEventListener('click', () => uploadImageInput.click());
            uploadImageInput.addEventListener('change', handleFileSelect);

            // „É™„Çµ„Ç§„Ç∫
            window.addEventListener('resize', adjustMainContentPadding);

            // „Çπ„ÉØ„Ç§„Éó
            document.addEventListener('touchstart', handleTouchStart, { passive: true });
            document.addEventListener('touchmove', handleTouchMove, { passive: true });
            document.addEventListener('touchend', handleTouchEnd, { passive: true });

            // ‚òÖ ËøΩÂä† (v13): BG„Éà„Ç∞„É´„ÅÆ„É™„Çπ„Éä„Éº
            bgModeToggle.addEventListener('change', handleBGModeToggle);
        }
        // ‚òÖ‚òÖ‚òÖ Â§âÊõ¥„Åì„Åì„Åæ„Åß ‚òÖ‚òÖ‚òÖ
        
        // (ÁúÅÁï•: v12„Å®Âêå„Åò adjustMainContentPadding, handleTouchStart, handleTouchMove, handleTouchEnd Èñ¢Êï∞)
        function adjustMainContentPadding() {
            if (promptFooter && imageContainer) {
                const footerHeight = promptFooter.offsetHeight;
                imageContainer.style.paddingBottom = `${footerHeight + 20}px`;
            }
        }
        function handleTouchStart(event) {
            if (authModal.classList.contains('flex') || deleteConfirmModal.classList.contains('flex')) return;
            const firstTouch = event.touches[0];
            touchStartX = firstTouch.clientX; touchStartY = firstTouch.clientY; touchMoveX = firstTouch.clientX;
        }
        function handleTouchMove(event) {
            if (authModal.classList.contains('flex') || deleteConfirmModal.classList.contains('flex')) return;
            if (Math.abs(event.touches[0].clientX - touchStartX) < Math.abs(event.touches[0].clientY - touchStartY)) {
                touchStartX = 0; return;
            }
            touchMoveX = event.touches[0].clientX;
        }
        function handleTouchEnd() {
            if (authModal.classList.contains('flex') || deleteConfirmModal.classList.contains('flex')) return;
            if (touchStartX === 0) return; 
            const deltaX = touchMoveX - touchStartX;
            const isSidebarOpen = !sidebar.classList.contains('-translate-x-full');
            if (isMobile && !isSidebarOpen && touchStartX < 30 && deltaX > 100) {
                toggleSidebar(true);
            } else if (isMobile && isSidebarOpen && deltaX < -100) {
                toggleSidebar(false);
            }
            touchStartX = 0; touchStartY = 0; touchMoveX = 0;
        }
        
        // (ÁúÅÁï•: v12„Å®Âêå„Åò handleAutoRetryChange Èñ¢Êï∞)
        function handleAutoRetryChange() {
            if(autoRetrySelect.value === '-1') {
                const customRetry = prompt("Enter number of retries:", "100");
                if (customRetry && !isNaN(parseInt(customRetry))) {
                    const val = parseInt(customRetry);
                    const newOption = new Option(`${val} Times (Custom)`, val, true, true);
                    autoRetrySelect.add(newOption);
                } else {
                    autoRetrySelect.value = '0';
                }
            }
        }


        // --- CORE LOGIC (v13) ---

        // (ÁúÅÁï•: v12„Å®Âêå„Åò initModels, toggleModelsAccordion, handleModelSelectionChange Èñ¢Êï∞)
        function initModels() {
            modelsContainer.innerHTML = "";
            for (const [modelId, modelInfo] of Object.entries(MODELS)) {
                const inputId = `model-${modelId}`;
                let labelClass = "cursor-pointer text-gray-300 hover:bg-gray-700 p-2 rounded-md flex items-center border border-transparent";
                let modelTypeIcon = "";
                if (modelInfo.type === 'imagen') {
                    modelTypeIcon = `<svg class="w-4 h-4 mr-2 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-image"></use></svg>`;
                } else if (modelInfo.type === 'gemini-edit') {
                    modelTypeIcon = `<svg class="w-4 h-4 mr-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-edit"></use></svg>`;
                }
                const div = document.createElement('div');
                div.innerHTML = `
                    <input type="checkbox" id="${inputId}" value="${modelId}" data-type="${modelInfo.type}" class="hidden model-checkbox">
                    <label for="${inputId}" class="${labelClass}">
                        ${modelTypeIcon}
                        ${modelInfo.name}
                    </label>
                `;
                modelsContainer.appendChild(div);
                div.querySelector('input').addEventListener('change', handleModelSelectionChange);
            }
            const defaultModel = document.getElementById('model-imagen-4.0-fast-generate-001');
            if (defaultModel) {
                defaultModel.checked = true;
            } else if (document.getElementById('model-imagen-3.0-generate')) {
                document.getElementById('model-imagen-3.0-generate').checked = true; // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
            }
            document.addEventListener('click', (e) => {
                if (!modelSelectGroup.contains(e.target) && !modelsContainer.classList.contains('hidden')) {
                    toggleModelsAccordion(false);
                }
            });
            updateToolbarForSelection();
        }
        function toggleModelsAccordion(forceOpen) {
            const isOpen = !modelsContainer.classList.contains('hidden');
            let shouldBeOpen;
            if (forceOpen === true) shouldBeOpen = true;
            else if (forceOpen === false) shouldBeOpen = false;
            else shouldBeOpen = !isOpen;
            if (shouldBeOpen) {
                modelsContainer.classList.remove('hidden');
                modelsChevron.classList.add('rotate-180');
            } else {
                modelsContainer.classList.add('hidden');
                modelsChevron.classList.remove('rotate-180');
            }
            setTimeout(adjustMainContentPadding, 100); 
        }
        function handleModelSelectionChange() {
            if (!isEditingMode) {
                updateToolbarForSelection();
            }
        }
        
        // ‚òÖ‚òÖ‚òÖ Â§âÊõ¥ (v13): BG„Éà„Ç∞„É´„Å´Âøú„Åò„Å¶UIÂà∂Âæ° ‚òÖ‚òÖ‚òÖ
        /**
         * ÈÅ∏Êäû‰∏≠„ÅÆ„É¢„Éá„É´„Å®BG„É¢„Éº„Éâ„Å´Âøú„Åò„Å¶„ÉÑ„Éº„É´„Éê„Éº„ÇíÂà∂Âæ°
         */
        function updateToolbarForSelection() {
            const selectedModels = getSelectedModels();
            const hasImagen = selectedModels.some(modelId => MODELS[modelId]?.type === 'imagen');
            const isBGMode = bgModeToggle.checked;

            // 1. ImagenÁ≥ª (Aspect Ratio, Styles)
            if (hasImagen) {
                aspectRatioGroup.style.display = 'block';
                stylesToggleBtn.style.display = 'flex';
            } else {
                aspectRatioGroup.style.display = 'none';
                stylesToggleBtn.style.display = 'none';
            }
            
            // 2. Auto Retry (FG„É¢„Éº„Éâ„Åß„ÅÆ„ÅøË°®Á§∫)
            if (isBGMode) {
                autoRetryGroup.style.display = 'none';
            } else {
                autoRetryGroup.style.display = 'block';
            }

            setTimeout(adjustMainContentPadding, 100);
        }
        
        /**
         * ‚òÖ Êñ∞Ë¶è (v13): BG„Éà„Ç∞„É´„ÅåÂ§âÊõ¥„Åï„Çå„Åü„Å®„Åç„ÅÆÂá¶ÁêÜ
         */
        function handleBGModeToggle() {
            // „Éà„Ç∞„É´Áä∂ÊÖã„Å´Âøú„Åò„Å¶„ÉÑ„Éº„É´„Éê„Éº„ÇíÊõ¥Êñ∞
            updateToolbarForSelection();
            
            // „Ç¢„Ç§„Ç≥„É≥„ÇíÊõ¥Êñ∞ (BG„É¢„Éº„Éâ„Åß„ÇÇÁ∑®ÈõÜ„É¢„Éº„Éâ„ÅØ„Çè„Åã„Çã„Çà„ÅÜ„Å´)
            setLoading(generateButton, false); 
        }
        // ‚òÖ‚òÖ‚òÖ Â§âÊõ¥„Åì„Åì„Åæ„Åß ‚òÖ‚òÖ‚òÖ
        
        // (ÁúÅÁï•: v12„Å®Âêå„Åò getSelectedModels, updateGridColumns, updatePlaceholderVisibility Èñ¢Êï∞)
        function getSelectedModels() {
             return Array.from(document.querySelectorAll('.model-checkbox:checked')).map(cb => cb.value);
        }
        function updateGridColumns() {
            const count = imageGridContainer.children.length;
            imageGridContainer.classList.remove('grid-cols-1', 'md:grid-cols-2', 'lg:grid-cols-3');
            if (count === 1) {
                imageGridContainer.classList.add('grid-cols-1');
            } else if (count === 2) {
                imageGridContainer.classList.add('grid-cols-1', 'md:grid-cols-2');
            } else {
                imageGridContainer.classList.add('grid-cols-1', 'md:grid-cols-2', 'lg:grid-cols-3');
            }
        }
        function updatePlaceholderVisibility() {
            if (imageGridContainer.children.length > 0) {
                placeholder.style.display = 'none';
            } else {
                placeholder.style.display = 'flex';
            }
        }

        // (ÁúÅÁï•: v12„Å®Âêå„Åò toggleStylesAccordion, updateSelectedStylesPreview Èñ¢Êï∞)
        function toggleStylesAccordion() {
            const isClosing = stylesContainer.classList.toggle('hidden'); 
            stylesChevron.classList.toggle('rotate-180');
            updateSelectedStylesPreview(isClosing);
            setTimeout(adjustMainContentPadding, 100);
        }
        function updateSelectedStylesPreview(showPreview = false) {
            if (!showPreview) {
                selectedStylesPreview.classList.add('hidden');
                return;
            }
            const selectedStyles = Array.from(document.querySelectorAll('.style-checkbox:checked'));
            if (selectedStyles.length > 0) {
                selectedStylesPreview.innerHTML = selectedStyles.map(cb => {
                    return `<span class="bg-indigo-600 text-white text-xs font-medium px-2.5 py-0.5 rounded-full">${escapeHTML(cb.value)}</span>`;
                }).join('');
                selectedStylesPreview.classList.remove('hidden');
            } else {
                selectedStylesPreview.innerHTML = '';
                selectedStylesPreview.classList.add('hidden');
            }
        }

        // (ÁúÅÁï•: v12„Å®Âêå„Åò handlePromptKeydown Èñ¢Êï∞)
        function handlePromptKeydown(event) {
            if (isMobile) {
                if (event.key === 'Enter' && !event.shiftKey) {
                     event.preventDefault();
                     handleGenerationSubmit(new Event('submit'));
                }
                return;
            }
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault(); 
                const now = new Date().getTime();
                if (now - lastEnterPress < 500) {
                    handleGenerationSubmit(new Event('submit'));
                    lastEnterPress = 0; 
                } else {
                    lastEnterPress = now;
                    showToast("Press Enter again to send", "info"); 
                    setTimeout(() => { if (lastEnterPress === now) { lastEnterPress = 0; } }, 500); 
                }
            } else if (event.key !== 'Enter') {
                lastEnterPress = 0;
            }
        }

        // (ÁúÅÁï•: v12„Å®Âêå„Åò clearImageGrid Èñ¢Êï∞)
        function clearImageGrid() {
            imageGridContainer.innerHTML = '';
            currentEditImageBase64 = null;
            if (isEditingMode) {
                toggleEditMode(false);
            }
            updatePlaceholderVisibility();
            updateGridColumns();
        }

        // (ÁúÅÁï•: v12„Å®Âêå„Åò toggleEditMode Èñ¢Êï∞)
        function toggleEditMode(forceOn, modelsToSelect = []) { 
            isEditingMode = forceOn;
            const allModelCheckboxes = Array.from(document.querySelectorAll('.model-checkbox'));
            if (isEditingMode) {
                if (!currentEditImageBase64) {
                    showToast("No image to edit. Generate or upload an image first.", "warning");
                    isEditingMode = false;
                    return;
                }
                promptInput.placeholder = "Enter edit instructions...";
                optionsToolbar.style.display = 'flex';
                modelsToggleBtn.style.display = 'block';
                // autoRetryGroup „ÅØ handleBGModeToggle „ÅßÂà∂Âæ°
                aspectRatioGroup.style.display = 'none';
                stylesToggleBtn.style.display = 'none';
                
                allModelCheckboxes.forEach(cb => {
                    const modelType = cb.dataset.type;
                    if (modelType === 'gemini-edit') {
                        cb.parentElement.style.display = 'block';
                        cb.checked = modelsToSelect.includes(cb.value);
                    } else {
                        cb.parentElement.style.display = 'none';
                        cb.checked = false;
                    }
                });
                imageDisplay.classList.add('ring-4', 'ring-indigo-500');
                if (!stylesContainer.classList.contains('hidden')) { toggleStylesAccordion(); }
                editModeIndicator.textContent = `üé® Editing Mode (Gemini 2.0 / 2.5) - Select models to use for editing.`;
                editModeIndicator.classList.remove('hidden');
            } else {
                promptInput.placeholder = "Enter your prompt... (Non-English will be translated)";
                optionsToolbar.style.display = 'flex';
                modelsToggleBtn.style.display = 'block';
                // autoRetryGroup „ÅØ handleBGModeToggle „ÅßÂà∂Âæ°

                let defaultModelChecked = false;
                allModelCheckboxes.forEach(cb => {
                    cb.parentElement.style.display = 'block';
                    if (cb.value === 'imagen-4.0-fast-generate-001') {
                         cb.checked = true; defaultModelChecked = true;
                    } else {
                         cb.checked = false;
                    }
                });
                if (!defaultModelChecked && document.getElementById('model-imagen-3.0-generate')) {
                     document.getElementById('model-imagen-3.0-generate').checked = true;
                }
                imageDisplay.classList.remove('ring-4', 'ring-indigo-500');
                editModeIndicator.classList.add('hidden');
            }
            updateToolbarForSelection();
            setLoading(generateButton, false);
            setTimeout(adjustMainContentPadding, 100);
        }

        // (ÁúÅÁï•: v12„Å®Âêå„Åò handleTranslate, handleApplySuggestions, escapeHTML Èñ¢Êï∞)
        async function handleTranslate() {
            const prompt = promptInput.value;
            if (!prompt) { showToast("Please enter text to translate", "warning"); return; }
            promptSuggestionsContainer.classList.add('hidden');
            promptSuggestionsList.innerHTML = '';
            setLoading(translateButton, true);
            try {
                apiKeyCounter++; // ÁøªË®≥„Åß„ÇÇ„Ç≠„Éº„Çí„É≠„Éº„ÉÜ„Éº„Ç∑„Éß„É≥
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 100000); 
                const response = await fetchWithRetry('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'translate',
                        prompt: prompt,
                        keyIndex: apiKeyCounter // ‚òÖ v13: „Ç≠„Éº„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÇíÊ∏°„Åô
                    })
                }, 0, controller.signal);
                clearTimeout(timeoutId);
                const data = await response.json();
                if (response.ok) {
                    const translatedText = data.translatedPrompt;
                    let candidates = translatedText.split(/\n\s*\n/).filter(p => p.trim().length > 0);
                    if (candidates.length <= 1) {
                        const bracketCandidates = translatedText.split(/\n\s*(?=\[)/).filter(p => p.trim().length > 0);
                        if (bracketCandidates.length > 1) { candidates = bracketCandidates; }
                    }
                    candidates = candidates.map(c => 
                        c.trim().replace(/^\[.*?\]\s*/, '').replace(/^[0-9]\.\s*/, '').trim()
                    ).filter(c => c.length > 0);
                    if (candidates.length > 1) {
                        promptInput.value = "";
                        promptSuggestionsList.innerHTML = '';
                        candidates.forEach((candidate, index) => {
                            const suggestionId = `suggestion-${index}`;
                            const div = document.createElement('div');
                            div.className = "flex items-center bg-gray-800 p-2 rounded";
                            div.innerHTML = `
                                <input id="${suggestionId}" type="checkbox" value="${escapeHTML(candidate)}" class="suggestion-checkbox w-4 h-4 text-indigo-600 bg-gray-700 border-gray-600 rounded focus:ring-indigo-500">
                                <label for="${suggestionId}" class="ml-2 text-sm text-gray-200 cursor-pointer">${escapeHTML(candidate)}</label>
                            `;
                            promptSuggestionsList.appendChild(div);
                        });
                        promptSuggestionsContainer.classList.remove('hidden');
                        showToast("Multiple suggestions found", "info");
                    } else {
                        promptInput.value = translatedText;
                        showToast("Translation successful", "success");
                    }
                } else {
                    throw new Error(data.error || "Translation failed");
                }
            } catch (error) {
                console.error("Translate error:", error);
                if (error.name !== 'AbortError') { showToast(error.message, "error"); }
                else { showToast("Translation timed out.", "error"); }
            } finally {
                setLoading(translateButton, false);
                setTimeout(adjustMainContentPadding, 100);
            }
        }
        function handleApplySuggestions() {
            const selectedCandidates = Array.from(document.querySelectorAll('.suggestion-checkbox:checked'));
            const combinedPrompt = selectedCandidates.map(cb => cb.value).join(', ');
            if (combinedPrompt.length === 0) { showToast("Please select at least one suggestion", "warning"); return; }
            promptInput.value = combinedPrompt;
            promptSuggestionsContainer.classList.add('hidden');
            promptSuggestionsList.innerHTML = '';
            setTimeout(adjustMainContentPadding, 100);
        }
        function escapeHTML(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/[&<>"']/g, function(match) {
                return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[match];
            });
        }


        // ‚òÖ‚òÖ‚òÖ Â§âÊõ¥ (v13): ÁîüÊàêÂá¶ÁêÜ„ÅÆ„É´„Éº„Çø„Éº ‚òÖ‚òÖ‚òÖ
        /**
         * ÁîüÊàê„Éú„Çø„É≥Êäº‰∏ãÊôÇ„ÅÆ„É°„Ç§„É≥„É´„Éº„Çø„Éº (v13)
         * FG/BG„É¢„Éº„Éâ„ÇíÂà§ÂÆö„Åó„ÄÅ„Åù„Çå„Åû„Çå„ÅÆÂá¶ÁêÜ„ÇíÂëº„Å≥Âá∫„Åô
         */
        function handleGenerationSubmit(event) {
            if (event) event.preventDefault();
            
            const isBGMode = bgModeToggle.checked;
            
            // --- „Ç≠„É£„É≥„Çª„É´Âá¶ÁêÜ ---
            // FG„É¢„Éº„Éâ„ÅßÂÆüË°å‰∏≠„Åã„ÄÅBG„É¢„Éº„Éâ„Åß„Éù„Éº„É™„É≥„Ç∞‰∏≠„Å™„Çâ„ÄÅ„Ç≠„É£„É≥„Çª„É´
            if (generationInProgress_FG || isPolling_BG) {
                if (generationInProgress_FG && currentFetchController_FG) {
                    currentFetchController_FG.abort(); // FG„ÅÆFetch„Çí„Ç≠„É£„É≥„Çª„É´
                    showToast("FG generations cancelled", "info");
                }
                if (isPolling_BG) {
                    stopPolling_BG(true); // BG„ÅÆ„Éù„Éº„É™„É≥„Ç∞„Çí„Ç≠„É£„É≥„Çª„É´
                    showToast("BG generation polling cancelled", "info");
                }
                // setLoading(false) „ÅØÂêÑÂá¶ÁêÜ„ÅÆ finally „ÅßÂëº„Å∞„Çå„Çã
                return;
            }
            
            // --- ÁøªË®≥ÂÄôË£ú„Ç®„É™„Ç¢„ÇíÈñâ„Åò„Çã ---
            if (!promptSuggestionsContainer.classList.contains('hidden')) {
                 promptSuggestionsContainer.classList.add('hidden');
                 setTimeout(adjustMainContentPadding, 100);
            }

            // --- ÂÖ•Âäõ„ÉÅ„Çß„ÉÉ„ÇØ ---
            const prompt = promptInput.value;
            const selectedStyles = Array.from(document.querySelectorAll('.style-checkbox:checked')).map(cb => cb.value);
            let finalPrompt = prompt;

            const selectedModels = getSelectedModels();
            if (selectedModels.length === 0) {
                showToast("Please select at least one model", "warning"); return;
            }

            if (isEditingMode && !prompt && selectedStyles.length > 0) {
                finalPrompt = `Apply the following style(s): ${selectedStyles.join(', ')}`;
            } else if (!prompt) {
                showToast("Please enter a prompt", "warning"); return;
            }
            
            if (isEditingMode && !currentEditImageBase64) {
                 showToast("No image loaded for editing.", "warning");
                 toggleEditMode(false); return;
            }

            // --- „Ç∞„É™„ÉÉ„ÉâÂàùÊúüÂåñ ---
            if (isEditingMode) {
                imageGridContainer.innerHTML = ''; // Á∑®ÈõÜÊôÇ„ÅØ„Éô„Éº„ÇπÁîªÂÉè„ÇíÊ∂à„Åô
            } else {
                imageGridContainer.innerHTML = ''; // ÈÄöÂ∏∏ÁîüÊàêÊôÇ„ÇÇ„ÇØ„É™„Ç¢
            }
            placeholder.style.display = 'none'; 
            updateGridColumns();

            // --- „É¢„Éº„Éâ„Å´Âøú„Åò„Å¶Âá¶ÁêÜ„ÇíÂàÜÂ≤ê ---
            if (isBGMode) {
                handleGenerationSubmit_BG(finalPrompt, selectedModels, selectedStyles);
            } else {
                handleGenerationSubmit_FG(finalPrompt, selectedModels, selectedStyles);
            }
        }
        

        // ‚òÖ‚òÖ‚òÖ Â§âÊõ¥ (v13): „Éï„Ç©„Ç¢„Ç∞„É©„Ç¶„É≥„Éâ (FG) ÁîüÊàêÂá¶ÁêÜ ‚òÖ‚òÖ‚òÖ
        /**
         * FG: „Éï„Ç©„Ç¢„Ç∞„É©„Ç¶„É≥„ÉâÁîüÊàê (v12„ÅÆ handleGenerationSubmit „Å®ÂêåÁ≠â)
         */
        async function handleGenerationSubmit_FG(finalPrompt, selectedModels, selectedStyles) {
            
            generationInProgress_FG = true;
            runningGenerations_FG.clear();
            currentFetchController_FG = new AbortController();
            setLoading(generateButton, true); // Stop„Ç¢„Ç§„Ç≥„É≥
            
            const isPrivateMode = document.getElementById('private-mode-toggle').checked;
            const retryCount = parseInt(autoRetrySelect.value, 10);
            
            for (const modelId of selectedModels) {
                apiKeyCounter++;
                const modelInfo = MODELS[modelId];

                const cardId = `image-card-fg-${modelId}-${apiKeyCounter}`;
                const card = createImageCard(cardId, modelInfo.name, false); // FG„É¢„Éº„Éâ
                imageGridContainer.appendChild(card);

                const isGeminiJob = modelInfo.type === 'gemini-edit';
                const isImagenJob = modelInfo.type === 'imagen';

                const payload = {
                    action: isImagenJob ? 'generate_fg' : 'edit_fg', // ‚òÖ v13: „Ç¢„ÇØ„Ç∑„Éß„É≥ÂêçÂ§âÊõ¥
                    prompt: finalPrompt,
                    model: modelId, 
                    keyIndex: apiKeyCounter, 
                    aspectRatio: aspectRatioSelect.value, 
                    styles: selectedStyles,
                    baseImage: (isEditingMode || isGeminiJob) ? currentEditImageBase64 : null
                };

                runningGenerations_FG.add(cardId);

                const promise = fetchWithRetry('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }, retryCount, currentFetchController_FG.signal) // ‚òÖ v13: FG„ÅÆController
                .then(response => response.json())
                .then(data => {
                    // ÊàêÂäü
                    if (data.error) throw new Error(data.error); // APIÂÅ¥„Åß„Ç≠„É£„ÉÉ„ÉÅ„Åó„Åü„Ç®„É©„Éº
                    
                    const base64 = `data:image/png;base64,${data.base64}`;
                    updateImageCard(cardId, base64, finalPrompt, data.translatedPrompt || finalPrompt, data.base64, null, isPrivateMode);
                    saveImageToDB(finalPrompt, data.translatedPrompt || finalPrompt, base64, modelId, aspectRatioSelect.value, selectedStyles); 
                    
                    if (!currentEditImageBase64 && data.base64) {
                        currentEditImageBase64 = data.base64;
                    }
                })
                .catch(error => {
                    // Â§±Êïó or „Ç≠„É£„É≥„Çª„É´
                    if (error.name !== 'AbortError') {
                        console.error(`FG Generation error for ${modelId}:`, error);
                        updateImageCard(cardId, null, finalPrompt, null, null, error.message, isPrivateMode);
                        // FG„Åß„ÅØ fetchWithRetry ÂÜÖ„Åß„Ç®„É©„Éº„ÇíGAS„Å´ÈÄÅ„Çã (v12‰∫íÊèõ)
                        // ‚Äª generate.js ÂÅ¥„Åß„Ç®„É©„ÉºÊôÇ„Å´GASÈÄÅ‰ø°„Åô„Çã„Çà„ÅÜ„Å´„Å™„Å£„Åü„ÅÆ„Åß„ÄÅ„Åì„Åì„Åß„ÅØ‰∏çË¶Å
                    } else {
                        console.log(`FG Generation cancelled for ${modelId}`);
                        updateImageCard(cardId, null, finalPrompt, null, null, "Cancelled", isPrivateMode);
                    }
                })
                .finally(() => {
                    runningGenerations_FG.delete(cardId);
                    if (runningGenerations_FG.size === 0) {
                        generationInProgress_FG = false;
                        currentFetchController_FG = null;
                        setLoading(generateButton, false); // Send/Edit„Ç¢„Ç§„Ç≥„É≥
                        
                        if (isEditingMode && !promptInput.value && selectedStyles.length > 0) {
                             promptInput.value = "";
                        }
                    }
                });
                
                updateGridColumns();
            } 
        }

        /**
         * FG: „É™„Éà„É©„Ç§‰ªò„ÅçFetch (v12„Å®„Åª„ÅºÂêå„Åò)
         */
        async function fetchWithRetry(url, options, retries = 0, signal = null) {
            let attempt = 0;
            const maxRetries = retries < 0 ? 0 : retries; 

            if (signal) {
                options.signal = signal;
            }

            while (attempt <= maxRetries) {
                try {
                    if (attempt > 0) {
                       showToast(`Retrying... (Attempt ${attempt} of ${maxRetries})`, "warning", 2000);
                    }
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: `Server error: ${response.status}` }));
                        throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                    }
                    return response; 
                } catch (error) {
                    if (error.name === 'AbortError') {
                        throw error;
                    }
                    console.warn(`Attempt ${attempt} failed:`, error.message);
                    if (attempt === maxRetries) {
                        if (error.message.includes('401') || error.message.includes('Authentication failed')) {
                            sessionStorage.removeItem('muGenAuthenticated');
                            location.reload();
                        }
                        throw error; 
                    }
                    attempt++;
                    await new Promise((res, rej) => {
                        const timer = setTimeout(res, 1000 * attempt);
                        if (signal) {
                            signal.addEventListener('abort', () => {
                                clearTimeout(timer);
                                rej(new DOMException('Aborted', 'AbortError'));
                            });
                        }
                    });
                }
            }
        }
        
        // (ÁúÅÁï•: v12„ÅÆ sendErrorToGAS „ÅØ v13„Åß„ÅØ generate.js ÂÅ¥„Å´ÈõÜÁ¥Ñ)
        
        // ‚òÖ‚òÖ‚òÖ Êñ∞Ë¶è (v13): „Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ (BG) ÁîüÊàêÂá¶ÁêÜ ‚òÖ‚òÖ‚òÖ
        
        /**
         * BG: „Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ„Ç∏„Éß„Éñ„ÅÆÊäïÂÖ•„Å®„Éù„Éº„É™„É≥„Ç∞ÈñãÂßã
         */
        async function handleGenerationSubmit_BG(finalPrompt, selectedModels, selectedStyles) {
            
            isPolling_BG = true; // ‚òÖ „Éù„Éº„É™„É≥„Ç∞‰∏≠„Å´Â§âÊõ¥
            setLoading(generateButton, true); // Stop„Ç¢„Ç§„Ç≥„É≥
            
            const isPrivateMode = document.getElementById('private-mode-toggle').checked;
            
            for (const modelId of selectedModels) {
                apiKeyCounter++;
                const modelInfo = MODELS[modelId];
                
                // „Ç∏„Éß„ÉñID„Å®„Ç´„Éº„ÉâID„ÇíÁîüÊàê
                const jobId = `${Date.now()}-${modelId}-${Math.random().toString(36).substring(2, 9)}`;
                const cardId = `image-card-bg-${jobId}`;
                
                // „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„Ç´„Éº„Éâ (BG„É¢„Éº„Éâ)
                const card = createImageCard(cardId, modelInfo.name, true); // BG„É¢„Éº„Éâ
                imageGridContainer.appendChild(card);
                updateGridColumns();

                const isGeminiJob = modelInfo.type === 'gemini-edit';

                // KV„Å´‰øùÂ≠ò„Åô„Çã„Ç∏„Éß„Éñ„Éö„Ç§„É≠„Éº„Éâ
                const jobPayload = {
                    prompt: finalPrompt,
                    model: modelId, 
                    aspectRatio: aspectRatioSelect.value, 
                    styles: selectedStyles,
                    baseImage: (isEditingMode || isGeminiJob) ? currentEditImageBase64 : null
                };

                // KV„Å´„Ç∏„Éß„Éñ„ÇíÊäïÂÖ• („Ç¶„Çß„Ç§„Çø„ÉºAPIÁµåÁî±)
                try {
                    const response = await fetch('/api/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'submit_bg_job',
                            jobId: jobId,
                            model: modelId,
                            keyIndex: apiKeyCounter,
                            jobPayload: jobPayload
                        })
                    });
                    
                    const data = await response.json();
                    if (!response.ok || !data.success) {
                        throw new Error(data.error || "Failed to submit BG job");
                    }
                    
                    // „Ç∏„Éß„ÉñÊäïÂÖ•ÊàêÂäüÔºÅ „Éù„Éº„É™„É≥„Ç∞„É™„Çπ„Éà„Å´ËøΩÂä†
                    pollingJobs_BG.add({
                        jobId: jobId,
                        cardId: cardId,
                        modelName: modelInfo.name,
                        prompt: finalPrompt,
                        translatedPrompt: finalPrompt, // ÂàùÊúüÂÄ§
                        isPrivateMode: isPrivateMode,
                        model: modelId, // DB‰øùÂ≠òÁî®
                        aspectRatio: aspectRatioSelect.value, // DB‰øùÂ≠òÁî®
                        styles: selectedStyles // DB‰øùÂ≠òÁî®
                    });
                    
                } catch (error) {
                    // „Ç∏„Éß„ÉñÊäïÂÖ•Â§±Êïó (KV„Ç®„É©„Éº„Å™„Å©)
                    console.error(`Failed to submit BG job for ${modelId}:`, error);
                    updateImageCard(cardId, null, finalPrompt, null, null, `Job submission failed: ${error.message}`, isPrivateMode);
                }
            } // end for loop
            
            // ÂÖ®„Å¶„ÅÆ„Ç∏„Éß„ÉñÊäïÂÖ•„ÅåÁµÇ„Çè„Å£„Åü„Çâ„ÄÅ„Éù„Éº„É™„É≥„Ç∞„ÇíÈñãÂßã
            if (pollingJobs_BG.size > 0) {
                startPolling_BG();
            } else {
                // 1‰ª∂„ÇÇÊäïÂÖ•„Åß„Åç„Å™„Åã„Å£„Åü
                isPolling_BG = false;
                setLoading(generateButton, false);
            }
        }
        
        /**
         * BG: „Éù„Éº„É™„É≥„Ç∞„ÇíÈñãÂßã
         */
        function startPolling_BG() {
            if (pollingIntervalId_BG) {
                clearInterval(pollingIntervalId_BG); // Âøµ„ÅÆ„Åü„ÇÅÊó¢Â≠ò„Çí„ÇØ„É™„Ç¢
            }
            
            console.log(`Starting BG polling for ${pollingJobs_BG.size} jobs...`);
            
            // „Éù„Éº„É™„É≥„Ç∞„Çø„Ç§„Éû„Éº„ÇíË®≠ÂÆö
            pollingIntervalId_BG = setInterval(async () => {
                
                // „Éù„Éº„É™„É≥„Ç∞ÂØæË±°„Åå„Å™„Åè„Å™„Å£„Åü„Çâ„Çø„Ç§„Éû„ÉºÂÅúÊ≠¢
                if (pollingJobs_BG.size === 0) {
                    stopPolling_BG(false); // Ê≠£Â∏∏ÂÅúÊ≠¢
                    return;
                }

                // „Éù„Éº„É™„É≥„Ç∞‰∏≠„ÅÆÂÖ®„Ç∏„Éß„Éñ„Çí‰∏¶Âàó„Åß„ÉÅ„Çß„ÉÉ„ÇØ
                const checkPromises = [];
                for (const job of pollingJobs_BG) {
                    checkPromises.push(checkJobStatus_BG(job));
                }
                
                await Promise.allSettled(checkPromises);
                
            }, POLLING_INTERVAL);
        }
        
        /**
         * BG: „Ç∏„Éß„Éñ„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„Çí1‰ª∂„ÉÅ„Çß„ÉÉ„ÇØ
         */
        async function checkJobStatus_BG(job) {
            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'check_bg_job',
                        jobId: job.jobId
                    })
                });
                
                if (!response.ok) {
                    // „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„Å™„Å©
                    throw new Error(`Polling check failed: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.status === "completed") {
                    // ‚òÖ ÂÆå‰∫ÜÔºÅ
                    console.log(`Job ${job.jobId} completed!`);
                    const base64 = `data:image/png;base64,${data.base64}`;
                    
                    // „Ç´„Éº„ÉâÊõ¥Êñ∞
                    updateImageCard(job.cardId, base64, job.prompt, data.translatedPrompt || job.prompt, data.base64, null, job.isPrivateMode);
                    
                    // DB‰øùÂ≠ò
                    saveImageToDB(job.prompt, data.translatedPrompt || job.prompt, base64, job.model, job.aspectRatio, job.styles); 
                    
                    // „Éô„Éº„ÇπÁîªÂÉèË®≠ÂÆö
                    if (!currentEditImageBase64 && data.base64) {
                        currentEditImageBase64 = data.base64;
                    }
                    
                    // „Éù„Éº„É™„É≥„Ç∞„É™„Çπ„Éà„Åã„ÇâÂâäÈô§
                    pollingJobs_BG.delete(job);
                    
                } else if (data.status === "error") {
                    // ‚òÖ Â§±Êïó („É™„Éà„É©„Ç§„Ç™„Éº„Éê„Éº)
                    console.error(`Job ${job.jobId} failed: ${data.error}`);
                    updateImageCard(job.cardId, null, job.prompt, null, null, `BG Error: ${data.error}`, job.isPrivateMode);
                    // „Éù„Éº„É™„É≥„Ç∞„É™„Çπ„Éà„Åã„ÇâÂâäÈô§
                    pollingJobs_BG.delete(job);
                    
                } else if (data.status === "pending") {
                    // ‚è≥ „Åæ„Å†Âá¶ÁêÜ‰∏≠
                    console.log(`Job ${job.jobId} is still pending...`);
                    // ‰Ωï„ÇÇ„Åó„Å™„ÅÑ (Ê¨°„ÅÆ„Ç§„É≥„Çø„Éº„Éê„É´„ÅßÂÜç„ÉÅ„Çß„ÉÉ„ÇØ)
                    
                } else {
                    // ‰∏çÊòé„Å™„Çπ„ÉÜ„Éº„Çø„Çπ
                    throw new Error(`Unknown job status: ${data.status}`);
                }
                
            } catch (error) {
                // „Éù„Éº„É™„É≥„Ç∞Ëá™‰Ωì„ÅåÂ§±Êïó
                console.error(`Error polling for job ${job.jobId}:`, error);
                // („Åì„ÅÆÂ†¥Âêà„ÄÅ„Éù„Éº„É™„É≥„Ç∞„ÅØÁ∂öË°å„Åï„Çå„Çã)
            }
        }
        
        /**
         * BG: „Éù„Éº„É™„É≥„Ç∞„ÇíÂÅúÊ≠¢
         */
        function stopPolling_BG(wasCancelled) {
            if (pollingIntervalId_BG) {
                clearInterval(pollingIntervalId_BG);
                pollingIntervalId_BG = null;
            }
            
            if (wasCancelled) {
                // „Ç≠„É£„É≥„Çª„É´„Éú„Çø„É≥„ÅåÊäº„Åï„Çå„ÅüÂ†¥Âêà
                // „Éù„Éº„É™„É≥„Ç∞‰∏≠„ÅÆ„Ç´„Éº„Éâ„Çí„Äå„Ç≠„É£„É≥„Çª„É´„ÄçË°®Á§∫„Å´„Åô„Çã
                for (const job of pollingJobs_BG) {
                    updateImageCard(job.cardId, null, job.prompt, null, null, "Cancelled (BG)", job.isPrivateMode);
                }
            }
            
            // „É™„Çπ„Éà„Çí„ÇØ„É™„Ç¢„Åó„ÄÅÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
            pollingJobs_BG.clear();
            isPolling_BG = false;
            setLoading(generateButton, false); // „Éú„Çø„É≥„Ç¢„Ç§„Ç≥„É≥„ÇíÊàª„Åô
            console.log("BG polling stopped.");
        }


        // --- ‚òÖ v13: PROMPT HELPERS ---
        // (ÁúÅÁï•: v12„Å®Âêå„Åò handlePromptCopy, handlePromptClear, handleTogglePromptSize Èñ¢Êï∞)
        function handlePromptCopy() {
            const textToCopy = promptInput.value;
            if (!textToCopy) { showToast("Nothing to copy", "info"); return; }
            copyToClipboard(textToCopy, "Prompt copied to clipboard!");
        }
        function handlePromptClear() {
            promptInput.value = "";
            showToast("Input cleared", "info");
        }
        function handleTogglePromptSize() {
            const icon = promptToggleSizeButton.querySelector('svg use');
            if (promptInput.rows === 2) {
                promptInput.rows = 10;
                if (icon) icon.setAttribute('href', '#icon-minimize');
                promptToggleSizeButton.dataset.tooltip = "Minimize Size";
            } else {
                promptInput.rows = 2;
                if (icon) icon.setAttribute('href', '#icon-maximize');
                promptToggleSizeButton.dataset.tooltip = "Maximize Size";
            }
            setTimeout(adjustMainContentPadding, 100);
        }

        
         // --- MODAL & TOAST (v12„Å®Âêå„Åò) ---
        function showImageInModal(base64DataUrl, prompt, translatedPrompt, rawBase64) {
            modalImage.src = base64DataUrl;
            modalPrompt.textContent = translatedPrompt || prompt;
            modalRegenerate.dataset.prompt = prompt;
            modalRegenerate.dataset.translatedPrompt = translatedPrompt;
            modalEdit.dataset.base64 = rawBase64; 
            modalEdit.dataset.prompt = prompt; 
            handleZoomReset();
            imageModal.classList.add('flex');
        }
        function handleModalCopy() {
            const textToCopy = modalPrompt.textContent;
            copyToClipboard(textToCopy, "Prompt copied to clipboard!");
        }
        function handleModalRegenerate() {
            const prompt = modalRegenerate.dataset.prompt;
            promptInput.value = prompt;
            imageModal.classList.remove('flex');
            if (isEditingMode) { toggleEditMode(false); }
            clearImageGrid(); 
            handleGenerationSubmit(new Event('submit')); 
        }
        function handleModalEdit() {
            const base64 = modalEdit.dataset.base64;
            const prompt = modalEdit.dataset.prompt;
            loadUploadedImage(`data:image/png;base64,${base64}`, prompt, false); 
            toggleEditMode(true, ['gemini-2.5-flash-image-preview']);
            imageModal.classList.remove('flex');
        }
        function handleZoomIn() { modalZoomLevel = Math.min(modalZoomLevel * 1.5, MAX_ZOOM); updateZoom(); }
        function handleZoomOut() { modalZoomLevel = Math.max(modalZoomLevel / 1.5, MIN_ZOOM); updateZoom(); }
        function handleZoomReset() {
            modalZoomLevel = 1.0;
            updateZoom();
            if (modalImageWrapper) { modalImageWrapper.scrollTop = 0; modalImageWrapper.scrollLeft = 0; }
        }
        function updateZoom() {
            if (modalImage) {
                modalImage.style.transform = `scale(${modalZoomLevel})`;
                if (modalZoomLevel === 1.0) { modalImage.classList.add('max-w-full', 'max-h-full', 'object-contain'); } 
                else { modalImage.classList.remove('max-w-full', 'max-h-full', 'object-contain'); }
            }
        }
        function showToast(message, type = "success") {
            if (toastTimeoutId) { clearTimeout(toastTimeoutId); toastTimeoutId = null; }
            toastMessage.textContent = message;
            toast.className = `fixed top-20 right-6 text-white py-3 px-4 rounded-lg shadow-lg transition-all duration-300 opacity-0 -translate-y-10 z-50`; 
            if (type === "error") {
                toast.classList.add('bg-red-600');
                toastCopy.classList.remove('hidden'); 
            } else {
                toast.classList.add(type === "warning" ? 'bg-yellow-500' : (type === "info" ? 'bg-blue-600' : 'bg-green-600'));
                toastCopy.classList.add('hidden');
            }
            toast.classList.remove('opacity-0', '-translate-y-10');
            toast.classList.add('opacity-100', 'translate-y-0');
            if (type !== "error") {
                toastTimeoutId = setTimeout(() => { hideToast(); }, 3000); 
            }
        }
        function hideToast() {
            if (toastTimeoutId) { clearTimeout(toastTimeoutId); toastTimeoutId = null; }
            toast.classList.remove('opacity-100', 'translate-y-0');
            toast.classList.add('opacity-0', '-translate-y-10');
        }
        function copyToastMessage() {
            const textToCopy = toastMessage.textContent;
            copyToClipboard(textToCopy, "Error message copied!");
        }
        function copyToClipboard(textToCopy, successMessage) {
             navigator.clipboard.writeText(textToCopy).then(() => {
                showToast(successMessage, "success");
            }).catch(err => {
                console.error('Clipboard copy failed:', err);
                try {
                    const textArea = document.createElement("textarea");
                    textArea.value = textToCopy;
                    textArea.style.position = "fixed"; textArea.style.top = "0"; textArea.style.left = "0";
                    document.body.appendChild(textArea);
                    textArea.focus(); textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showToast(successMessage, "success");
                } catch (fallbackErr) {
                    console.error('Fallback copy failed:', fallbackErr);
                    showToast("Failed to copy", "error");
                }
            });
        }
        function setLoading(button, isLoading) {
            if (button.id === 'auth-submit') {
                if (isLoading) { button.disabled = true; button.innerHTML = '<svg class="w-5 h-5 text-white animate-spin mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-loader"></use></svg>'; } 
                else { button.disabled = false; button.innerHTML = 'Login'; }
                return;
            }
            if (button.id === 'confirm-delete-button') {
                if (isLoading) { button.disabled = true; button.innerHTML = '<svg class="w-5 h-5 text-white animate-spin mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-loader"></use></svg>'; } 
                else { button.disabled = false; button.innerHTML = 'Delete'; }
                return;
            }
            if (button.id === 'generate-button') {
                const icon = button.querySelector('svg use');
                if (isLoading) {
                    button.disabled = false; 
                    button.classList.add('bg-red-600', 'hover:bg-red-700'); 
                    button.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                    if (icon) icon.setAttribute('href', '#icon-stop');
                    button.dataset.tooltip = "Cancel Generation";
                } else {
                    button.disabled = false;
                    button.classList.remove('bg-red-600', 'hover:bg-red-700');
                    button.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                    if (isEditingMode) {
                        if (icon) icon.setAttribute('href', '#icon-edit');
                        button.dataset.tooltip = "Apply Edit";
                    } else {
                        if (icon) icon.setAttribute('href', '#icon-send');
                        button.dataset.tooltip = "Generate";
                    }
                }
            } else {
                const icon = button.querySelector('svg');
                if (isLoading) { button.disabled = true; if (icon) icon.classList.add('animate-spin'); } 
                else { button.disabled = false; if (icon) icon.classList.remove('animate-spin'); }
            }
        }

        // --- D&D / Upload (v12„Å®Âêå„Åò) ---
        function handleDragOver(event) {
            event.preventDefault();
            if (generationInProgress || isEditingMode) return;
            imageDisplay.classList.add('drag-over');
        }
        function handleDragLeave(event) {
            event.preventDefault();
            imageDisplay.classList.remove('drag-over');
        }
        function handleDrop(event) {
            event.preventDefault();
            imageDisplay.classList.remove('drag-over');
            if (generationInProgress) return;
            const file = event.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) { readImageFile(file); } 
            else { showToast("Please drop an image file (PNG, JPG, etc.)", "warning"); }
        }
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) { readImageFile(file); }
            uploadImageInput.value = null; 
        }
        function readImageFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => { loadUploadedImage(e.target.result, "", false); };
            reader.onerror = (e) => { showToast("Failed to read image file.", "error"); };
            reader.readAsDataURL(file);
        }
        function loadUploadedImage(base64DataUrl, prompt = "", isSwitchingBase = false) {
            const rawBase64 = base64DataUrl.split(',')[1];
            currentEditImageBase64 = rawBase64; 
            if (!isSwitchingBase) {
                imageGridContainer.innerHTML = ''; 
                // ‚òÖ v13: „Éù„Éº„É™„É≥„Ç∞ÂÅúÊ≠¢
                stopAllPolling();
                const cardId = `image-card-base-${Date.now()}`;
                const card = createImageCard(cardId, "Base Image", false); // ‚òÖ v13
                imageGridContainer.appendChild(card);
                updateImageCard(cardId, base64DataUrl, prompt, prompt, rawBase64, null, false); 
                updatePlaceholderVisibility();
                updateGridColumns(); 
            }
            showToast("Image loaded. Ready to edit.", "info");
            if (prompt) { promptInput.value = prompt; } 
            else { promptInput.value = ""; }
        }
        
        // ‚òÖ v13: „Ç´„Éº„Éâ‰ΩúÊàê (BG„É¢„Éº„Éâ„ÅÆË°®Á§∫ÂàáÊõøËøΩÂä†)
        function createImageCard(cardId, modelName, isBGMode = false) {
            const card = document.createElement('div');
            card.id = cardId;
            card.className = "image-card flex flex-col"; 
            
            // ‚òÖ v13: BG„É¢„Éº„Éâ„ÅÆÊôÇ„ÅØ„ÄåQueued...„Äç„Å®Ë°®Á§∫
            const statusText = isBGMode ? "Queued for BG..." : "Generating...";

            card.innerHTML = `
                <div class="loading-spinner flex flex-col items-center justify-center text-gray-400 p-4 flex-1">
                    <svg class="w-10 h-10 text-indigo-400 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-loader"></use></svg>
                    <p class="mt-2 text-sm font-medium">${modelName}</p>
                    <p class="mt-1 text-xs text-gray-500">${statusText}</p>
                </div>
                
                <div class="relative w-full h-auto flex-1 group hidden">
                    <img src="" class="hidden max-w-full max-h-full object-contain rounded-lg mx-auto">
                    <div class="error-message hidden text-red-300 text-sm p-2 break-words max-h-full overflow-y-auto"></div>
                    <div class="image-overlay hidden absolute inset-0 bg-black/70 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2 p-2">
                        <button class="image-zoom-btn bg-gray-800 text-white p-2 rounded-full hover:bg-indigo-600" data-tooltip="Zoom">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-zoom-in"></use></svg>
                        </button>
                        <button class="image-edit-btn bg-gray-800 text-white p-2 rounded-full hover:bg-blue-600" data-tooltip="Use as Edit Base">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-edit"></use></svg>
                        </button>
                        <button class="image-blur-btn bg-gray-800 text-white p-2 rounded-full hover:bg-yellow-600" data-tooltip="Toggle Blur">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-eye-off"></use></svg>
                        </button>
                        <button class="image-close-btn bg-gray-800 text-white p-2 rounded-full hover:bg-red-600" data-tooltip="Remove">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-x"></use></svg>
                        </button>
                    </div>
                </div>
                <p class="model-name-display hidden text-xs text-gray-400 p-1 text-center w-full">${modelName}</p>
            `;
            return card;
        }

        // (v12„Å®Âêå„Åò)
        function updateImageCard(cardId, base64DataUrl, prompt, translatedPrompt, rawBase64, errorMsg = null, isPrivateMode = false) {
            const card = document.getElementById(cardId);
            if (!card) return;

            const spinner = card.querySelector('.loading-spinner');
            const imgContainer = card.querySelector('.relative.group'); 
            const img = card.querySelector('img');
            const errorDiv = card.querySelector('.error-message');
            const overlay = card.querySelector('.image-overlay');
            const modelNameDisplay = card.querySelector('.model-name-display'); 

            spinner.classList.add('hidden');
            imgContainer.classList.remove('hidden'); 

            if (errorMsg) {
                errorDiv.textContent = errorMsg;
                errorDiv.classList.remove('hidden');
                overlay.classList.remove('hidden');
                overlay.querySelector('.image-zoom-btn').style.display = 'none';
                overlay.querySelector('.image-edit-btn').style.display = 'none';
                overlay.querySelector('.image-blur-btn').style.display = 'none'; 
                card.classList.add('bg-red-900/50'); 
                modelNameDisplay.classList.remove('hidden');

            } else {
                img.src = base64DataUrl;
                img.classList.remove('hidden');
                overlay.classList.remove('hidden');
                modelNameDisplay.classList.remove('hidden');
                
                const zoomBtn = overlay.querySelector('.image-zoom-btn');
                zoomBtn.onclick = () => showImageInModal(base64DataUrl, prompt, translatedPrompt, rawBase64);

                const editBtn = overlay.querySelector('.image-edit-btn');
                if (rawBase64) {
                    editBtn.style.display = 'block';
                    editBtn.onclick = () => {
                        loadUploadedImage(base64DataUrl, prompt, true); 
                        toggleEditMode(true, ['gemini-2.5-flash-image-preview']); 
                    };
                } else {
                     editBtn.style.display = 'none';
                }

                const blurBtn = card.querySelector('.image-blur-btn');
                const blurIcon = blurBtn.querySelector('svg use');
                let isBlurred = isPrivateMode; 

                const updateBlurState = () => {
                    img.classList.toggle('image-blurred', isBlurred);
                    if (blurIcon) { blurIcon.setAttribute('href', isBlurred ? '#icon-eye' : '#icon-eye-off'); }
                    blurBtn.dataset.tooltip = isBlurred ? "Show Image" : "Blur Image";
                };
                updateBlurState(); 
                blurBtn.onclick = (e) => { e.stopPropagation(); isBlurred = !isBlurred; updateBlurState(); };
            }
            
            const closeBtn = overlay.querySelector('.image-close-btn');
            closeBtn.onclick = () => {
                card.remove();
                updatePlaceholderVisibility();
                updateGridColumns(); 
                // ‚òÖ v13: „Éù„Éº„É™„É≥„Ç∞‰∏≠„Å†„Å£„Åü„ÇâÂÅúÊ≠¢
                stopPolling(cardId);
            };
        }

    </script>
</body>
</html>
