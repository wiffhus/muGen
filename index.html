<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>muGen - AI Image Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Inter Font (Mac-like) */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        /* â˜… å¤‰æ›´: html, body ã« overscroll-behavior ã‚’è¨­å®š */
        html, body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none; /* ã‚¹ãƒ¯ã‚¤ãƒ—ã§ã®ã€Œæˆ»ã‚‹ã€ã‚„ã€Œæ›´æ–°ã€ã‚’ç„¡åŠ¹åŒ– */
        }

        /* Custom scrollbar for sidebar */
        .sidebar-scroll::-webkit-scrollbar {
            width: 4px;
        }
        .sidebar-scroll::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 4px;
        }
        .sidebar-scroll::-webkit-scrollbar-track {
            background-color: #1f2937;
        }

        /* Dynamic Noise Animation */
        .noise-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #111827;
            z-index: 10;
            display: none; /* Hidden by default */
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .noise-container.active {
            display: block;
            opacity: 1;
        }
        .noise-container::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 256 256'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
            background-size: 128px 128px;
            opacity: 0.15;
            animation: noise-animation 0.2s linear infinite;
        }
        @keyframes noise-animation {
            0% { transform: translate(0, 0); }
            10% { transform: translate(-5%, -5%); }
            20% { transform: translate(-10%, 5%); }
            30% { transform: translate(5%, -10%); }
            40% { transform: translate(-5%, 15%); }
            50% { transform: translate(-10%, -5%); }
            60% { transform: translate(15%, 0); }
            70% { transform: translate(0, 10%); }
            80% { transform: translate(-15%, 0); }
            90% { transform: translate(10%, 5%); }
            100% { transform: translate(5%, 0); }
        }

        /* Custom Checkbox */
        .style-checkbox:checked + label {
            background-color: #4f46e5;
            border-color: #4f46e5;
            color: #ffffff;
        }
        
        /* â˜… ä¾é ¼â‘¡ãƒ»â‘¢: ãƒ¢ãƒ‡ãƒ«é¸æŠã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ç”¨ */
        .model-checkbox:checked + label {
            background-color: #3730a3; /* Indigo 800 */
            border-color: #4f46e5; /* Indigo 600 */
            color: #ffffff;
            font-weight: 500;
        }


        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            inset: 0;
            overflow-y: auto;
            background-color: rgba(0, 0, 0, 0.7);
            align-items: center;
            justify-content: center;
        }
        .modal.flex {
            display: flex;
        }
        
        /* â˜… è¿½åŠ : èªè¨¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã¯ z-index ã‚’æœ€ä¸Šä½(60)ã« */
        #auth-modal {
            z-index: 60;
        }

        /* â˜… ä¾é ¼: ãƒ¢ãƒ¼ãƒ€ãƒ«ç”»åƒã®ãƒ©ãƒƒãƒ‘ãƒ¼ */
        #modal-image-wrapper {
            transition: all 0.3s ease;
        }
        
        /* â˜… ä¾é ¼: ãƒ¢ãƒ¼ãƒ€ãƒ«ç”»åƒã®ã‚ºãƒ¼ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        #modal-image {
            transition: transform 0.2s ease-out;
            /* ã‚ºãƒ¼ãƒ æ™‚ã«ãƒ”ã‚¯ã‚»ãƒ«ãŒã¼ã‚„ã‘ãªã„ã‚ˆã†ã«ã™ã‚‹ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã«ã‚ˆã‚‹ï¼‰ */
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            /* ã‚ºãƒ¼ãƒ ã®åŸºç‚¹ã‚’å·¦ä¸Šã«ã™ã‚‹ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¨é€£å‹•ã•ã›ã‚‹ãŸã‚ï¼‰ */
            transform-origin: top left;
        }


        /* Tooltip */
        [data-tooltip] {
            position: relative;
        }
        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #1f2937;
            color: #ffffff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 60;
            opacity: 1;
            transition: opacity 0.2s;
        }

        /* Chevron rotation for accordion */
        .rotate-180 {
            transform: rotate(180deg);
        }

        /* â˜… Drag over effect */
        .drag-over {
            border-style: dashed;
            border-color: #4f46e5;
            background-color: #1f2937;
        }

        /* â˜… è¿½åŠ : History Marquee */
        .history-info-container {
            width: 100%;
            overflow: hidden;
            white-space: nowrap;
            position: absolute;
            bottom: 0;
            left: 0;
            background: rgba(0, 0, 0, 0.7);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none; /* ä¸‹ã®ç”»åƒã‚’ã‚¯ãƒªãƒƒã‚¯ã§ãã‚‹ã‚ˆã†ã« */
        }
        .group:hover .history-info-container {
            opacity: 1;
        }
        .history-info-text-wrapper {
            display: inline-block;
            white-space: nowrap;
            /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã¯é•·ã‚ã®æ™‚é–“ (25ç§’) ã«è¨­å®š */
            animation: marquee 25s linear infinite;
        }
        .history-info-text {
            display: inline-block;
            padding: 4px 12px; /* å·¦å³ã«ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */
            color: white;
            font-size: 10px;
        }
        
        @keyframes marquee {
            0%   { transform: translateX(0); }
            /* ãƒ†ã‚­ã‚¹ãƒˆ2å›åˆ†ã®åŠåˆ†ã‚’å‹•ã‹ã™ */
            100% { transform: translateX(-50%); } 
        }

        /* â˜… å¤‰æ›´: ãƒˆãƒ¼ã‚¹ãƒˆ/ã‚¨ãƒ©ãƒ¼è¡¨ç¤º */
        #toast {
            max-width: 400px;
            word-break: break-word;
        }
        
        /* â˜… ä¾é ¼â‘¡ãƒ»â‘¢: ã‚°ãƒªãƒƒãƒ‰ã®ã‚«ãƒ¼ãƒ‰ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯” */
        .image-card {
            position: relative;
            background-color: #374151; /* gray-700 */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem; /* p-2 */
            text-align: center;
            overflow: hidden;
            /* ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ 1:1 ã«å›ºå®š */
            aspect-ratio: 1 / 1;
        }


    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen w-screen flex">

    <svg width="0" height="0" class="hidden">
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-menu">
            <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line>
        </symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-x">
            <line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>
        </symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" id="icon-translate">
            <polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/>
        </symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-send">
            <line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" id="icon-stop">
            <circle cx="12" cy="12" r="10"></circle><rect x="9" y="9" width="6" height="6"></rect>
        </symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-image">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline>
        </symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-edit">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
        </symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-copy">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
        </symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-refresh">
            <polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
        </symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-loader">
            <line x1="12" y1="2" x2="12" y2="6"></line><line x1="12" y1="18" x2="12" y2="22"></line><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line><line x1="2" y1="12" x2="6" y2="12"></line><line x1="18" y1="12" x2="22" y2="12"></line><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line>
        </symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" id="icon-chevron-down">
             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" id="icon-upload">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line>
        </symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" id="icon-x-circle">
            <circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line>
        </symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" id="icon-lock">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
        </symbol>
        
        <symbol xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" id="icon-zoom-in">
            <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line>
        </symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" id="icon-zoom-out">
            <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="8" y1="11" x2="14" y2="11"></line>
        </symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" id="icon-zoom-reset">
            <path d="M3 2v6h6"></path><path d="M21 12A9 9 0 0 0 6 5.3L3 8"></path><path d="M21 22v-6h-6"></path><path d="M3 12a9 9 0 0 0 15 6.7l3-2.7"></path>
        </symbol>
    </svg>

    <aside id="sidebar" class="bg-gray-800 h-screen w-64 p-4 flex flex-col flex-shrink-0 fixed z-30 transition-transform duration-300 ease-in-out -translate-x-full md:translate-x-0">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-xl font-bold text-white">muGen History</h1>
            <button id="close-sidebar" class="md:hidden text-gray-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-x"></use></svg>
            </button>
        </div>
        
        <div id="history-stats" class="mb-4 p-3 bg-gray-700 rounded-lg">
            <div class="flex justify-between text-sm">
                <span class="text-gray-300">Total Images:</span>
                <span id="stats-total-images" class="font-medium text-white">0</span>
            </div>
            <div class="flex justify-between text-sm mt-1">
                <span class="text-gray-300">Est. Cost (USD):</span>
                <span id="stats-cost-usd" class="font-medium text-white">$0.00</span>
            </div>
            <div class="flex justify-between text-sm mt-1">
                <span class="text-gray-300">Est. Cost (JPY):</span>
                <span id="stats-cost-jpy" class="font-medium text-white">Â¥0</span>
            </div>
        </div>

        <div id="history-container" class="flex-1 overflow-y-auto sidebar-scroll space-y-2">
            <p class="text-gray-400 text-sm">No generated images yet.</p>
        </div>
    </aside>

    <main id="main-content" class="flex-1 flex flex-col transition-all duration-300 ease-in-out md:ml-64 min-h-screen">
        
        <header class="flex-shrink-0 bg-gray-900/70 backdrop-blur-sm h-16 flex items-center px-6 shadow-md z-20">
            <button id="sidebar-toggle-button" class="text-gray-400 hover:text-white mr-4" data-tooltip="Toggle History">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-menu"></use></svg>
            </button>
            <div class="flex items-center space-x-2">
                <svg class="w-6 h-6 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-image"></use></svg>
                <span class="text-lg font-semibold text-white">muGen Image Generator</span>
            </div>
            <div class="flex space-x-2 ml-4">
                <div class="w-3 h-3 rounded-full bg-gray-700"></div>
                <div class="w-3 h-3 rounded-full bg-gray-700"></div>
                <div class="w-3 h-3 rounded-full bg-gray-700"></div>
            </div>
        </header>

        <div id="image-container" class="flex-1 flex items-center justify-center p-4 md:p-8 relative overflow-hidden">
            <div id="image-display" class="w-full h-full flex items-center justify-center bg-gray-800 rounded-lg shadow-inner relative border-2 border-transparent transition-all overflow-auto p-4"> <div id="image-grid-container" class="w-full h-full grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    </div>
        
                <div id="placeholder" class="text-gray-500 flex-col items-center justify-center p-8 text-center absolute inset-0 flex"> <svg class="w-24 h-24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-image"></use></svg>
                    <p class="mt-2">Your generated image(s) will appear here</p>
                    <p class="text-sm mt-4">or</p>
                    <button id="upload-image-button" type="button" class="mt-4 flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-lg transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-upload"></use></svg>
                        Upload Image to Edit
                    </button>
                    <input type="file" id="upload-image-input" class="hidden" accept="image/png, image/jpeg, image/webp">
                    <p class="text-xs text-gray-600 mt-2">You can also drag & drop an image here</p>
                </div>

                <div id="loading-animation" class="noise-container">
                    <div class="absolute inset-0 flex items-center justify-center">
                        <svg class="w-12 h-12 text-indigo-400 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-loader"></use></svg>
                    </div>
                </div>
                
                </div>
        </div>

        <footer id="prompt-footer" class="p-4 md:p-6 bg-gray-800/50 backdrop-blur-sm z-10 fixed bottom-0 w-full md:left-64 transition-all duration-300 ease-in-out">
            <form id="generation-form" class="max-w-4xl mx-auto">
                <div class="flex flex-wrap gap-4 mb-4" id="options-toolbar">
                    
                    <div id="model-select-group" class="w-full md:w-auto relative"> <button type="button" id="models-toggle" class="flex justify-between items-center w-full p-2.5 rounded-lg bg-gray-700 border border-gray-600 hover:bg-gray-600 transition">
                            <label class="block text-sm font-medium text-white cursor-pointer">Models (Multiple)</label>
                            <svg id="models-chevron" class="w-5 h-5 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <use href="#icon-chevron-down"></use>
                            </svg>
                        </button>
                        <div id="models-container" class="hidden max-h-48 overflow-y-auto flex flex-col gap-1 p-2 bg-gray-900/80 backdrop-blur-sm border border-gray-700 rounded-lg mt-1">
                            </div>
                    </div>
                    <div id="aspect-ratio-group">
                        <label for="aspect-ratio-select" class="block text-sm font-medium text-gray-300 mb-1">Aspect Ratio</label>
                        <select id="aspect-ratio-select" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5">
                            <option value="1:1">1:1 Square</option>
                            <option value="16:9">16:9 Landscape</option>
                            <option value="9:16">9:16 Portrait</option>
                            <option value="4:3">4:3 Standard</option>
                            <option value="3:2">3:2 Photo</option>
                        </select>
                    </div>
                    <div id="auto-retry-group">
                        <label for="auto-retry-select" class="block text-sm font-medium text-gray-300 mb-1">Auto Retry</label>
                        <select id="auto-retry-select" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5">
                            <option value="0">Off</option>
                            <option value="5">5 Times</option>
                            <option value="10">10 Times</option>
                            <option value="50">50 Times</option>
                            <option value="-1">Custom...</option>
                        </select>
                    </div>
                    
                    <div id="edit-with-flash-group" class="flex items-end gap-2"> <button type="button" id="edit-with-flash-button" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-2.5 px-4 rounded-lg transition flex items-center gap-2" data-tooltip="Switch to Edit Mode with Gemini 2.5 Flash">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-edit"></use></svg>
                            Edit with 2.5 flash
                        </button>
                        <button type="button" id="edit-with-flash-2-0-button" class="bg-cyan-600 hover:bg-cyan-700 text-white text-sm font-medium py-2.5 px-4 rounded-lg transition flex items-center gap-2" data-tooltip="Switch to Edit Mode with Gemini 2.0 Flash">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-edit"></use></svg>
                            Edit with 2.0 flash
                        </button>
                    </div>
                </div>

                <div class="mb-4">
                    <button type="button" id="styles-toggle" class="flex justify-between items-center w-full p-2 rounded-lg hover:bg-gray-700 transition">
                        <label class="block text-sm font-medium text-gray-300 cursor-pointer">Styles (Optional, multiple)</label>
                        <svg id="styles-chevron" class="w-5 h-5 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <use href="#icon-chevron-down"></use>
                        </svg>
                    </button>
                    <div id="styles-container" class="hidden max-h-48 overflow-y-auto flex flex-wrap gap-2 p-3 bg-gray-700/50 rounded-lg mt-2">
                        </div>
                </div>

                <div id="edit-mode-indicator" class="hidden text-center text-indigo-300 text-sm font-medium p-2 bg-indigo-900/50 rounded-lg mt-3">
                    ğŸ¨ Editing Mode - Subsequent generations will edit the current image. (Change model to Imagen 3.0 to exit)
                </div>

                <div class="relative mt-4">
                    <textarea id="prompt-input" rows="2" class="block w-full p-4 pr-48 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:ring-indigo-500 focus:border-indigo-500 resize-none" placeholder="Enter your prompt... (Non-English will be translated)"></textarea>
                    
                    <div class="absolute bottom-3 right-32 flex space-x-2">
                         <button id="prompt-copy-button" type="button" class="p-2 bg-gray-600 text-gray-400 rounded-lg hover:bg-gray-500 hover:text-gray-200 transition" data-tooltip="Copy Prompt">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-copy"></use></svg>
                        </button>
                         <button id="prompt-clear-button" type="button" class="p-2 bg-gray-600 text-gray-400 rounded-lg hover:bg-gray-500 hover:text-gray-200 transition" data-tooltip="Clear Input">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-x-circle"></use></svg>
                        </button>
                    </div>

                    <div class="absolute bottom-3 right-3 flex space-x-2">
                        <button id="translate-button" type="button" class="p-2 bg-gray-600 text-gray-300 rounded-lg hover:bg-gray-500 transition" data-tooltip="Translate to English">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-translate"></use></svg>
                        </button>
                        <button id="generate-button" type="submit" class="p-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition" data-tooltip="Generate">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-send"></use></svg>
                        </button>
                    </div>
                </div>
            </form>
        </footer>
    </main>

    <div id="image-modal" class="modal">
        <div class="bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-6xl max-h-[95vh] flex flex-col p-4">
            
            <div id="modal-image-wrapper" class="flex-1 flex items-center justify-center overflow-auto bg-gray-900/50 rounded-lg min-h-[50vh] mb-4">
                <img id="modal-image" src="" class="max-w-full max-h-full object-contain">
            </div>

            <div class="bg-gray-900 rounded-b-lg p-4">
                <p class="text-sm text-gray-300 mb-2">Prompt:</p>
                <p id="modal-prompt" class="text-white bg-gray-700 p-3 rounded-lg max-h-24 overflow-y-auto"></p>
                
                <div class="flex flex-wrap gap-4 mt-4">
                    <button id="modal-copy" class="flex items-center space-x-2 bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-lg transition" data-tooltip="Copy Prompt">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-copy"></use></svg>
                        <span>Copy</span>
                    </button>
                    <button id="modal-regenerate" class="flex items-center space-x-2 bg-gray-600 hover:bg-gray-500 text-white py-2 px-4 rounded-lg transition" data-tooltip="Regenerate Image">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-refresh"></use></svg>
                        <span>Regenerate</span>
                    </button>
                    <button id="modal-edit" class="flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition" data-tooltip="Load this image for editing">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-edit"></use></svg>
                        <span>Edit</span>
                    </button>
                    
                    <div class="flex items-center gap-2 ml-auto">
                        <button id="modal-zoom-out" class="flex items-center space-x-2 bg-gray-700 hover:bg-gray-600 text-white p-2.5 rounded-lg transition" data-tooltip="Zoom Out">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-zoom-out"></use></svg>
                        </button>
                        <button id="modal-zoom-in" class="flex items-center space-x-2 bg-gray-700 hover:bg-gray-600 text-white p-2.5 rounded-lg transition" data-tooltip="Zoom In">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-zoom-in"></use></svg>
                        </button>
                        <button id="modal-zoom-reset" class="flex items-center space-x-2 bg-gray-700 hover:bg-gray-600 text-white p-2.5 rounded-lg transition" data-tooltip="Reset Zoom">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-zoom-reset"></use></svg>
                        </button>
                    </div>

                </div>
            </div>
            <button id="modal-close" class="absolute top-4 right-4 text-gray-400 hover:text-white bg-gray-800/50 rounded-full p-1">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-x"></use></svg>
            </button>
        </div>
    </div>

    <div id="toast" class="fixed top-20 right-6 text-white py-3 px-4 rounded-lg shadow-lg transition-all duration-300 opacity-0 -translate-y-10 z-50">
        <div class="flex items-start justify-between">
            <p id="toast-message" class="flex-1 pr-4">Message</p>
            <div class="flex flex-col space-y-1">
                <button id="toast-close" class="text-white hover:text-gray-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-x"></use></svg>
                </button>
                <button id="toast-copy" class="hidden text-white hover:text-gray-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-copy"></use></svg>
                </button>
            </div>
        </div>
    </div>
    
    <div id="auth-modal" class="modal flex"> <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6">
            <div class="flex items-center justify-center mb-4">
                <svg class="w-8 h-8 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-lock"></use></svg>
                <h2 class="text-xl font-bold text-white ml-2">Authentication Required</h2>
            </div>
            <p class="text-gray-400 text-center text-sm mb-4">Please enter the password to access muGen.</p>
            <form id="auth-form">
                <input type="password" id="auth-password" class="block w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Password" required>
                <p id="auth-error" class="text-red-400 text-sm mt-2 hidden"></p>
                <button id="auth-submit" type="submit" class="w-full mt-4 p-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-medium">
                    Login
                </button>
            </form>
        </div>
    </div>


    <script>
        // --- CONSTANTS & STATE ---
        const STYLES = [
            "Photorealistic", "Cinematic", "35mm film", "Black and white", "Impressionistic",
            "Surrealism", "Watercolour", "Ukiyo-e", "Cyberpunk", "Steampunk",
            "Fantasy art", "Minimalism", "Animation", "Ghibli-style", "Disney-style"
        ];
        
        // â˜… ä¾é ¼â‘£: ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ«ç”¨
        const CUSTOM_STYLES_KEY = 'muGenCustomStyles';

        // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ (ä¾é ¼â‘ ãƒ»â‘¡ãƒ»â‘¢) â˜…â˜…â˜…
        // â˜… è¿½åŠ : ãƒ¢ãƒ‡ãƒ«å®šç¾© (ä¾é ¼â‘ å«ã‚€)
        const MODELS = {
            // Imagen
            "imagen-4.0-ultra-generate-preview-06-06": { name: "Imagen 4.0 Ultra", type: "imagen" },
            "imagen-4.0-generate-preview-06-06": { name: "Imagen 4.0", type: "imagen" },
            "imagen-4.0-fast-generate-001": { name: "Imagen 4.0 Fast", type: "imagen" }, // â˜… ä¾é ¼â‘ 
            "imagen-3.0-generate": { name: "Imagen 3.0", type: "imagen" },
            // Gemini (Edit)
            "gemini-2.5-flash-image-preview": { name: "Gemini 2.5 Flash Image", type: "gemini-edit" },
            "gemini-2.0-flash-preview-image-generation": { name: "Gemini 2.0 Flash Image", type: "gemini-edit" }
        };

        // â˜… ä¾é ¼â‘ : æ–™é‡‘å®šç¾©ã«è¿½åŠ  (Fast ã¯ 3.0/4.0 ã¨åŒã˜ã¨ä»®å®š)
        const PRICE_IMAGEN_USD = 0.02; // Imagen 3.0 / 4.0 / 4.0 Fast (ä»®)
        const PRICE_GEMINI_FLASH_IMAGE_USD = 0.002; // Gemini Flash Image (ä»®)
        const PRICE_GEMINI_FLASH_IMAGE_2_0_USD = 0.002; // Gemini 2.0 (ä»®)
        const USD_JPY_RATE = 150; // ä»®ã®ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆ

        let db;
        let apiKeyCounter = 0; 
        let currentEditImageBase64 = null; 
        let isEditingMode = false;
        let lastEnterPress = 0; 
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        // â˜… å¤‰æ›´: ç”Ÿæˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ç”¨ (ä¾é ¼â‘¡ãƒ»â‘¢)
        let generationInProgress = false; // â˜… å…¨ä½“ã®ç”Ÿæˆå‡¦ç†ãŒå®Ÿè¡Œä¸­ã‹
        let runningGenerations = new Set(); // â˜… å®Ÿè¡Œä¸­ã®å€‹åˆ¥ãƒ¢ãƒ‡ãƒ«IDã‚’ç®¡ç†
        let currentFetchController = null;
        
        // â˜… è¿½åŠ : ãƒˆãƒ¼ã‚¹ãƒˆã®ã‚¿ã‚¤ãƒãƒ¼
        let toastTimeoutId = null;
        
        // â˜… è¿½åŠ : ã‚¹ãƒ¯ã‚¤ãƒ—æ¤œå‡ºç”¨
        let touchStartX = 0;
        let touchStartY = 0;
        let touchMoveX = 0;

        // â˜… ä¾é ¼: ã‚ºãƒ¼ãƒ ç”¨
        let modalZoomLevel = 1.0;
        const MAX_ZOOM = 10;
        const MIN_ZOOM = 0.5;
        // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ã“ã“ã¾ã§ â˜…â˜…â˜…


        // --- DOM ELEMENTS ---
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('main-content');
        // â˜… å¤‰æ›´: ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³
        const sidebarToggleButton = document.getElementById('sidebar-toggle-button');
        const closeSidebarBtn = document.getElementById('close-sidebar');
        
        // â˜… è¿½åŠ : ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ç”¨
        const imageContainer = document.getElementById('image-container');
        const promptFooter = document.getElementById('prompt-footer');

        const generationForm = document.getElementById('generation-form');
        const promptInput = document.getElementById('prompt-input');
        const translateButton = document.getElementById('translate-button');
        const generateButton = document.getElementById('generate-button');
        // â˜… è¿½åŠ : ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒœã‚¿ãƒ³
        const promptCopyButton = document.getElementById('prompt-copy-button');
        const promptClearButton = document.getElementById('prompt-clear-button');

        const loadingAnimation = document.getElementById('loading-animation');
        const imageDisplay = document.getElementById('image-display');
        
        // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ (ä¾é ¼â‘¡ãƒ»â‘¢) â˜…â˜…â˜…
        // â˜… å‰Šé™¤ (å˜ä¸€ç”»åƒç”¨)
        // const generatedImage = document.getElementById('generated-image');
        // â˜… è¿½åŠ  (è¤‡æ•°ç”»åƒã‚°ãƒªãƒƒãƒ‰)
        const imageGridContainer = document.getElementById('image-grid-container');
        // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ã“ã“ã¾ã§ â˜…â˜…â˜…

        const placeholder = document.getElementById('placeholder');
        const historyContainer = document.getElementById('history-container');
        
        // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ (ä¾é ¼â‘ ãƒ»â‘¡ãƒ»â‘¢) â˜…â˜…â˜…
        // â˜… å‰Šé™¤
        // const modelSelect = document.getElementById('model-select');
        // â˜… è¿½åŠ  (ãƒ¢ãƒ‡ãƒ«é¸æŠã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³)
        const modelsToggleBtn = document.getElementById('models-toggle');
        const modelsContainer = document.getElementById('models-container');
        const modelsChevron = document.getElementById('models-chevron');
        // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ã“ã“ã¾ã§ â˜…â˜…â˜…
        
        const aspectRatioSelect = document.getElementById('aspect-ratio-select');
        const autoRetrySelect = document.getElementById('auto-retry-select');
        
        const imageModal = document.getElementById('image-modal');
        const modalImage = document.getElementById('modal-image');
        const modalPrompt = document.getElementById('modal-prompt');
        const modalCopy = document.getElementById('modal-copy');
        const modalRegenerate = document.getElementById('modal-regenerate');
        const modalClose = document.getElementById('modal-close');
        const modalEdit = document.getElementById('modal-edit'); // â˜… è¿½åŠ 
        
        // â˜… ä¾é ¼: ã‚ºãƒ¼ãƒ ç”¨DOM
        const modalImageWrapper = document.getElementById('modal-image-wrapper');
        const modalZoomIn = document.getElementById('modal-zoom-in');
        const modalZoomOut = document.getElementById('modal-zoom-out');
        const modalZoomReset = document.getElementById('modal-zoom-reset');

        // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ (ä¾é ¼â‘¡ãƒ»â‘¢) â˜…â˜…â˜…
        // â˜… å‰Šé™¤ (å˜ä¸€ç”»åƒç”¨)
        // const editButton = document.getElementById('edit-button');
        // const closeImageButton = document.getElementById('close-image-button'); // â˜… å‰Šé™¤
        // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ã“ã“ã¾ã§ â˜…â˜…â˜…
        
        const optionsToolbar = document.getElementById('options-toolbar');

        // â˜… å¤‰æ›´: ãƒ„ãƒ¼ãƒ«ãƒãƒ¼å†…ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å–å¾—
        const modelSelectGroup = document.getElementById('model-select-group');
        const aspectRatioGroup = document.getElementById('aspect-ratio-group');
        const autoRetryGroup = document.getElementById('auto-retry-group');

        // â˜… ä¾é ¼â‘ : Edit ãƒœã‚¿ãƒ³
        const editWithFlashButton = document.getElementById('edit-with-flash-button');
        const editWithFlash20Button = document.getElementById('edit-with-flash-2-0-button'); // â˜… è¿½åŠ 

        // â˜… Styles Accordion Elements
        const stylesToggleBtn = document.getElementById('styles-toggle');
        const stylesContainer = document.getElementById('styles-container');
        const stylesChevron = document.getElementById('styles-chevron');

        // â˜… History Stats Elements
        const statsTotalImages = document.getElementById('stats-total-images');
        const statsCostUsd = document.getElementById('stats-cost-usd');
        const statsCostJpy = document.getElementById('stats-cost-jpy');

        // â˜… Upload Elements
        const uploadImageButton = document.getElementById('upload-image-button');
        const uploadImageInput = document.getElementById('upload-image-input');

        // â˜… è¿½åŠ : ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼
        const editModeIndicator = document.getElementById('edit-mode-indicator');
        
        // â˜… å¤‰æ›´: ãƒˆãƒ¼ã‚¹ãƒˆ
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        const toastClose = document.getElementById('toast-close');
        const toastCopy = document.getElementById('toast-copy');

        // â˜… è¿½åŠ : èªè¨¼ãƒ¢ãƒ¼ãƒ€ãƒ«
        const authModal = document.getElementById('auth-modal');
        const authForm = document.getElementById('auth-form');
        const authPassword = document.getElementById('auth-password');
        const authSubmit = document.getElementById('auth-submit');
        const authError = document.getElementById('auth-error');


        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // â˜… èªè¨¼ãƒã‚§ãƒƒã‚¯ã‚’æœ€åˆã«è¡Œã†
            checkAuth(); 
            
            initDB();
            initSidebar();
            initStyles(); // â˜… ä¾é ¼â‘£: å¤‰æ›´ã‚ã‚Š
            // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ (ä¾é ¼â‘ ãƒ»â‘¡ãƒ»â‘¢) â˜…â˜…â˜…
            initModels(); // â˜… è¿½åŠ 
            // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ã“ã“ã¾ã§ â˜…â˜…â˜…
            initListeners(); // â˜… ä¾é ¼â‘ : å¤‰æ›´ã‚ã‚Š
            loadHistory();
            
            // â˜… è¿½åŠ : ãƒ•ãƒƒã‚¿ãƒ¼ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã®åˆæœŸè¨­å®š
            adjustMainContentPadding();
            // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ (ä¾é ¼â‘¡ãƒ»â‘¢) â˜…â˜…â˜…
            updatePlaceholderVisibility(); // â˜… è¿½åŠ 
            // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ã“ã“ã¾ã§ â˜…â˜…â˜…
        });

        // --- â˜… è¿½åŠ : AUTHENTICATION ---
        
        /**
         * ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€æœªèªè¨¼ãªã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
         */
        function checkAuth() {
            if (sessionStorage.getItem('muGenAuthenticated') === 'true') {
                authModal.classList.remove('flex'); // èªè¨¼æ¸ˆã¿ãªã‚‰éè¡¨ç¤º
            } else {
                authModal.classList.add('flex'); // æœªèªè¨¼ãªã‚‰è¡¨ç¤º
            }
        }
        
        /**
         * ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡ãƒãƒ³ãƒ‰ãƒ©
         */
        async function handleAuthSubmit(event) {
            event.preventDefault();
            const password = authPassword.value;
            if (!password) return;

            setLoading(authSubmit, true); // ãƒœã‚¿ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã«
            authError.classList.add('hidden');

            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'auth',
                        password: password
                    })
                });

                if (response.ok) {
                    sessionStorage.setItem('muGenAuthenticated', 'true');
                    authModal.classList.remove('flex');
                    showToast("Authentication successful!", "success");
                } else {
                    const data = await response.json();
                    throw new Error(data.error || "Authentication failed");
                }
            } catch (error) {
                console.error("Auth error:", error);
                authError.textContent = error.message;
                authError.classList.remove('hidden');
                showToast(error.message, "error");
            } finally {
                setLoading(authSubmit, false);
            }
        }

        // --- â˜… ä¾é ¼â‘£: CUSTOM STYLE FUNCTIONS ---
    
        /**
         * localStorage ã‹ã‚‰ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å–å¾—
         * @returns {string[]}
         */
        function getCustomStyles() {
            try {
                const styles = localStorage.getItem(CUSTOM_STYLES_KEY);
                return styles ? JSON.parse(styles) : [];
            } catch (e) {
                console.error("Failed to parse custom styles:", e);
                return [];
            }
        }
        
        /**
         * localStorage ã«ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ä¿å­˜
         * @param {string[]} stylesArray
         */
        function saveCustomStyles(stylesArray) {
            try {
                localStorage.setItem(CUSTOM_STYLES_KEY, JSON.stringify(stylesArray));
            } catch (e) {
                console.error("Failed to save custom styles:", e);
                showToast("Failed to save custom style", "error");
            }
        }
        
        /**
         * ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ ã™ã‚‹
         */
        function handleAddCustomStyle() {
            const newStyle = prompt("Enter new style name (e.g., 'Pixel art', 'Anime'):");
            if (newStyle && newStyle.trim().length > 0) {
                const trimmedStyle = newStyle.trim();
                const customStyles = getCustomStyles();
                
                // é‡è¤‡ãƒã‚§ãƒƒã‚¯ (STYLES ã¨ customStyles ã®ä¸¡æ–¹)
                const allStyles = [...STYLES, ...customStyles];
                if (allStyles.map(s => s.toLowerCase()).includes(trimmedStyle.toLowerCase())) {
                    showToast(`Style "${trimmedStyle}" already exists.`, "warning");
                    return;
                }
                
                customStyles.push(trimmedStyle);
                saveCustomStyles(customStyles);
                initStyles(); // ã‚¹ã‚¿ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’å†æç”»
                showToast(`Style "${trimmedStyle}" added.`, "success");
            }
        }
        
        /**
         * ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å‰Šé™¤ã™ã‚‹
         * @param {string} styleToRemove
         */
        function handleRemoveCustomStyle(styleToRemove) {
            let customStyles = getCustomStyles();
            customStyles = customStyles.filter(s => s !== styleToRemove);
            saveCustomStyles(customStyles);
            initStyles(); // ã‚¹ã‚¿ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’å†æç”»
            showToast(`Style "${styleToRemove}" removed.`, "success");
        }


        // --- (Omitted: IndexedDB functions for brevity) ---
        function initDB() {
            const request = indexedDB.open("muGenDB", 1);

            request.onerror = (event) => {
                console.error("IndexedDB error:", event.target.errorCode);
                showToast("Database error. History may not work.", "error");
            };

            request.onupgradeneeded = (event) => {
                db = event.target.result;
                const objectStore = db.createObjectStore("images", { keyPath: "id", autoIncrement: true });
                objectStore.createIndex("timestamp", "timestamp", { unique: false });
                objectStore.createIndex("prompt", "prompt", { unique: false });
                // â˜… è¿½åŠ : ãƒ¢ãƒ‡ãƒ«æƒ…å ±ã‚’ä¿å­˜ã™ã‚‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
                objectStore.createIndex("model", "model", { unique: false });
                // â˜… è¿½åŠ : ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã¨ã‚¹ã‚¿ã‚¤ãƒ«
                objectStore.createIndex("aspectRatio", "aspectRatio", { unique: false });
                objectStore.createIndex("styles", "styles", { unique: false });
            };

            request.onsuccess = (event) => {
                db = event.target.result;
                console.log("IndexedDB initialized.");
            };
        }

        // â˜… å¤‰æ›´: ãƒ¢ãƒ‡ãƒ«æƒ…å ±ã€ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã€ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ä¿å­˜
        function saveImageToDB(prompt, translatedPrompt, base64Data, model, aspectRatio, styles) {
            if (!db) return;
            const transaction = db.transaction(["images"], "readwrite");
            const objectStore = transaction.objectStore("images");
            const newItem = {
                prompt: prompt,
                translatedPrompt: translatedPrompt,
                base64: base64Data,
                timestamp: new Date().getTime(),
                model: model, // â˜… ãƒ¢ãƒ‡ãƒ«æƒ…å ±ã‚’ä¿å­˜
                aspectRatio: aspectRatio, // â˜… ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ä¿å­˜
                styles: styles // â˜… ã‚¹ã‚¿ã‚¤ãƒ«(é…åˆ—)ã‚’ä¿å­˜
            };
            const request = objectStore.add(newItem);

            request.onsuccess = () => {
                console.log("Image saved to DB");
                loadHistory(); // Refresh history
            };
            request.onerror = (event) => {
                console.error("Error saving to DB:", event.target.error);
                if (event.target.error.name === 'QuotaExceededError') {
                    showToast("History storage is full. Clearing old entries...", "warning");
                    clearOldHistory();
                }
            };
        }

        // â˜… å¤‰æ›´: çµ±è¨ˆæƒ…å ±ã‚’è¨ˆç®—ã—ã¦è¡¨ç¤º + ãƒãƒ¼ã‚­ãƒ¼æƒ…å ±
        function loadHistory() {
            if (!db) return;
            const transaction = db.transaction(["images"], "readonly");
            const objectStore = transaction.objectStore("images");
            const index = objectStore.index("timestamp");
            const request = index.getAll(null, 500); // å±¥æ­´ã®æœ€å¤§æ•°ã‚’å¢—ã‚„ã™ (500)

            request.onsuccess = () => {
                const items = request.result.reverse(); // Newest first
                historyContainer.innerHTML = "";
                
                let totalCostUSD = 0;
                
                if (items.length === 0) {
                    historyContainer.innerHTML = '<p class="text-gray-400 text-sm">No generated images yet.</p>';
                } else {
                    items.forEach(item => {
                        const div = document.createElement('div');
                        div.className = "cursor-pointer rounded-lg overflow-hidden relative group";
                        
                        // â˜… å¤‰æ›´: Historyé …ç›®ã«ãƒãƒ¼ã‚­ãƒ¼æƒ…å ±ã¨ç·¨é›†ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
                        
                        // è¡¨ç¤ºã™ã‚‹æƒ…å ±ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½œæˆ
                        let infoParts = [
                            `[P] ${item.prompt || ''}`,
                            `[M] ${item.model || 'unknown'}`,
                            `[A] ${item.aspectRatio || 'N/A'}`
                        ];
                        if (item.styles && item.styles.length > 0) {
                            infoParts.push(`[S] ${item.styles.join(', ')}`);
                        }
                        // ãƒ†ã‚­ã‚¹ãƒˆã‚’åŒºåˆ‡ã‚Šæ–‡å­—ã§é€£çµ (HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã¯ä¸è¦ã€innerHTMLã§è§£é‡ˆã•ã‚Œã‚‹)
                        const infoText = infoParts.join(' &nbsp;&nbsp;|&nbsp;&nbsp; ');

                        div.innerHTML = `
                            <img src="${item.base64}" alt="History thumbnail" class="w-full h-auto object-cover">
                            
                            <div class="absolute inset-0 bg-black/70 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center p-2">
                                <button class="text-xs bg-blue-600 hover:bg-blue-700 text-white py-1 px-2 rounded" data-base64="${item.base64.split(',')[1]}" data-prompt="${item.prompt}">
                                    Edit
                                </button>
                            </div>

                            <div class="history-info-container">
                                <div class="history-info-text-wrapper">
                                    <span class="history-info-text">${infoText}</span>
                                    <span class="history-info-text">${infoText}</span> </div>
                            </div>
                        `;
                        
                        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã (æ©Ÿèƒ½3)
                        div.querySelector('img').addEventListener('click', () => showImageInModal(item.base64, item.prompt, item.translatedPrompt, item.base64.split(',')[1]));
                        
                        // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ (ä¾é ¼â‘¡ãƒ»â‘¢) â˜…â˜…â˜…
                        // Historyã®Editãƒœã‚¿ãƒ³ (å‹•ä½œå¤‰æ›´)
                        div.querySelector('button').addEventListener('click', (e) => {
                            e.stopPropagation(); // è¦ªã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«ã•ã›ãªã„
                            const base64 = e.currentTarget.dataset.base64;
                            const prompt = e.currentTarget.dataset.prompt;
                            // â˜… å¤‰æ›´: å±¥æ­´ç”»åƒã¯ã‚°ãƒªãƒƒãƒ‰ã‚’ã‚¯ãƒªã‚¢ã—ã¦èª­ã¿è¾¼ã‚€
                            loadUploadedImage(`data:image/png;base64,${base64}`, prompt, false);
                        });
                        // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ã“ã“ã¾ã§ â˜…â˜…â˜…

                        historyContainer.appendChild(div);

                        // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ (ä¾é ¼â‘ ) â˜…â˜…â˜…
                        // â˜… æ–™é‡‘è¨ˆç®— (Imagen 4.0 Fast ã‚’è¿½åŠ )
                        if (item.model === 'imagen-3.0-generate' || // æ—¢å­˜ (å¤ã„å½¢å¼)
                            item.model === 'imagen-4.0-generate-preview-06-06' || 
                            item.model === 'imagen-4.0-ultra-generate-preview-06-06' ||
                            item.model === 'imagen-4.0-fast-generate-001') // â˜… è¿½åŠ 
                        {
                            totalCostUSD += PRICE_IMAGEN_USD;
                        } else if (item.model === 'gemini-2.5-flash-image-preview') {
                            totalCostUSD += PRICE_GEMINI_FLASH_IMAGE_USD;
                        } else if (item.model === 'gemini-2.0-flash-preview-image-generation') { 
                            totalCostUSD += PRICE_GEMINI_FLASH_IMAGE_2_0_USD;
                        } else {
                            // ãƒ¢ãƒ‡ãƒ«æƒ…å ±ãŒãªã„å¤ã„ãƒ‡ãƒ¼ã‚¿ (ä»®ã«Imagenæ‰±ã„)
                            // æ—¢å­˜ã® 'imagen-3.0-generate-002' ã‚‚ã“ã“ã«å…¥ã‚‹ (PRICE_IMAGEN_USD)
                            totalCostUSD += PRICE_IMAGEN_USD;
                        }
                        // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ã“ã“ã¾ã§ â˜…â˜…â˜…
                    });
                }

                // â˜… çµ±è¨ˆè¡¨ç¤ºã‚’æ›´æ–°
                statsTotalImages.textContent = items.length;
                statsCostUsd.textContent = `$${totalCostUSD.toFixed(3)}`; // å°æ•°ç‚¹ä»¥ä¸‹3æ¡
                statsCostJpy.textContent = `Â¥${Math.round(totalCostUSD * USD_JPY_RATE)}`;
            };
        }
        
        function clearOldHistory() {
            if (!db) return;
            const transaction = db.transaction(["images"], "readwrite");
            const objectStore = transaction.objectStore("images");
            objectStore.clear().onsuccess = () => {
                showToast("Old history cleared.", "success");
                loadHistory();
            };
        }

        // --- UI INITIALIZATION ---

        // â˜… å¤‰æ›´: ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒˆã‚°ãƒ«ãƒ­ã‚¸ãƒƒã‚¯ (PC/ã‚¹ãƒãƒ›å…±é€š) + ãƒ•ãƒƒã‚¿ãƒ¼ä½ç½®åˆ¶å¾¡
        function initSidebar() {
            sidebarToggleButton.addEventListener('click', toggleSidebar);
            closeSidebarBtn.addEventListener('click', () => toggleSidebar(false)); // ã‚¹ãƒãƒ›ç”¨ã¯å¼·åˆ¶çš„ã«é–‰ã˜ã‚‹
        }

        /**
         * â˜… æ–°è¦: ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®é–‹é–‰ã‚’åˆ¶å¾¡ã™ã‚‹é–¢æ•°
         * @param {boolean} [forceOpen] - æŒ‡å®šã™ã‚‹ã¨çŠ¶æ…‹ã‚’å¼·åˆ¶ (true=é–‹, false=é–‰)
         */
        function toggleSidebar(forceOpen) {
            // ã‚µã‚¤ãƒ‰ãƒãƒ¼ãŒé–‹ã„ã¦ã„ã‚‹ã‹ (translate-x-full ãŒ *ãªã„* ã‹)
            const isSidebarOpen = !sidebar.classList.contains('-translate-x-full');
            
            let shouldBeOpen;
            if (forceOpen === true) {
                shouldBeOpen = true;
            } else if (forceOpen === false) {
                shouldBeOpen = false;
            } else {
                shouldBeOpen = !isSidebarOpen; // æŒ‡å®šãŒãªã‘ã‚Œã°ãƒˆã‚°ãƒ«
            }

            if (!shouldBeOpen) {
                // é–‰ã˜ã‚‹
                sidebar.classList.add('-translate-x-full');
                sidebar.classList.remove('md:translate-x-0'); // PCç”¨ã®è¡¨ç¤ºã‚¯ãƒ©ã‚¹ã‚‚å‰Šé™¤
                mainContent.classList.remove('md:ml-64'); // PCç”¨ã®ãƒãƒ¼ã‚¸ãƒ³å‰Šé™¤
                // â˜… ãƒ•ãƒƒã‚¿ãƒ¼ã®ä½ç½®ã‚’å·¦ç«¯ã«æˆ»ã™
                promptFooter.classList.remove('md:left-64'); 
            } else {
                // é–‹ã
                sidebar.classList.remove('-translate-x-full');
                sidebar.classList.add('md:translate-x-0'); // PCç”¨ã®è¡¨ç¤ºã‚¯ãƒ©ã‚¹è¿½åŠ 
                mainContent.classList.add('md:ml-64'); // PCç”¨ã®ãƒãƒ¼ã‚¸ãƒ³è¿½åŠ 
                // â˜… ãƒ•ãƒƒã‚¿ãƒ¼ã®ä½ç½®ã‚’ã‚µã‚¤ãƒ‰ãƒãƒ¼åˆ†ãšã‚‰ã™
                promptFooter.classList.add('md:left-64'); 
            }
        }

        // â˜… ä¾é ¼â‘£: initStyles ã‚’å¤§å¹…ã«å¤‰æ›´ (ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ«å¯¾å¿œ)
        function initStyles() {
            const container = document.getElementById('styles-container');
            container.innerHTML = ""; // æ—¢å­˜ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ã‚¯ãƒªã‚¢
        
            const allStyles = [...STYLES, ...getCustomStyles()];
        
            allStyles.forEach(style => {
                const isCustom = !STYLES.includes(style); // ã“ã‚ŒãŒã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ«ã‹ï¼Ÿ
                
                const div = document.createElement('div');
                // â˜… ä¾é ¼â‘£: ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ«ç”¨ã®ã‚³ãƒ³ãƒ†ãƒŠï¼ˆå‰Šé™¤ãƒœã‚¿ãƒ³ã‚’å«ã‚€ãŸã‚ï¼‰
                div.className = "flex items-center gap-1"; 
                
                const inputId = `style-${style.replace(/[^a-zA-Z0-9]/g, '-')}`; // IDã®ã‚µãƒ‹ã‚¿ã‚¤ã‚º
        
                let labelClass = "cursor-pointer bg-gray-700 text-gray-300 border border-gray-600 rounded-full px-4 py-2 text-sm font-medium hover:bg-gray-600 transition";
                
                // â˜… ä¾é ¼â‘£: ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ«ã¯è‰²ã‚’å¤‰ãˆã€ä¸¸ã¿ã‚’èª¿æ•´
                if (isCustom) {
                     labelClass = "cursor-pointer bg-teal-800 text-teal-100 border border-teal-600 rounded-l-full px-4 py-2 text-sm font-medium hover:bg-teal-700 transition";
                }
        
                div.innerHTML = `
                    <input type="checkbox" id="${inputId}" value="${style}" class="hidden style-checkbox">
                    <label for="${inputId}" class="${labelClass}">
                        ${style}
                    </label>
                `;
                
                // â˜… ä¾é ¼â‘£: ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ«ãªã‚‰å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
                if (isCustom) {
                    const removeBtn = document.createElement('button');
                    removeBtn.type = "button";
                    removeBtn.className = "bg-teal-800 text-teal-200 border border-teal-600 border-l-0 rounded-r-full py-2 px-2 text-sm font-medium hover:bg-red-700 hover:text-white transition";
                    removeBtn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-x"></use></svg>`;
                    removeBtn.dataset.tooltip = "Remove style";
                    removeBtn.onclick = (e) => {
                        e.stopPropagation(); // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å‹•ä½œã‚’æ­¢ã‚ã‚‹
                        handleRemoveCustomStyle(style);
                    };
                    div.appendChild(removeBtn);
                }
                
                container.appendChild(div);
            });
        
            // â˜… ä¾é ¼â‘£: æœ€å¾Œã«ã€Œ+ã€ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
            const addBtnContainer = document.createElement('div');
            addBtnContainer.innerHTML = `
                <button type="button" id="add-style-button" class="cursor-pointer bg-gray-600 text-gray-300 border border-gray-500 rounded-full px-4 py-2 text-sm font-medium hover:bg-indigo-600 hover:text-white transition flex items-center gap-1" data-tooltip="Add custom style">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    Add
                </button>
            `;
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            addBtnContainer.querySelector('#add-style-button').addEventListener('click', handleAddCustomStyle);
            container.appendChild(addBtnContainer);
        }

        // --- EVENT LISTENERS ---
        // â˜… ä¾é ¼: ã‚ºãƒ¼ãƒ ãƒªã‚¹ãƒŠãƒ¼è¿½åŠ 
        // â˜… ä¿®æ­£: 2.0 ãƒœã‚¿ãƒ³ã®ãƒªã‚¹ãƒŠãƒ¼è¿½åŠ 
        // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ (ä¾é ¼â‘ ãƒ»â‘¡ãƒ»â‘¢) â˜…â˜…â˜…
        function initListeners() {
            // â˜… èªè¨¼ãƒ•ã‚©ãƒ¼ãƒ 
            authForm.addEventListener('submit', handleAuthSubmit);

            generationForm.addEventListener('submit', handleGenerationSubmit); // â˜… å¤‰æ›´ã‚ã‚Š
            translateButton.addEventListener('click', handleTranslate);
            
            // â˜… è¿½åŠ : ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒœã‚¿ãƒ³ãƒªã‚¹ãƒŠãƒ¼
            promptCopyButton.addEventListener('click', handlePromptCopy);
            promptClearButton.addEventListener('click', handlePromptClear);
            
            // â˜… è¿½åŠ  (ãƒ¢ãƒ‡ãƒ«é¸æŠã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³)
            modelsToggleBtn.addEventListener('click', () => toggleModelsAccordion());
            
            modalClose.addEventListener('click', () => imageModal.classList.remove('flex'));
            modalCopy.addEventListener('click', handleModalCopy);
            modalRegenerate.addEventListener('click', handleModalRegenerate);
            modalEdit.addEventListener('click', handleModalEdit); // â˜… å¤‰æ›´ã‚ã‚Š

            // â˜… ä¾é ¼: ã‚ºãƒ¼ãƒ ãƒœã‚¿ãƒ³ãƒªã‚¹ãƒŠãƒ¼
            modalZoomIn.addEventListener('click', handleZoomIn);
            modalZoomOut.addEventListener('click', handleZoomOut);
            modalZoomReset.addEventListener('click', handleZoomReset);
            
            // â˜… å¤‰æ›´: editButton (2.5) ã¨ editWithFlash20Button (2.0) ã®å‹•ä½œ
            editWithFlashButton.addEventListener('click', () => toggleEditMode(true, ['gemini-2.5-flash-image-preview'])); // â˜… ä¿®æ­£ (é…åˆ—ã§æ¸¡ã™)
            editWithFlash20Button.addEventListener('click', () => toggleEditMode(true, ['gemini-2.0-flash-preview-image-generation'])); // â˜… ä¿®æ­£ (é…åˆ—ã§æ¸¡ã™)
            
            // â˜… å‰Šé™¤
            // editButton.addEventListener('click', ...);
            // closeImageButton.addEventListener('click', ...); 
            
            // â˜… è¿½åŠ : ãƒˆãƒ¼ã‚¹ãƒˆãƒœã‚¿ãƒ³
            toastClose.addEventListener('click', () => hideToast());
            toastCopy.addEventListener('click', () => copyToastMessage());

            // â˜… å‰Šé™¤
            // modelSelect.addEventListener('change', ...);
            
            autoRetrySelect.addEventListener('change', () => {
                if(autoRetrySelect.value === '-1') {
                    const customRetry = prompt("Enter number of retries:", "100");
                    if (customRetry && !isNaN(parseInt(customRetry))) {
                        const val = parseInt(customRetry);
                        const newOption = new Option(`${val} Times (Custom)`, val, true, true);
                        autoRetrySelect.add(newOption);
                    } else {
                        autoRetrySelect.value = '0'; // Reset
                    }
                }
            });

            stylesToggleBtn.addEventListener('click', toggleStylesAccordion);
            promptInput.addEventListener('keydown', handlePromptKeydown);

            // â˜… è¿½åŠ : ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ãƒªã‚¹ãƒŠãƒ¼
            imageDisplay.addEventListener('dragover', handleDragOver);
            imageDisplay.addEventListener('dragleave', handleDragLeave);
            imageDisplay.addEventListener('drop', handleDrop);

            // â˜… è¿½åŠ : ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒªã‚¹ãƒŠãƒ¼
            uploadImageButton.addEventListener('click', () => uploadImageInput.click());
            uploadImageInput.addEventListener('change', handleFileSelect);

            // â˜… è¿½åŠ : ã‚¹ãƒãƒ›ç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ãƒªã‚¹ãƒŠãƒ¼
            window.addEventListener('resize', adjustMainContentPadding);

            // â˜… è¿½åŠ : ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            document.addEventListener('touchstart', handleTouchStart, { passive: true });
            document.addEventListener('touchmove', handleTouchMove, { passive: true });
            document.addEventListener('touchend', handleTouchEnd, { passive: true });
        }
        // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ã“ã“ã¾ã§ â˜…â˜…â˜…
        
        
        // --- â˜… è¿½åŠ : LAYOUT ADJUSTMENT ---
        
        /**
         * ãƒ•ãƒƒã‚¿ãƒ¼ã®é«˜ã•ã‚’è¨ˆç®—ã—ã€ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ä¸‹éƒ¨ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã«è¨­å®š
         */
        function adjustMainContentPadding() {
            if (promptFooter && imageContainer) {
                const footerHeight = promptFooter.offsetHeight;
                imageContainer.style.paddingBottom = `${footerHeight + 20}px`; // ãƒ•ãƒƒã‚¿ãƒ¼ã®é«˜ã• +Î±
            }
        }
        
        // --- â˜… è¿½åŠ : SWIPE HANDLERS ---
        
        function handleTouchStart(event) {
            // èªè¨¼ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºä¸­ã¯ã‚¹ãƒ¯ã‚¤ãƒ—ç„¡åŠ¹
            if (authModal.classList.contains('flex')) return;

            const firstTouch = event.touches[0];
            touchStartX = firstTouch.clientX;
            touchStartY = firstTouch.clientY;
            touchMoveX = firstTouch.clientX; // ç§»å‹•é‡ãƒªã‚»ãƒƒãƒˆ
        }

        function handleTouchMove(event) {
            if (authModal.classList.contains('flex')) return;
            // Yè»¸ã®ç§»å‹•ãŒå¤§ãã„å ´åˆã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¨ã¿ãªã—ã€ã‚¹ãƒ¯ã‚¤ãƒ—å‡¦ç†ã‚’ä¸­æ–­
            if (Math.abs(event.touches[0].clientX - touchStartX) < Math.abs(event.touches[0].clientY - touchStartY)) {
                touchStartX = 0; // ã‚¹ãƒ¯ã‚¤ãƒ—é–‹å§‹ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ
                return;
            }
            touchMoveX = event.touches[0].clientX;
        }

        function handleTouchEnd() {
            if (authModal.classList.contains('flex')) return;
            if (touchStartX === 0) return; // ã‚¹ãƒ¯ã‚¤ãƒ—é–‹å§‹ã•ã‚Œã¦ã„ãªã„

            const deltaX = touchMoveX - touchStartX;
            const isSidebarOpen = !sidebar.classList.contains('-translate-x-full');

            // 1. é–‹ã: å·¦ç«¯ (30px) ã‹ã‚‰ å³ (100pxä»¥ä¸Š) ã¸ã‚¹ãƒ¯ã‚¤ãƒ—
            if (isMobile && !isSidebarOpen && touchStartX < 30 && deltaX > 100) {
                toggleSidebar(true); // é–‹ã
            }
            // 2. é–‰ã˜ã‚‹: ã‚µã‚¤ãƒ‰ãƒãƒ¼ãŒé–‹ã„ã¦ã„ã‚‹ã¨ãã« å·¦ (-100pxä»¥ä¸Š) ã¸ã‚¹ãƒ¯ã‚¤ãƒ—
            else if (isMobile && isSidebarOpen && deltaX < -100) {
                toggleSidebar(false); // é–‰ã˜ã‚‹
            }
            
            // ãƒªã‚»ãƒƒãƒˆ
            touchStartX = 0;
            touchStartY = 0;
            touchMoveX = 0;
        }


        // --- CORE LOGIC ---

        // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ (ä¾é ¼â‘ ãƒ»â‘¡ãƒ»â‘¢) â˜…â˜…â˜…
        /**
         * â˜… æ–°è¦: ãƒ¢ãƒ‡ãƒ«é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’åˆæœŸåŒ– (ä¾é ¼â‘ ãƒ»â‘¡ãƒ»â‘¢)
         */
        function initModels() {
            modelsContainer.innerHTML = ""; // ã‚¯ãƒªã‚¢
        
            // MODELS å®šæ•°ã‹ã‚‰ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ç”Ÿæˆ
            for (const [modelId, modelInfo] of Object.entries(MODELS)) {
                const inputId = `model-${modelId}`;
                
                let labelClass = "cursor-pointer text-gray-300 hover:bg-gray-700 p-2 rounded-md flex items-center border border-transparent";
                let modelTypeIcon = "";

                if (modelInfo.type === 'imagen') {
                    modelTypeIcon = `<svg class="w-4 h-4 mr-2 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-image"></use></svg>`;
                } else if (modelInfo.type === 'gemini-edit') {
                    modelTypeIcon = `<svg class="w-4 h-4 mr-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-edit"></use></svg>`;
                }

                const div = document.createElement('div');
                div.innerHTML = `
                    <input type="checkbox" id="${inputId}" value="${modelId}" data-type="${modelInfo.type}" class="hidden model-checkbox">
                    <label for="${inputId}" class="${labelClass}">
                        ${modelTypeIcon}
                        ${modelInfo.name}
                    </label>
                `;
                modelsContainer.appendChild(div);

                // â˜… ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹å¤‰æ›´æ™‚ã«UIã‚’æ›´æ–°ã™ã‚‹ãƒªã‚¹ãƒŠãƒ¼
                div.querySelector('input').addEventListener('change', handleModelSelectionChange);
            }

            // â˜… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ Imagen 4.0 Fast ã‚’é¸æŠ (ä¾é ¼â‘ )
            const defaultModel = document.getElementById('model-imagen-4.0-fast-generate-001');
            if (defaultModel) {
                defaultModel.checked = true;
            }
            
            // â˜… ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã®å¤–å´ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰é–‰ã˜ã‚‹ (ãƒ¢ãƒ‡ãƒ«é¸æŠã‚°ãƒ«ãƒ¼ãƒ—è‡ªä½“ã¯é™¤ã)
            document.addEventListener('click', (e) => {
                if (!modelSelectGroup.contains(e.target) && !modelsContainer.classList.contains('hidden')) {
                    toggleModelsAccordion(false); // å¼·åˆ¶çš„ã«é–‰ã˜ã‚‹
                }
            });
            
            // â˜… åˆæœŸçŠ¶æ…‹ã®ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã‚’æ›´æ–°
            updateToolbarForSelection();
        }

        /**
         * â˜… æ–°è¦: ãƒ¢ãƒ‡ãƒ«é¸æŠã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã‚’é–‹é–‰
         */
        function toggleModelsAccordion(forceOpen) {
            const isOpen = !modelsContainer.classList.contains('hidden');
            let shouldBeOpen;
            
            if (forceOpen === true) shouldBeOpen = true;
            else if (forceOpen === false) shouldBeOpen = false;
            else shouldBeOpen = !isOpen;

            if (shouldBeOpen) {
                modelsContainer.classList.remove('hidden');
                modelsChevron.classList.add('rotate-180');
            } else {
                modelsContainer.classList.add('hidden');
                modelsChevron.classList.remove('rotate-180');
            }
            
            // â˜… è¿½åŠ : ãƒ•ãƒƒã‚¿ãƒ¼ã®é«˜ã•ãŒå¤‰ã‚ã‚‹ã®ã§ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å†èª¿æ•´
            setTimeout(adjustMainContentPadding, 100); 
        }

        /**
         * â˜… æ–°è¦: ãƒ¢ãƒ‡ãƒ«é¸æŠãŒå¤‰æ›´ã•ã‚ŒãŸã¨ãã®UIåˆ¶å¾¡
         */
        function handleModelSelectionChange() {
            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ãªã„å ´åˆã€é¸æŠçŠ¶æ…‹ã«å¿œã˜ã¦UI (ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ãªã©) ã‚’åˆ¶å¾¡
            if (!isEditingMode) {
                updateToolbarForSelection();
            }
        }

        /**
         * â˜… æ–°è¦: é¸æŠä¸­ã®ãƒ¢ãƒ‡ãƒ«ã«å¿œã˜ã¦ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ (Aspect Ratio, Styles) ã‚’åˆ¶å¾¡
         */
        function updateToolbarForSelection() {
            const selectedModels = getSelectedModels();
            
            // 1ã¤ã§ã‚‚ Imagen ç³»ãŒé¸ã°ã‚Œã¦ã„ã‚Œã°ã€Aspect Ratio ã¨ Styles ã‚’è¡¨ç¤º
            const hasImagen = selectedModels.some(modelId => MODELS[modelId]?.type === 'imagen');
            
            if (hasImagen) {
                aspectRatioGroup.style.display = 'block';
                stylesToggleBtn.style.display = 'flex'; // button ã¯ flex
            } else {
                // Imagen ç³»ãŒ0ä»¶ (Geminiç³»ã®ã¿) ã®å ´åˆã€éè¡¨ç¤º
                aspectRatioGroup.style.display = 'none';
                stylesToggleBtn.style.display = 'none';
            }

            // ãƒ•ãƒƒã‚¿ãƒ¼ã®é«˜ã•ãŒå¤‰ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å†èª¿æ•´
            setTimeout(adjustMainContentPadding, 100);
        }
        
        /**
         * â˜… æ–°è¦: é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒ¢ãƒ‡ãƒ«IDã®é…åˆ—ã‚’å–å¾—
         * @returns {string[]}
         */
        function getSelectedModels() {
             return Array.from(document.querySelectorAll('.model-checkbox:checked')).map(cb => cb.value);
        }

        /**
         * â˜… æ–°è¦: ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ¶å¾¡
         */
        function updatePlaceholderVisibility() {
            if (imageGridContainer.children.length > 0) {
                placeholder.style.display = 'none';
            } else {
                placeholder.style.display = 'flex';
            }
        }
        // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ã“ã“ã¾ã§ â˜…â˜…â˜…


        function toggleStylesAccordion() {
            stylesContainer.classList.toggle('hidden');
            stylesChevron.classList.toggle('rotate-180');
            
            // â˜… è¿½åŠ : ãƒ•ãƒƒã‚¿ãƒ¼ã®é«˜ã•ãŒå¤‰ã‚ã‚‹ã®ã§ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å†èª¿æ•´
            setTimeout(adjustMainContentPadding, 100);
        }

        function handlePromptKeydown(event) {
            if (isMobile) {
                // â˜… ãƒ¢ãƒã‚¤ãƒ«ã®å ´åˆ: Shift+Enter ã§æ”¹è¡Œã€Enterã®ã¿ã§é€ä¿¡
                if (event.key === 'Enter' && !event.shiftKey) {
                     event.preventDefault();
                     handleGenerationSubmit(new Event('submit'));
                }
                return;
            }
            // PC (ãƒ€ãƒ–ãƒ«ã‚¨ãƒ³ã‚¿ãƒ¼)
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault(); 
                const now = new Date().getTime();

                if (now - lastEnterPress < 500) {
                    handleGenerationSubmit(new Event('submit'));
                    lastEnterPress = 0; 
                } else {
                    lastEnterPress = now;
                    showToast("Press Enter again to send", "info"); 
                    setTimeout(() => {
                        if (lastEnterPress === now) {
                            lastEnterPress = 0;
                        }
                    }, 500); 
                }
            } else if (event.key !== 'Enter') {
                lastEnterPress = 0;
            }
        }

        // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ (ä¾é ¼â‘¡ãƒ»â‘¢) â˜…â˜…â˜…
        /**
         * â˜… å¤‰æ›´: ã‚°ãƒªãƒƒãƒ‰ã‚’ã‚¯ãƒªã‚¢ã—ã€ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’è§£é™¤ã™ã‚‹
         */
        function clearImageGrid() {
            imageGridContainer.innerHTML = '';
            currentEditImageBase64 = null;
            if (isEditingMode) {
                toggleEditMode(false);
            }
            updatePlaceholderVisibility(); // â˜… ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼è¡¨ç¤º
        }
        // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ã“ã“ã¾ã§ â˜…â˜…â˜…

        // â˜… å¤‰æ›´: ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼åˆ¶å¾¡ + ãƒ„ãƒ¼ãƒ«ãƒãƒ¼åˆ¶å¾¡
        // â˜… ä¾é ¼â‘¡: autoRetryGroup ã®éè¡¨ç¤ºã‚’è§£é™¤
        // â˜… ä¿®æ­£: å¼•æ•° model ã‚’è¿½åŠ  (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ 2.5)
        // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ (ä¾é ¼â‘¢) â˜…â˜…â˜…
        /**
         * â˜… å¤‰æ›´: ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®åˆ¶å¾¡ (ä¾é ¼â‘¢)
         * @param {boolean} forceOn - ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’å¼·åˆ¶çš„ã«ON/OFF
         * @param {string[]} [modelsToSelect] - ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ONæ™‚ã«è‡ªå‹•é¸æŠã™ã‚‹ãƒ¢ãƒ‡ãƒ«ID (e.g., 2.5 or 2.0)
         */
        function toggleEditMode(forceOn, modelsToSelect = []) { 
            isEditingMode = forceOn;
            
            // å…¨ãƒ¢ãƒ‡ãƒ«ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’é…åˆ—åŒ–
            const allModelCheckboxes = Array.from(document.querySelectorAll('.model-checkbox'));

            if (isEditingMode) {
                if (!currentEditImageBase64) {
                    showToast("No image to edit. Generate or upload an image first.", "warning");
                    isEditingMode = false;
                    return;
                }
                
                promptInput.placeholder = "Enter edit instructions (e.g., 'make the sky blue')...";
                
                // â˜… ãƒ„ãƒ¼ãƒ«ãƒãƒ¼åˆ¶å¾¡
                optionsToolbar.style.display = 'flex';
                // â˜… ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ã¯ãƒ¢ãƒ‡ãƒ«é¸æŠ(ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³)ã¯è¡¨ç¤ºã™ã‚‹ãŒã€ä¸­èº«ã‚’ 2.5 ã¨ 2.0 ã®ã¿ã«çµã‚‹
                modelsToggleBtn.style.display = 'block';
                autoRetryGroup.style.display = 'block';
                aspectRatioGroup.style.display = 'none'; // Geminiã¯ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”éå¯¾å¿œ
                stylesToggleBtn.style.display = 'none'; // Geminiã¯ã‚¹ã‚¿ã‚¤ãƒ«éå¯¾å¿œ
                
                // â˜… ãƒ¢ãƒ‡ãƒ«é¸æŠã®ä¸­èº«ã‚’ 2.5 ã¨ 2.0 ã®ã¿ã«çµã‚Šè¾¼ã¿
                allModelCheckboxes.forEach(cb => {
                    const modelType = cb.dataset.type;
                    if (modelType === 'gemini-edit') {
                        cb.parentElement.style.display = 'block'; // ãƒ©ãƒ™ãƒ«ã®è¦ª (div) ã‚’è¡¨ç¤º
                        // è‡ªå‹•é¸æŠ
                        if (modelsToSelect.includes(cb.value)) {
                            cb.checked = true;
                        } else {
                            // â˜… ä¾é ¼â‘¢: è¤‡æ•°é¸æŠå¯èƒ½ã«ã™ã‚‹ãŸã‚ã€è‡ªå‹•é¸æŠä»¥å¤–ã¯ãã®ã¾ã¾
                             cb.checked = false; // -> è‡ªå‹•é¸æŠã—ãªã‹ã£ãŸã‚‚ã®ã¯OFF
                        }
                    } else {
                        cb.parentElement.style.display = 'none'; // Imagenç³»ã¯éè¡¨ç¤º
                        cb.checked = false; // ãƒã‚§ãƒƒã‚¯ã‚‚å¤–ã™
                    }
                });

                imageDisplay.classList.add('ring-4', 'ring-indigo-500');
                if (!stylesContainer.classList.contains('hidden')) {
                    toggleStylesAccordion();
                }
                
                editModeIndicator.textContent = `ğŸ¨ Editing Mode (Gemini 2.0 / 2.5) - Select models to use for editing.`;
                editModeIndicator.classList.remove('hidden');
            } else {
                // --- ç·¨é›†ãƒ¢ãƒ¼ãƒ‰è§£é™¤ ---
                promptInput.placeholder = "Enter your prompt... (Non-English will be translated)";
                
                // â˜… ãƒ„ãƒ¼ãƒ«ãƒãƒ¼é …ç›®ã‚’å…¨ã¦è¡¨ç¤º (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)
                optionsToolbar.style.display = 'flex';
                modelsToggleBtn.style.display = 'block';
                autoRetryGroup.style.display = 'block';
                // (Aspect/Styles ã¯ updateToolbarForSelection ã§åˆ¶å¾¡ã•ã‚Œã‚‹)

                // â˜… ãƒ¢ãƒ‡ãƒ«é¸æŠã®ä¸­èº«ã‚’å…ƒã«æˆ»ã™ (å…¨ã¦è¡¨ç¤º)
                let defaultModelChecked = false;
                allModelCheckboxes.forEach(cb => {
                    cb.parentElement.style.display = 'block';
                    // â˜… Imagen 4.0 Fast ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ONã«æˆ»ã™
                    if (cb.value === 'imagen-4.0-fast-generate-001') {
                         cb.checked = true;
                         defaultModelChecked = true;
                    } else {
                         cb.checked = false;
                    }
                });
                // 4.0 Fast ãŒãªã„ï¼ˆå¤ã„ï¼‰å ´åˆã€Imagen 3.0 ã‚’ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                if (!defaultModelChecked && document.getElementById('model-imagen-3.0-generate')) {
                     document.getElementById('model-imagen-3.0-generate').checked = true;
                }

                imageDisplay.classList.remove('ring-4', 'ring-indigo-500');
                editModeIndicator.classList.add('hidden');
            }
            
            // â˜… é¸æŠçŠ¶æ…‹ã«å¿œã˜ã¦ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã‚’æ›´æ–°
            updateToolbarForSelection();
            setLoading(generateButton, false); // ãƒœã‚¿ãƒ³ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ›´æ–°
            setTimeout(adjustMainContentPadding, 100);
        }
        // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ã“ã“ã¾ã§ â˜…â˜…â˜…

        async function handleTranslate() {
            // ... (å¤‰æ›´ãªã—)
            const prompt = promptInput.value;
            if (!prompt) {
                showToast("Please enter text to translate", "warning");
                return;
            }
            setLoading(translateButton, true);
            try {
                // â˜… å¤‰æ›´: ç¿»è¨³ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç”¨ã® AbortController
                const controller = new AbortController();
                // ç¿»è¨³ãƒœã‚¿ãƒ³è‡ªä½“ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¯èƒ½ã«ã¯ã—ãªã„ãŒã€ä¸‡ãŒä¸€ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç”¨
                const timeoutId = setTimeout(() => controller.abort(), 100000); 

                const response = await fetchWithRetry('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'translate',
                        prompt: prompt
                    })
                }, 0, controller.signal); // ãƒªãƒˆãƒ©ã‚¤ãªã—ã€signalã‚ã‚Š

                clearTimeout(timeoutId); // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè§£é™¤

                const data = await response.json();
                if (response.ok) {
                    promptInput.value = data.translatedPrompt;
                    showToast("Translation successful", "success");
                } else {
                    throw new Error(data.error || "Translation failed");
                }
            } catch (error) {
                console.error("Translate error:", error);
                if (error.name !== 'AbortError') {
                    showToast(error.message, "error");
                } else {
                    showToast("Translation timed out.", "error");
                }
            } finally {
                setLoading(translateButton, false);
            }
        }

        // â˜… å¤‰æ›´: ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ©Ÿèƒ½ + ã‚¨ãƒ©ãƒ¼æ™‚ã®GASé€ä¿¡
        // â˜… ä¾é ¼â‘¢: ã‚¹ã‚¿ã‚¤ãƒ«ã®ã¿ç·¨é›†ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’åæ˜ 
        // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ (ä¾é ¼â‘¡ãƒ»â‘¢) â˜…â˜…â˜…
        /**
         * â˜… å¤‰æ›´: è¤‡æ•°ãƒ¢ãƒ‡ãƒ«ã®ä¸¦åˆ—ç”Ÿæˆ (ä¾é ¼â‘¡ãƒ»â‘¢)
         */
        async function handleGenerationSubmit(event) {
            if (event) event.preventDefault(); 
            
            // â˜… ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ­ã‚¸ãƒƒã‚¯ (å¤‰æ›´)
            if (generationInProgress) {
                if (currentFetchController) {
                    currentFetchController.abort(); // å…¨ã¦ã®å®Ÿè¡Œä¸­ãƒ•ã‚§ãƒƒãƒã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    showToast("All generations cancelled", "info");
                }
                // ãƒªã‚»ãƒƒãƒˆã¯ finally ã§
                return;
            }

            const prompt = promptInput.value;
            const selectedStyles = Array.from(document.querySelectorAll('.style-checkbox:checked')).map(cb => cb.value);
            let finalPrompt = prompt;

            // â˜… å¤‰æ›´: é¸æŠã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã‚’å–å¾—
            const selectedModels = getSelectedModels();

            if (selectedModels.length === 0) {
                showToast("Please select at least one model", "warning");
                return;
            }

            if (isEditingMode && !prompt && selectedStyles.length > 0) {
                // (ã“ã®ãƒ­ã‚¸ãƒƒã‚¯ã¯ Gemini (ç·¨é›†ãƒ¢ãƒ¼ãƒ‰) ã§ã¯ä¸è¦ã ãŒã€ã‚³ãƒ¼ãƒ‰ã‚’æµç”¨)
                finalPrompt = `Apply the following style(s): ${selectedStyles.join(', ')}`;
            } else if (!prompt) {
                showToast("Please enter a prompt", "warning");
                return;
            }
            
            if (isEditingMode && !currentEditImageBase64) {
                 showToast("No image loaded for editing.", "warning");
                 toggleEditMode(false);
                 return;
            }
            
            // â˜… å¤‰æ›´: ç·¨é›†ãƒ¢ãƒ¼ãƒ‰æ™‚ã¯ã€ãƒ™ãƒ¼ã‚¹ç”»åƒã‚’ã‚°ãƒªãƒƒãƒ‰ã‹ã‚‰å‰Šé™¤
            if (isEditingMode) {
                imageGridContainer.innerHTML = '';
            } else {
                // â˜… é€šå¸¸ç”Ÿæˆæ™‚ã‚‚ã€å¤ã„çµæœã‚’ã‚¯ãƒªã‚¢
                imageGridContainer.innerHTML = '';
            }

            generationInProgress = true;
            runningGenerations.clear(); // å®Ÿè¡Œä¸­ã‚»ãƒƒãƒˆã‚’ã‚¯ãƒªã‚¢
            currentFetchController = new AbortController();
            setLoading(generateButton, true); // Stopã‚¢ã‚¤ã‚³ãƒ³
            
            // â˜… å…¨ä½“ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¯ä½¿ã‚ãªã„
            // loadingAnimation.classList.add('active');
            
            updatePlaceholderVisibility(); // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’éš ã™ (ã“ã‚Œã‹ã‚‰è¦ç´ ãŒå…¥ã‚‹ãŸã‚)

            const retryCount = parseInt(autoRetrySelect.value, 10);
            const generationPromises = [];

            // â˜… ä¾é ¼â‘¡ãƒ»â‘¢: é¸æŠã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã”ã¨ã«å‡¦ç†
            for (const modelId of selectedModels) {
                apiKeyCounter++;
                const modelInfo = MODELS[modelId];

                // 1. UIã«ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
                const cardId = `image-card-${modelId}-${apiKeyCounter}`; // IDã‚’ãƒ¦ãƒ‹ãƒ¼ã‚¯ã«
                const card = createImageCard(cardId, modelInfo.name);
                imageGridContainer.appendChild(card);

                // Geminiç³»(ç·¨é›†ãƒ¢ãƒ¼ãƒ‰/é€šå¸¸ç”Ÿæˆå•ã‚ãš)
                const isGeminiJob = modelInfo.type === 'gemini-edit';
                // Imagenç³»
                const isImagenJob = modelInfo.type === 'imagen';

                const payload = {
                    action: isImagenJob ? 'generate' : 'edit', // Imagenã¯'generate', Geminiã¯'edit'
                    prompt: finalPrompt,
                    model: modelId, 
                    keyIndex: apiKeyCounter, 
                    aspectRatio: aspectRatioSelect.value, 
                    styles: selectedStyles,
                    // â˜… å¤‰æ›´: ç·¨é›†ãƒ¢ãƒ¼ãƒ‰æ™‚ã€ã¾ãŸã¯Geminiç³»ã®é€šå¸¸ç”Ÿæˆæ™‚ ã« baseImage ã‚’æ¸¡ã™
                    baseImage: (isEditingMode || isGeminiJob) ? currentEditImageBase64 : null
                };

                // 2. å®Ÿè¡Œä¸­ãƒªã‚¹ãƒˆã«è¿½åŠ 
                runningGenerations.add(cardId);

                // 3. ãƒ•ã‚§ãƒƒãƒãƒ—ãƒ­ãƒŸã‚¹ã‚’ä½œæˆ (ä¾é ¼â‘¡ãƒ»â‘¢: ãƒªãƒˆãƒ©ã‚¤å…±é€š)
                const promise = fetchWithRetry('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }, retryCount, currentFetchController.signal)
                .then(response => response.json())
                .then(data => {
                    // â˜… æˆåŠŸ
                    const base64 = `data:image/png;base64,${data.base64}`;
                    updateImageCard(cardId, base64, finalPrompt, data.translatedPrompt || finalPrompt, data.base64);
                    
                    // â˜… å¤‰æ›´: DBä¿å­˜
                    saveImageToDB(finalPrompt, data.translatedPrompt || finalPrompt, base64, modelId, aspectRatioSelect.value, selectedStyles); 
                    
                    // â˜… å¤‰æ›´: æœ€åˆã®ç”Ÿæˆç”»åƒã‚’ãƒ™ãƒ¼ã‚¹ç”»åƒã¨ã—ã¦è¨­å®š (ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ç”¨)
                    if (!currentEditImageBase64 && data.base64) {
                        currentEditImageBase64 = data.base64;
                        updateAllCardsForEditing(currentEditImageBase64);
                    }

                })
                .catch(error => {
                    // â˜… å¤±æ•— (ãƒªãƒˆãƒ©ã‚¤å«ã‚€) or ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    if (error.name !== 'AbortError') {
                        console.error(`Generation error for ${modelId}:`, error);
                        updateImageCard(cardId, null, finalPrompt, null, null, error.message); // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
                        sendErrorToGAS(payload, error.message);
                    } else {
                        console.log(`Generation cancelled for ${modelId}`);
                        updateImageCard(cardId, null, finalPrompt, null, null, "Cancelled"); // ã‚­ãƒ£ãƒ³ã‚»ãƒ«è¡¨ç¤º
                    }
                })
                .finally(() => {
                    // 4. å®Ÿè¡Œä¸­ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
                    runningGenerations.delete(cardId);
                    // 5. å…¨ã¦ã®å®Ÿè¡ŒãŒå®Œäº†ã—ãŸã‹ãƒã‚§ãƒƒã‚¯
                    if (runningGenerations.size === 0) {
                        generationInProgress = false;
                        currentFetchController = null;
                        setLoading(generateButton, false); // Send/Editã‚¢ã‚¤ã‚³ãƒ³
                        // loadingAnimation.classList.remove('active');
                        
                        // â˜… ä¾é ¼â‘¢: ã‚¹ã‚¿ã‚¤ãƒ«ã®ã¿ç·¨é›†ã®å ´åˆã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚¯ãƒªã‚¢
                        if (isEditingMode && !prompt && selectedStyles.length > 0) {
                             promptInput.value = "";
                        }
                    }
                });
                
                generationPromises.push(promise);
            } // end for loop
            
            // â˜… ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¯ãƒªã‚¢ (å³æ™‚) (ç·¨é›†ãƒ¢ãƒ¼ãƒ‰æ™‚ã¯ã‚¯ãƒªã‚¢ã—ãªã„)
            if (!isEditingMode) {
                promptInput.value = "";
            }

        } // end handleGenerationSubmit
        // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ã“ã“ã¾ã§ â˜…â˜…â˜…
        

        // â˜… å¤‰æ›´: AbortSignal ã‚’å¼•æ•°ã«è¿½åŠ 
        async function fetchWithRetry(url, options, retries = 0, signal = null) {
            let attempt = 0;
            const maxRetries = retries < 0 ? 0 : retries; 

            // â˜… signal ã‚’ options ã«è¿½åŠ 
            if (signal) {
                options.signal = signal;
            }

            while (attempt <= maxRetries) {
                try {
                    // â˜… ä¾é ¼â‘¡ãƒ»â‘¢: ãƒªãƒˆãƒ©ã‚¤ä¸­ã®ãƒˆãƒ¼ã‚¹ãƒˆã¯å€‹åˆ¥ã‚«ãƒ¼ãƒ‰ã«è¡¨ç¤ºã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯è¡¨ç¤ºã—ãªã„
                    // if (attempt > 0) {
                    //    showToast(`Retrying... (Attempt ${attempt} of ${maxRetries})`, "warning");
                    // }
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: `Server error: ${response.status}` }));
                        throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                    }
                    return response; 
                } catch (error) {
                    // â˜… AbortError ã¯ãƒªãƒˆãƒ©ã‚¤ã—ãªã„
                    if (error.name === 'AbortError') {
                        throw error;
                    }
                    console.warn(`Attempt ${attempt} failed:`, error.message);
                    if (attempt === maxRetries) {
                        // â˜… èªè¨¼ã‚¨ãƒ©ãƒ¼ (401) ã®å ´åˆã¯ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢ã—ã¦ãƒªãƒ­ãƒ¼ãƒ‰
                        if (error.message.includes('401') || error.message.includes('Authentication failed')) {
                            sessionStorage.removeItem('muGenAuthenticated');
                            location.reload();
                        }
                        throw error; 
                    }
                    attempt++;
                    
                    // â˜… ä¾é ¼â‘¡ãƒ»â‘¢: ãƒªãƒˆãƒ©ã‚¤å¾…æ©Ÿä¸­ã‚‚ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
                    await new Promise((res, rej) => {
                        const timer = setTimeout(res, 1000 * attempt);
                        if (signal) {
                            signal.addEventListener('abort', () => {
                                clearTimeout(timer);
                                rej(new DOMException('Aborted', 'AbortError'));
                            });
                        }
                    });
                }
            }
        }

        // â˜… è¿½åŠ : ã‚¨ãƒ©ãƒ¼ã‚’GASã«é€ä¿¡ã™ã‚‹ï¼ˆã‚µã‚¤ãƒ¬ãƒ³ãƒˆï¼‰
        function sendErrorToGAS(payload, errorMessage) {
            // ã‚¨ãƒ©ãƒ¼é€ä¿¡ã¯ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§è©¦è¡Œã—ã€å¤±æ•—ã—ã¦ã‚‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯é€šçŸ¥ã—ãªã„
            fetch('/api/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'logError',
                    prompt: payload.prompt,
                    model: payload.model,
                    error: errorMessage
                })
            }).catch(err => {
                console.warn("Failed to log error to GAS:", err);
            });
        }


        // --- â˜… è¿½åŠ : ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå…¥åŠ›ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼ ---

        function handlePromptCopy() {
            const textToCopy = promptInput.value;
            if (!textToCopy) {
                showToast("Nothing to copy", "info");
                return;
            }
            // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼
            copyToClipboard(textToCopy, "Prompt copied to clipboard!");
        }

        function handlePromptClear() {
            promptInput.value = "";
            showToast("Input cleared", "info");
        }


        // --- MODAL & TOAST functions ---
        
        // â˜… å¤‰æ›´: base64 (raw) ã‚‚ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã«ä¿å­˜
        // â˜… ä¾é ¼: ã‚ºãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆå‡¦ç†ã‚’è¿½åŠ 
        function showImageInModal(base64DataUrl, prompt, translatedPrompt, rawBase64) {
            modalImage.src = base64DataUrl;
            modalPrompt.textContent = translatedPrompt || prompt;
            modalRegenerate.dataset.prompt = prompt;
            modalRegenerate.dataset.translatedPrompt = translatedPrompt;
            modalEdit.dataset.base64 = rawBase64; // â˜… Raw Base64
            modalEdit.dataset.prompt = prompt; // â˜… å…ƒã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
            
            // â˜… ä¾é ¼: ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºæ™‚ã«ã‚ºãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            handleZoomReset();

            imageModal.classList.add('flex');
        }
        
        // â˜… å¤‰æ›´: ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼ã®Fallbackã‚’æ”¹å–„
        function handleModalCopy() {
            const textToCopy = modalPrompt.textContent;
            copyToClipboard(textToCopy, "Prompt copied to clipboard!");
        }
        
        // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ (ä¾é ¼â‘¡ãƒ»â‘¢) â˜…â˜…â˜…
        function handleModalRegenerate() {
            const prompt = modalRegenerate.dataset.prompt;
            promptInput.value = prompt;
            imageModal.classList.remove('flex');
            
            // â˜… å¤‰æ›´: ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’è§£é™¤ã—ã€ã‚°ãƒªãƒƒãƒ‰ã‚’ã‚¯ãƒªã‚¢
            if (isEditingMode) {
                toggleEditMode(false);
            }
            clearImageGrid(); 
            
            // â˜… å†ç”Ÿæˆæ™‚ã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒ¢ãƒ‡ãƒ« (4.0 Fastãªã©) ã§ç”Ÿæˆ
            handleGenerationSubmit(new Event('submit')); 
        }

        // â˜… è¿½åŠ : ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰ã®ç·¨é›†
        function handleModalEdit() {
            const base64 = modalEdit.dataset.base64;
            const prompt = modalEdit.dataset.prompt;
            
            // â˜… å¤‰æ›´: ã‚°ãƒªãƒƒãƒ‰ã‚’ã‚¯ãƒªã‚¢ã—ã¦èª­ã¿è¾¼ã‚€
            loadUploadedImage(`data:image/png;base64,${base64}`, prompt, false); 
            
            imageModal.classList.remove('flex');
        }
        // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ã“ã“ã¾ã§ â˜…â˜…â˜…

        // --- â˜… ä¾é ¼: ã‚ºãƒ¼ãƒ ãƒãƒ³ãƒ‰ãƒ©é–¢æ•° ---
        
        function handleZoomIn() {
            modalZoomLevel = Math.min(modalZoomLevel * 1.5, MAX_ZOOM);
            updateZoom();
        }

        function handleZoomOut() {
            modalZoomLevel = Math.max(modalZoomLevel / 1.5, MIN_ZOOM);
            updateZoom();
        }

        function handleZoomReset() {
            modalZoomLevel = 1.0;
            updateZoom();
            // â˜… ã‚ºãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆæ™‚ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚‚ãƒªã‚»ãƒƒãƒˆ
            if (modalImageWrapper) {
                modalImageWrapper.scrollTop = 0;
                modalImageWrapper.scrollLeft = 0;
            }
        }

        function updateZoom() {
            if (modalImage) {
                modalImage.style.transform = `scale(${modalZoomLevel})`;
                
                // â˜… å¤‰æ›´: ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ãŒ 1.0 (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ) ã®æ™‚ã ã‘ãƒ•ã‚£ãƒƒãƒˆã•ã›ã‚‹
                if (modalZoomLevel === 1.0) {
                    modalImage.classList.add('max-w-full', 'max-h-full', 'object-contain');
                } else {
                    // ã‚ºãƒ¼ãƒ ã‚¤ãƒ³ã§ã‚‚ã‚ºãƒ¼ãƒ ã‚¢ã‚¦ãƒˆã§ã‚‚ã€æœ€å¤§ã‚µã‚¤ã‚ºåˆ¶é™ã‚’è§£é™¤
                    modalImage.classList.remove('max-w-full', 'max-h-full', 'object-contain');
                }
            }
        }
        // ------------------------------------


        // â˜… å¤‰æ›´: showToast (ã‚¨ãƒ©ãƒ¼æ™‚ã¯è‡ªå‹•ã§æ¶ˆãˆãªã„)
        function showToast(message, type = "success") {
            if (toastTimeoutId) {
                clearTimeout(toastTimeoutId);
                toastTimeoutId = null;
            }
            
            toastMessage.textContent = message;
            toast.className = `fixed top-20 right-6 text-white py-3 px-4 rounded-lg shadow-lg transition-all duration-300 opacity-0 -translate-y-10 z-50`; // Reset
            
            if (type === "error") {
                toast.classList.add('bg-red-600');
                toastCopy.classList.remove('hidden'); // ã‚¨ãƒ©ãƒ¼æ™‚ã®ã¿ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³è¡¨ç¤º
            } else {
                toast.classList.add(type === "warning" ? 'bg-yellow-500' : (type === "info" ? 'bg-blue-600' : 'bg-green-600'));
                toastCopy.classList.add('hidden');
            }

            toast.classList.remove('opacity-0', '-translate-y-10');
            toast.classList.add('opacity-100', 'translate-y-0');

            // â˜… ã‚¨ãƒ©ãƒ¼ã§ãªã„å ´åˆã®ã¿ã€3ç§’å¾Œã«è‡ªå‹•ã§æ¶ˆã™
            if (type !== "error") {
                toastTimeoutId = setTimeout(() => {
                    hideToast();
                }, 3000); 
            }
        }

        // â˜… è¿½åŠ : ãƒˆãƒ¼ã‚¹ãƒˆã‚’éš ã™
        function hideToast() {
            if (toastTimeoutId) {
                clearTimeout(toastTimeoutId);
                toastTimeoutId = null;
            }
            toast.classList.remove('opacity-100', 'translate-y-0');
            toast.classList.add('opacity-0', '-translate-y-10');
        }
        
        // â˜… è¿½åŠ : ãƒˆãƒ¼ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚³ãƒ”ãƒ¼
        function copyToastMessage() {
            const textToCopy = toastMessage.textContent;
            copyToClipboard(textToCopy, "Error message copied!");
        }

        // â˜… æ±ç”¨ã‚³ãƒ”ãƒ¼é–¢æ•°
        function copyToClipboard(textToCopy, successMessage) {
             navigator.clipboard.writeText(textToCopy).then(() => {
                showToast(successMessage, "success");
            }).catch(err => {
                console.error('Clipboard copy failed:', err);
                try {
                    // Fallback for insecure contexts
                    const textArea = document.createElement("textarea");
                    textArea.value = textToCopy;
                    textArea.style.position = "fixed"; 
                    textArea.style.top = "0";
                    textArea.style.left = "0";
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showToast(successMessage, "success");
                } catch (fallbackErr) {
                    console.error('Fallback copy failed:', fallbackErr);
                    showToast("Failed to copy", "error");
                }
            });
        }
        
        // â˜… å¤‰æ›´: ã‚¢ã‚¤ã‚³ãƒ³åˆ‡ã‚Šæ›¿ãˆ (isEditingMode å¯¾å¿œ)
        // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ (ä¾é ¼â‘¡ãƒ»â‘¢) â˜…â˜…â˜…
        function setLoading(button, isLoading) {
            // â˜… èªè¨¼ãƒœã‚¿ãƒ³ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å‡¦ç†
            if (button.id === 'auth-submit') {
                if (isLoading) {
                    button.disabled = true;
                    button.innerHTML = '<svg class="w-5 h-5 text-white animate-spin mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-loader"></use></svg>';
                } else {
                    button.disabled = false;
                    button.innerHTML = 'Login';
                }
                return;
            }
        
            if (button.id === 'generate-button') {
                const icon = button.querySelector('svg use');
                
                // â˜… å¤‰æ›´: isLoading (generationInProgress) ã‹ã©ã†ã‹ã§åˆ¤æ–­
                if (isLoading) {
                    button.disabled = false; // â˜… ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã®ãŸã‚
                    button.classList.add('bg-red-600', 'hover:bg-red-700'); // â˜… åœæ­¢ãƒœã‚¿ãƒ³ã®è‰²
                    button.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                    if (icon) icon.setAttribute('href', '#icon-stop');
                    button.dataset.tooltip = "Cancel Generation";
                } else {
                    button.disabled = false;
                    button.classList.remove('bg-red-600', 'hover:bg-red-700');
                    button.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                    
                    // â˜… å¤‰æ›´: isEditingMode (ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹) ã«å¿œã˜ã¦ã‚¢ã‚¤ã‚³ãƒ³ã‚’åˆ‡ã‚Šæ›¿ãˆ
                    if (isEditingMode) {
                        if (icon) icon.setAttribute('href', '#icon-edit');
                        button.dataset.tooltip = "Apply Edit";
                    } else {
                        if (icon) icon.setAttribute('href', '#icon-send');
                        button.dataset.tooltip = "Generate";
                    }
                }
            } else {
                // ä»–ã®ãƒœã‚¿ãƒ³ (ç¿»è¨³ãƒœã‚¿ãƒ³ãªã©)
                const icon = button.querySelector('svg');
                if (isLoading) {
                    button.disabled = true;
                    if (icon) icon.classList.add('animate-spin'); 
                } else {
                    button.disabled = false;
                    if (icon) icon.classList.remove('animate-spin');
                }
            }
        }
        // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ã“ã“ã¾ã§ â˜…â˜…â˜…

        // --- â˜… è¿½åŠ : D&D / Upload Handlers ---

        function handleDragOver(event) {
            event.preventDefault();
            if (generationInProgress || isEditingMode) return;
            imageDisplay.classList.add('drag-over');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            imageDisplay.classList.remove('drag-over');
        }

        function handleDrop(event) {
            event.preventDefault();
            imageDisplay.classList.remove('drag-over');
            if (generationInProgress) return;

            const file = event.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                readImageFile(file);
            } else {
                showToast("Please drop an image file (PNG, JPG, etc.)", "warning");
            }
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                readImageFile(file);
            }
            uploadImageInput.value = null; // åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã§ãã‚‹ã‚ˆã†ã«ãƒªã‚»ãƒƒãƒˆ
        }

        // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ (ä¾é ¼â‘¡ãƒ»â‘¢) â˜…â˜…â˜…
        function readImageFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                // â˜… å¤‰æ›´: false (æ–°è¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰)
                loadUploadedImage(e.target.result, "", false); 
            };
            reader.onerror = (e) => {
                showToast("Failed to read image file.", "error");
            };
            reader.readAsDataURL(file);
        }

        /**
         * â˜… å¤‰æ›´: ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¾ãŸã¯Historyã‹ã‚‰ç”»åƒã‚’èª­ã¿è¾¼ã‚€ (ä¾é ¼â‘¡ãƒ»â‘¢)
         * @param {string} base64DataUrl (Data URL: "data:image/...")
         * @param {string} [prompt] (Historyã‹ã‚‰èª­ã¿è¾¼ã‚€å ´åˆã®æ—¢å­˜ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ)
         * @param {boolean} [isSwitchingBase=false] - ã‚°ãƒªãƒƒãƒ‰ä¸Šã®æ—¢å­˜ç”»åƒã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã ã‘ã‹
         */
        function loadUploadedImage(base64DataUrl, prompt = "", isSwitchingBase = false) {
            
            // "data:image/png;base64," ã®éƒ¨åˆ†ã‚’å‰Šé™¤
            const rawBase64 = base64DataUrl.split(',')[1];
            currentEditImageBase64 = rawBase64; 

            // â˜… å¤‰æ›´: ã‚°ãƒªãƒƒãƒ‰ä¸Šã®ç”»åƒã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸ (isSwitchingBase) å ´åˆã¯ã‚°ãƒªãƒƒãƒ‰ã‚’ã‚¯ãƒªã‚¢ã—ãªã„
            if (!isSwitchingBase) {
                imageGridContainer.innerHTML = ''; // ã‚°ãƒªãƒƒãƒ‰ã‚’ã‚¯ãƒªã‚¢
                
                // â˜… ã‚¯ãƒªã‚¢ã—ãŸã‚°ãƒªãƒƒãƒ‰ã«ã€èª­ã¿è¾¼ã‚“ã ç”»åƒã‚’1æšã ã‘è¡¨ç¤º
                const cardId = `image-card-base-${Date.now()}`;
                const card = createImageCard(cardId, "Base Image");
                imageGridContainer.appendChild(card);
                updateImageCard(cardId, base64DataUrl, prompt, prompt, rawBase64);
                updatePlaceholderVisibility();
            }
            
            showToast("Image loaded. Ready to edit.", "info");
            
            // â˜… å¤‰æ›´: ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ (2.5) ã«è‡ªå‹•ã§å…¥ã‚‹
            toggleEditMode(true, ['gemini-2.5-flash-image-preview']); 

            if (prompt) {
                promptInput.value = prompt;
            } else {
                promptInput.value = "";
            }
        }
        
        
        /**
         * â˜… æ–°è¦: ç”»åƒè¡¨ç¤ºç”¨ã®ã‚«ãƒ¼ãƒ‰DOMã‚’ä½œæˆ (ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹)
         * @param {string} cardId - ãƒ¦ãƒ‹ãƒ¼ã‚¯ID
         * @param {string} modelName - è¡¨ç¤ºã™ã‚‹ãƒ¢ãƒ‡ãƒ«å
         * @returns {HTMLElement}
         */
        function createImageCard(cardId, modelName) {
            const card = document.createElement('div');
            card.id = cardId;
            // â˜… å¤‰æ›´: ã‚«ã‚¹ã‚¿ãƒ ã‚¯ãƒ©ã‚¹ .image-card ã‚’ä½¿ç”¨
            card.className = "image-card";
            
            card.innerHTML = `
                <div class="loading-spinner flex flex-col items-center justify-center text-gray-400">
                    <svg class="w-10 h-10 text-indigo-400 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-loader"></use></svg>
                    <p class="mt-2 text-sm font-medium">${modelName}</p>
                    <p class="mt-1 text-xs text-gray-500">Generating...</p>
                </div>
                
                <img src="" class="hidden max-w-full max-h-full object-contain rounded-lg">
                
                <div class="error-message hidden text-red-300 text-sm p-2 break-words max-h-full overflow-y-auto"></div>
                
                <div class="image-overlay hidden absolute inset-0 bg-black/70 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2 p-2">
                    <button class="image-zoom-btn bg-gray-800 text-white p-2 rounded-full hover:bg-indigo-600" data-tooltip="Zoom">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-zoom-in"></use></svg>
                    </button>
                    <button class="image-edit-btn bg-gray-800 text-white p-2 rounded-full hover:bg-blue-600" data-tooltip="Use as Edit Base">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-edit"></use></svg>
                    </button>
                    <button class="image-close-btn bg-gray-800 text-white p-2 rounded-full hover:bg-red-600" data-tooltip="Remove">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-x"></use></svg>
                    </button>
                </div>
            `;
            // â˜… ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã« group-hover ã‚’é©ç”¨
            card.classList.add('group');
            
            return card;
        }

        /**
         * â˜… æ–°è¦: ç”»åƒã‚«ãƒ¼ãƒ‰ã®çŠ¶æ…‹ã‚’æ›´æ–° (æˆåŠŸ/ã‚¨ãƒ©ãƒ¼)
         */
        function updateImageCard(cardId, base64DataUrl, prompt, translatedPrompt, rawBase64, errorMsg = null) {
            const card = document.getElementById(cardId);
            if (!card) return;

            const spinner = card.querySelector('.loading-spinner');
            const img = card.querySelector('img');
            const errorDiv = card.querySelector('.error-message');
            const overlay = card.querySelector('.image-overlay');

            spinner.classList.add('hidden');

            if (errorMsg) {
                errorDiv.textContent = errorMsg;
                errorDiv.classList.remove('hidden');
                // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚å‰Šé™¤ãƒœã‚¿ãƒ³ã ã‘ã¯è¡¨ç¤º
                overlay.classList.remove('hidden');
                overlay.querySelector('.image-zoom-btn').style.display = 'none';
                overlay.querySelector('.image-edit-btn').style.display = 'none';
                card.classList.add('bg-red-900/50'); // ã‚¨ãƒ©ãƒ¼èƒŒæ™¯
            } else {
                img.src = base64DataUrl;
                img.classList.remove('hidden');
                overlay.classList.remove('hidden');
                
                // â˜… æˆåŠŸæ™‚ã®ã¿ã‚ºãƒ¼ãƒ ã¨ç·¨é›†ãƒœã‚¿ãƒ³ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                const zoomBtn = overlay.querySelector('.image-zoom-btn');
                zoomBtn.onclick = () => showImageInModal(base64DataUrl, prompt, translatedPrompt, rawBase64);

                const editBtn = overlay.querySelector('.image-edit-btn');
                // â˜… å¤‰æ›´: ç·¨é›†ãƒœã‚¿ãƒ³ã¯ãƒ™ãƒ¼ã‚¹ç”»åƒãŒã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã‚Œã°å¸¸ã«è¡¨ç¤º
                if (rawBase64) {
                    editBtn.style.display = 'block';
                    editBtn.onclick = () => {
                        loadUploadedImage(base64DataUrl, prompt, true); // â˜… å¤‰æ›´: true (isSwitchingBase)
                    };
                } else {
                     editBtn.style.display = 'none';
                }
            }
            
            // å‰Šé™¤ãƒœã‚¿ãƒ³
            const closeBtn = overlay.querySelector('.image-close-btn');
            closeBtn.onclick = () => {
                card.remove();
                updatePlaceholderVisibility();
            };
        }

        /**
         * â˜… æ–°è¦: è¤‡æ•°ã®ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚‹å ´åˆã€ãƒ™ãƒ¼ã‚¹ç”»åƒãŒè¨­å®šã•ã‚ŒãŸã‚‰å…¨ã‚«ãƒ¼ãƒ‰ã®ç·¨é›†ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
         */
        function updateAllCardsForEditing(newBase64) {
            currentEditImageBase64 = newBase64;
            // (ã“ã®é–¢æ•°ã¯ loadUploadedImage ã¨ handleGenerationSubmit å†…ã§
            // currentEditImageBase64 ã‚’è¨­å®šã™ã‚‹ã ã‘ã§ååˆ†ã«ãªã‚Šã¾ã—ãŸ)
        }
        // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ã“ã“ã¾ã§ â˜…â˜…â˜…

    </script>
</body>
</html>
