<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>muGen.</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- (Omitted: <style> block for brevity, assumed unchanged) -->
    <style>
        /* Inter Font (Mac-like) */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
        }

        /* Custom scrollbar for sidebar */
        .sidebar-scroll::-webkit-scrollbar {
            width: 4px;
        }
        .sidebar-scroll::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 4px;
        }
        .sidebar-scroll::-webkit-scrollbar-track {
            background-color: #1f2937;
        }

        /* Dynamic Noise Animation */
        .noise-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #111827;
            z-index: 10;
            display: none; /* Hidden by default */
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .noise-container.active {
            display: block;
            opacity: 1;
        }
        .noise-container::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 256 256'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
            background-size: 128px 128px;
            opacity: 0.15;
            animation: noise-animation 0.2s linear infinite;
        }
        @keyframes noise-animation {
            0% { transform: translate(0, 0); }
            10% { transform: translate(-5%, -5%); }
            20% { transform: translate(-10%, 5%); }
            30% { transform: translate(5%, -10%); }
            40% { transform: translate(-5%, 15%); }
            50% { transform: translate(-10%, -5%); }
            60% { transform: translate(15%, 0); }
            70% { transform: translate(0, 10%); }
            80% { transform: translate(-15%, 0); }
            90% { transform: translate(10%, 5%); }
            100% { transform: translate(5%, 0); }
        }

        /* Custom Checkbox */
        .style-checkbox:checked + label {
            background-color: #4f46e5;
            border-color: #4f46e5;
            color: #ffffff;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            inset: 0;
            overflow-y: auto;
            background-color: rgba(0, 0, 0, 0.7);
            align-items: center;
            justify-content: center;
        }
        .modal.flex {
            display: flex;
        }

        /* Tooltip */
        [data-tooltip] {
            position: relative;
        }
        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #1f2937;
            color: #ffffff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 60;
            opacity: 1;
            transition: opacity 0.2s;
        }

        /* Chevron rotation for accordion */
        .rotate-180 {
            transform: rotate(180deg);
        }

        /* ‚òÖ Drag over effect */
        .drag-over {
            border-style: dashed;
            border-color: #4f46e5;
            background-color: #1f2937;
        }

        /* ‚òÖ ËøΩÂä†: History Marquee */
        .history-info-container {
            width: 100%;
            overflow: hidden;
            white-space: nowrap;
            position: absolute;
            bottom: 0;
            left: 0;
            background: rgba(0, 0, 0, 0.7);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none; /* ‰∏ã„ÅÆÁîªÂÉè„Çí„ÇØ„É™„ÉÉ„ÇØ„Åß„Åç„Çã„Çà„ÅÜ„Å´ */
        }
        .group:hover .history-info-container {
            opacity: 1;
        }
        .history-info-text-wrapper {
            display: inline-block;
            white-space: nowrap;
            /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÅØÈï∑„ÇÅ„ÅÆÊôÇÈñì (25Áßí) „Å´Ë®≠ÂÆö */
            animation: marquee 25s linear infinite;
        }
        .history-info-text {
            display: inline-block;
            padding: 4px 12px; /* Â∑¶Âè≥„Å´„Éë„Éá„Ç£„É≥„Ç∞ */
            color: white;
            font-size: 10px;
        }
        
        @keyframes marquee {
            0%   { transform: translateX(0); }
            /* „ÉÜ„Ç≠„Çπ„Éà2ÂõûÂàÜ„ÅÆÂçäÂàÜ„ÇíÂãï„Åã„Åô */
            100% { transform: translateX(-50%); } 
        }

    </style>
</head>
<body class="bg-gray-900 text-gray-100 h-screen w-screen overflow-hidden flex">

    <!-- (Omitted: Inline SVG Icons Definition for brevity) -->
    <svg width="0" height="0" class="hidden">
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-menu">
            <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line>
        </symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-x">
            <line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>
        </symbol>
        <!-- ‚òÖ Â§âÊõ¥: ÁøªË®≥„Ç¢„Ç§„Ç≥„É≥ (Lucide 'Type' icon) -->
        <symbol xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" id="icon-translate">
            <polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/>
        </symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-send">
            <line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </symbol>
        <!-- ‚òÖ ËøΩÂä†: ÂÅúÊ≠¢„Ç¢„Ç§„Ç≥„É≥ (Stop Circle) -->
        <symbol xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" id="icon-stop">
            <circle cx="12" cy="12" r="10"></circle><rect x="9" y="9" width="6" height="6"></rect>
        </symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-image">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline>
        </symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-edit">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
        </symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-copy">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
        </symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-refresh">
            <polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
        </symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-loader">
            <line x1="12" y1="2" x2="12" y2="6"></line><line x1="12" y1="18" x2="12" y2="22"></line><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line><line x1="2" y1="12" x2="6" y2="12"></line><line x1="18" y1="12" x2="22" y2="12"></line><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line>
        </symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" id="icon-chevron-down">
             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </symbol>
        <!-- ‚òÖ ËøΩÂä†: „Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Ç¢„Ç§„Ç≥„É≥ -->
        <symbol xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" id="icon-upload">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line>
        </symbol>
        <!-- ‚òÖ ËøΩÂä†: ÂÖ•Âäõ„ÇØ„É™„Ç¢„Ç¢„Ç§„Ç≥„É≥ (X Circle) -->
        <symbol xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" id="icon-x-circle">
            <circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line>
        </symbol>
    </svg>

    <!-- ‚òÖ Â§âÊõ¥: „Çµ„Ç§„Éâ„Éê„Éº ÂàùÊúüÁä∂ÊÖã„Çí md:translate-x-0 (PCË°®Á§∫) „Å´ -->
    <aside id="sidebar" class="bg-gray-800 h-full w-64 p-4 flex flex-col flex-shrink-0 fixed z-30 transition-transform duration-300 ease-in-out -translate-x-full md:translate-x-0">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-xl font-bold text-white">History</h1>
            <!-- ‚òÖ Â§âÊõ¥: md:hidden („Çπ„Éû„ÉõÂ∞ÇÁî®„ÇØ„É≠„Éº„Ç∫) -->
            <button id="close-sidebar" class="md:hidden text-gray-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-x"></use></svg>
            </button>
        </div>
        
        <!-- ‚òÖ ËøΩÂä†: Áµ±Ë®àÊÉÖÂ†± -->
        <div id="history-stats" class="mb-4 p-3 bg-gray-700 rounded-lg">
            <div class="flex justify-between text-sm">
                <span class="text-gray-300">Total Images:</span>
                <span id="stats-total-images" class="font-medium text-white">0</span>
            </div>
            <div class="flex justify-between text-sm mt-1">
                <span class="text-gray-300">Est. Cost (USD):</span>
                <span id="stats-cost-usd" class="font-medium text-white">$0.00</span>
            </div>
            <div class="flex justify-between text-sm mt-1">
                <span class="text-gray-300">Est. Cost (JPY):</span>
                <span id="stats-cost-jpy" class="font-medium text-white">¬•0</span>
            </div>
        </div>

        <div id="history-container" class="flex-1 overflow-y-auto sidebar-scroll space-y-2">
            <!-- History items will be injected here by JS -->
            <p class="text-gray-400 text-sm">No generated images yet.</p>
        </div>
    </aside>

    <!-- ‚òÖ Â§âÊõ¥: main-content ÂàùÊúüÁä∂ÊÖã„Çí md:ml-64 (PC„Éû„Éº„Ç∏„É≥„ÅÇ„Çä) „Å´ -->
    <main id="main-content" class="flex-1 h-full flex flex-col transition-all duration-300 ease-in-out md:ml-64">
        
        <header class="flex-shrink-0 bg-gray-900/70 backdrop-blur-sm h-16 flex items-center px-6 shadow-md z-20">
            <!-- ‚òÖ Â§âÊõ¥: md:hidden „ÇíÂâäÈô§„Åó„ÄÅ„Éà„Ç∞„É´„Éú„Çø„É≥„Å´ -->
            <button id="sidebar-toggle-button" class="text-gray-400 hover:text-white mr-4" data-tooltip="Toggle History">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-menu"></use></svg>
            </button>
            <div class="flex items-center space-x-2">
                <svg class="w-6 h-6 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-image"></use></svg>
                <span class="text-lg font-semibold text-white">muGen.</span>
            </div>
            <div class="flex space-x-2 ml-4">
                <div class="w-3 h-3 rounded-full bg-gray-700"></div>
                <div class="w-3 h-3 rounded-full bg-gray-700"></div>
                <div class="w-3 h-3 rounded-full bg-gray-700"></div>
            </div>
        </header>

        <div class="flex-1 flex items-center justify-center p-4 md:p-8 relative overflow-hidden">
            <!-- ‚òÖ Â§âÊõ¥: „Éâ„É©„ÉÉ„Ç∞ÔºÜ„Éâ„É≠„ÉÉ„Éó„Å®„Éï„Ç°„Ç§„É´ÂÖ•ÂäõÂØæÂøú -->
            <div id="image-display" class="w-full h-full max-w-3xl max-h-[70vh] flex items-center justify-center bg-gray-800 rounded-lg shadow-inner relative border-2 border-transparent transition-all">
                <img id="generated-image" src="" alt="Generated Image" class="hidden max-w-full max-h-full object-contain rounded-lg">
                <!-- ‚òÖ Â§âÊõ¥: „Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÊ©üËÉΩËøΩÂä† -->
                <div id="placeholder" class="text-gray-500 flex flex-col items-center justify-center p-8 text-center">
                    <svg class="w-24 h-24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-image"></use></svg>
                    <p class="mt-2">Your generated image will appear here</p>
                    <p class="text-sm mt-4">or</p>
                    <button id="upload-image-button" type="button" class="mt-4 flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-lg transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-upload"></use></svg>
                        Upload Image to Edit
                    </button>
                    <input type="file" id="upload-image-input" class="hidden" accept="image/png, image/jpeg, image/webp">
                    <p class="text-xs text-gray-600 mt-2">You can also drag & drop an image here</p>
                </div>

                <div id="loading-animation" class="noise-container">
                    <div class="absolute inset-0 flex items-center justify-center">
                        <svg class="w-12 h-12 text-indigo-400 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-loader"></use></svg>
                    </div>
                </div>

                <button id="edit-button" class="hidden absolute top-4 right-14 bg-indigo-600 hover:bg-indigo-700 text-white p-2 rounded-full shadow-lg transition" data-tooltip="Edit Image">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-edit"></use></svg>
                </button>
                <!-- ‚òÖ ËøΩÂä†: ÁîªÂÉè„ÇØ„É≠„Éº„Ç∫„Éú„Çø„É≥ -->
                <button id="close-image-button" class="hidden absolute top-4 right-4 bg-gray-700 hover:bg-gray-600 text-white p-2 rounded-full shadow-lg transition" data-tooltip="Close Image">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-x"></use></svg>
                </button>
            </div>
        </div>

        <!-- Prompt Input Area -->
        <footer class="flex-shrink-0 p-4 md:p-6 bg-gray-800/50 backdrop-blur-sm z-10">
            <form id="generation-form" class="max-w-4xl mx-auto">
                <!-- Options Toolbar -->
                <!-- ‚òÖ Â§âÊõ¥: „ÉÑ„Éº„É´„Éê„ÉºËá™‰Ωì„ÅØÂ∏∏„Å´ flex -->
                <div class="flex flex-wrap gap-4 mb-4" id="options-toolbar">
                    <!-- ‚òÖ Â§âÊõ¥: IDËøΩÂä† -->
                    <div id="model-select-group">
                        <label for="model-select" class="block text-sm font-medium text-gray-300 mb-1">Model</label>
                        <select id="model-select" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5">
                            <option value="imagen-3.0-generate">Imagen 3.0</option>
                            <option value="gemini-2.5-flash-image-preview">Gemini 2.5 Flash Image</option>
                        </select>
                    </div>
                    <!-- ‚òÖ Â§âÊõ¥: IDËøΩÂä† -->
                    <div id="aspect-ratio-group">
                        <label for="aspect-ratio-select" class="block text-sm font-medium text-gray-300 mb-1">Aspect Ratio</label>
                        <select id="aspect-ratio-select" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5">
                            <option value="1:1">1:1 Square</option>
                            <option value="16:9">16:9 Landscape</option>
                            <option value="9:16">9:16 Portrait</option>
                            <option value="4:3">4:3 Standard</option>
                            <option value="3:2">3:2 Photo</option>
                        </select>
                    </div>
                    <!-- ‚òÖ Â§âÊõ¥: IDËøΩÂä† -->
                    <div id="auto-retry-group">
                        <label for="auto-retry-select" class="block text-sm font-medium text-gray-300 mb-1">Auto Retry</label>
                        <select id="auto-retry-select" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5">
                            <option value="0">Off</option>
                            <option value="3">3 Times</option>
                            <option value="5">5 Times</option>
                            <option value="10">10 Times</option>
                            <option value="-1">Custom...</option>
                        </select>
                    </div>
                </div>

                <!-- Styles (Accordion) -->
                <div class="mb-4">
                    <button type="button" id="styles-toggle" class="flex justify-between items-center w-full p-2 rounded-lg hover:bg-gray-700 transition">
                        <label class="block text-sm font-medium text-gray-300 cursor-pointer">Styles (Optional, multiple)</label>
                        <svg id="styles-chevron" class="w-5 h-5 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <use href="#icon-chevron-down"></use>
                        </svg>
                    </button>
                    <div id="styles-container" class="hidden max-h-48 overflow-y-auto flex flex-wrap gap-2 p-3 bg-gray-700/50 rounded-lg mt-2">
                        <!-- Styles will be injected here by JS -->
                    </div>
                </div>

                <!-- ‚òÖ ËøΩÂä†: Á∑®ÈõÜ„É¢„Éº„Éâ„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº -->
                <div id="edit-mode-indicator" class="hidden text-center text-indigo-300 text-sm font-medium p-2 bg-indigo-900/50 rounded-lg mt-3">
                    üé® Editing Mode - Subsequent generations will edit the current image. (Change model to Imagen 3.0 to exit)
                </div>

                <!-- ‚òÖ Â§âÊõ¥: Prompt Input (mt-4ËøΩÂä†) -->
                <div class="relative mt-4">
                    <!-- ‚òÖ Â§âÊõ¥: pr-32 -> pr-48 („Éú„Çø„É≥ËøΩÂä†„ÅÆ„Åü„ÇÅ) -->
                    <textarea id="prompt-input" rows="2" class="block w-full p-4 pr-48 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:ring-indigo-500 focus:border-indigo-500 resize-none" placeholder="Enter your prompt... (Non-English will be translated)"></textarea>
                    
                    <!-- ‚òÖ ËøΩÂä†: „Ç≥„Éî„Éº/„ÇØ„É™„Ç¢„Éú„Çø„É≥ -->
                    <div class="absolute bottom-3 right-32 flex space-x-2">
                         <button id="prompt-copy-button" type="button" class="p-2 bg-gray-600 text-gray-400 rounded-lg hover:bg-gray-500 hover:text-gray-200 transition" data-tooltip="Copy Prompt">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-copy"></use></svg>
                        </button>
                         <button id="prompt-clear-button" type="button" class="p-2 bg-gray-600 text-gray-400 rounded-lg hover:bg-gray-500 hover:text-gray-200 transition" data-tooltip="Clear Input">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-x-circle"></use></svg>
                        </button>
                    </div>

                    <!-- ‚òÖ Â§âÊõ¥: pr-48 „Å´Âêà„Çè„Åõ„Å¶ right-3 „ÅÆ„Åæ„Åæ -->
                    <div class="absolute bottom-3 right-3 flex space-x-2">
                        <button id="translate-button" type="button" class="p-2 bg-gray-600 text-gray-300 rounded-lg hover:bg-gray-500 transition" data-tooltip="Translate to English">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-translate"></use></svg>
                        </button>
                        <!-- ‚òÖ Â§âÊõ¥: „Ç¢„Ç§„Ç≥„É≥„ÅØJS„ÅßÂàá„ÇäÊõø„Åà -->
                        <button id="generate-button" type="submit" class="p-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition" data-tooltip="Generate">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-send"></use></svg>
                        </button>
                    </div>
                </div>
            </form>
        </footer>
    </main>

    <!-- (Omitted: Image Modal and Toast Notification for brevity) -->
    <div id="image-modal" class="modal">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col p-4">
            <img id="modal-image" src="" class="max-w-full max-h-[70vh] object-contain mx-auto">
            <div class="p-4 bg-gray-900 rounded-b-lg mt-4">
                <p class="text-sm text-gray-300 mb-2">Prompt:</p>
                <p id="modal-prompt" class="text-white bg-gray-700 p-3 rounded-lg"></p>
                <!-- ‚òÖ Â§âÊõ¥: „É¢„Éº„ÉÄ„É´„Å´Edit„Éú„Çø„É≥ËøΩÂä† -->
                <div class="flex flex-wrap gap-4 mt-4">
                    <button id="modal-copy" class="flex items-center space-x-2 bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-lg transition" data-tooltip="Copy Prompt">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-copy"></use></svg>
                        <span>Copy</span>
                    </button>
                    <button id="modal-regenerate" class="flex items-center space-x-2 bg-gray-600 hover:bg-gray-500 text-white py-2 px-4 rounded-lg transition" data-tooltip="Regenerate Image">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-refresh"></use></svg>
                        <span>Regenerate</span>
                    </button>
                    <button id="modal-edit" class="flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition" data-tooltip="Load this image for editing">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-edit"></use></svg>
                        <span>Edit</span>
                    </button>
                </div>
            </div>
            <button id="modal-close" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-x"></use></svg>
            </button>
        </div>
    </div>

    <div id="toast" class="fixed top-20 right-6 bg-green-600 text-white py-2 px-6 rounded-lg shadow-lg transition-all duration-300 opacity-0 -translate-y-10 z-50">
        <p id="toast-message">Message</p>
    </div>

    <script>
        // --- CONSTANTS & STATE ---
        const STYLES = [
            "Photorealistic", "Cinematic", "35mm film", "Black and white", "Impressionistic",
            "Surrealism", "Watercolour", "Ukiyo-e", "Cyberpunk", "Steampunk",
            "Fantasy art", "Minimalism", "Animation", "Ghibli-style", "Disney-style"
        ];
        
        // ‚òÖ ËøΩÂä†: ÊñôÈáëË®àÁÆóÁî® (‰ªÆ„ÅÆÂçò‰æ°)
        const PRICE_IMAGEN_USD = 0.02; // Imagen 3.0 (‰ªÆ)
        const PRICE_GEMINI_FLASH_IMAGE_USD = 0.002; // Gemini Flash Image (‰ªÆ)
        const USD_JPY_RATE = 150; // ‰ªÆ„ÅÆÁÇ∫Êõø„É¨„Éº„Éà

        let db;
        let apiKeyCounter = 0; 
        let currentEditImageBase64 = null; 
        let isEditingMode = false;
        let lastEnterPress = 0; 
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        // ‚òÖ ËøΩÂä†: ÁîüÊàê„Ç≠„É£„É≥„Çª„É´Áî®
        let generationInProgress = false;
        let currentFetchController = null;


        // --- DOM ELEMENTS ---
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('main-content');
        // ‚òÖ Â§âÊõ¥: „Çµ„Ç§„Éâ„Éê„Éº„Éà„Ç∞„É´„Éú„Çø„É≥
        const sidebarToggleButton = document.getElementById('sidebar-toggle-button');
        const closeSidebarBtn = document.getElementById('close-sidebar');
        
        const generationForm = document.getElementById('generation-form');
        const promptInput = document.getElementById('prompt-input');
        const translateButton = document.getElementById('translate-button');
        const generateButton = document.getElementById('generate-button');
        // ‚òÖ ËøΩÂä†: „Éó„É≠„É≥„Éó„Éà„Éú„Çø„É≥
        const promptCopyButton = document.getElementById('prompt-copy-button');
        const promptClearButton = document.getElementById('prompt-clear-button');

        const loadingAnimation = document.getElementById('loading-animation');
        const imageDisplay = document.getElementById('image-display');
        const generatedImage = document.getElementById('generated-image');
        const placeholder = document.getElementById('placeholder');
        const historyContainer = document.getElementById('history-container');
        
        const modelSelect = document.getElementById('model-select');
        const aspectRatioSelect = document.getElementById('aspect-ratio-select');
        const autoRetrySelect = document.getElementById('auto-retry-select');
        
        const imageModal = document.getElementById('image-modal');
        const modalImage = document.getElementById('modal-image');
        const modalPrompt = document.getElementById('modal-prompt');
        const modalCopy = document.getElementById('modal-copy');
        const modalRegenerate = document.getElementById('modal-regenerate');
        const modalClose = document.getElementById('modal-close');
        const modalEdit = document.getElementById('modal-edit'); // ‚òÖ ËøΩÂä†
        
        const editButton = document.getElementById('edit-button');
        const closeImageButton = document.getElementById('close-image-button'); // ‚òÖ ËøΩÂä†
        const optionsToolbar = document.getElementById('options-toolbar');

        // ‚òÖ Â§âÊõ¥: „ÉÑ„Éº„É´„Éê„ÉºÂÜÖ„ÅÆ„Ç∞„É´„Éº„Éó„ÇíÂèñÂæó
        const modelSelectGroup = document.getElementById('model-select-group');
        const aspectRatioGroup = document.getElementById('aspect-ratio-group');
        const autoRetryGroup = document.getElementById('auto-retry-group');


        // ‚òÖ Styles Accordion Elements
        const stylesToggleBtn = document.getElementById('styles-toggle');
        const stylesContainer = document.getElementById('styles-container');
        const stylesChevron = document.getElementById('styles-chevron');

        // ‚òÖ History Stats Elements
        const statsTotalImages = document.getElementById('stats-total-images');
        const statsCostUsd = document.getElementById('stats-cost-usd');
        const statsCostJpy = document.getElementById('stats-cost-jpy');

        // ‚òÖ Upload Elements
        const uploadImageButton = document.getElementById('upload-image-button');
        const uploadImageInput = document.getElementById('upload-image-input');

        // ‚òÖ ËøΩÂä†: Á∑®ÈõÜ„É¢„Éº„Éâ„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº
        const editModeIndicator = document.getElementById('edit-mode-indicator');
        
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initDB();
            initSidebar();
            initStyles();
            initListeners();
            loadHistory();
        });

        // --- (Omitted: IndexedDB functions for brevity) ---
        function initDB() {
            const request = indexedDB.open("muGenDB", 1);

            request.onerror = (event) => {
                console.error("IndexedDB error:", event.target.errorCode);
                showToast("Database error. History may not work.", "error");
            };

            request.onupgradeneeded = (event) => {
                db = event.target.result;
                const objectStore = db.createObjectStore("images", { keyPath: "id", autoIncrement: true });
                objectStore.createIndex("timestamp", "timestamp", { unique: false });
                objectStore.createIndex("prompt", "prompt", { unique: false });
                // ‚òÖ ËøΩÂä†: „É¢„Éá„É´ÊÉÖÂ†±„Çí‰øùÂ≠ò„Åô„Çã„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ
                objectStore.createIndex("model", "model", { unique: false });
                // ‚òÖ ËøΩÂä†: „Ç¢„Çπ„Éö„ÇØ„ÉàÊØî„Å®„Çπ„Çø„Ç§„É´
                objectStore.createIndex("aspectRatio", "aspectRatio", { unique: false });
                objectStore.createIndex("styles", "styles", { unique: false });
            };

            request.onsuccess = (event) => {
                db = event.target.result;
                console.log("IndexedDB initialized.");
            };
        }

        // ‚òÖ Â§âÊõ¥: „É¢„Éá„É´ÊÉÖÂ†±„ÄÅ„Ç¢„Çπ„Éö„ÇØ„ÉàÊØî„ÄÅ„Çπ„Çø„Ç§„É´„Çí‰øùÂ≠ò
        function saveImageToDB(prompt, translatedPrompt, base64Data, model, aspectRatio, styles) {
            if (!db) return;
            const transaction = db.transaction(["images"], "readwrite");
            const objectStore = transaction.objectStore("images");
            const newItem = {
                prompt: prompt,
                translatedPrompt: translatedPrompt,
                base64: base64Data,
                timestamp: new Date().getTime(),
                model: model, // ‚òÖ „É¢„Éá„É´ÊÉÖÂ†±„Çí‰øùÂ≠ò
                aspectRatio: aspectRatio, // ‚òÖ „Ç¢„Çπ„Éö„ÇØ„ÉàÊØî„Çí‰øùÂ≠ò
                styles: styles // ‚òÖ „Çπ„Çø„Ç§„É´(ÈÖçÂàó)„Çí‰øùÂ≠ò
            };
            const request = objectStore.add(newItem);

            request.onsuccess = () => {
                console.log("Image saved to DB");
                loadHistory(); // Refresh history
            };
            request.onerror = (event) => {
                console.error("Error saving to DB:", event.target.error);
                if (event.target.error.name === 'QuotaExceededError') {
                    showToast("History storage is full. Clearing old entries...", "warning");
                    clearOldHistory();
                }
            };
        }

        // ‚òÖ Â§âÊõ¥: Áµ±Ë®àÊÉÖÂ†±„ÇíË®àÁÆó„Åó„Å¶Ë°®Á§∫ + „Éû„Éº„Ç≠„ÉºÊÉÖÂ†±
        function loadHistory() {
            if (!db) return;
            const transaction = db.transaction(["images"], "readonly");
            const objectStore = transaction.objectStore("images");
            const index = objectStore.index("timestamp");
            const request = index.getAll(null, 500); // Â±•Ê≠¥„ÅÆÊúÄÂ§ßÊï∞„ÇíÂ¢ó„ÇÑ„Åô (500)

            request.onsuccess = () => {
                const items = request.result.reverse(); // Newest first
                historyContainer.innerHTML = "";
                
                let totalCostUSD = 0;
                
                if (items.length === 0) {
                    historyContainer.innerHTML = '<p class="text-gray-400 text-sm">No generated images yet.</p>';
                } else {
                    items.forEach(item => {
                        const div = document.createElement('div');
                        div.className = "cursor-pointer rounded-lg overflow-hidden relative group";
                        
                        // ‚òÖ Â§âÊõ¥: HistoryÈ†ÖÁõÆ„Å´„Éû„Éº„Ç≠„ÉºÊÉÖÂ†±„Å®Á∑®ÈõÜ„Éú„Çø„É≥„ÇíËøΩÂä†
                        
                        // Ë°®Á§∫„Åô„ÇãÊÉÖÂ†±„ÉÜ„Ç≠„Çπ„Éà„Çí‰ΩúÊàê
                        let infoParts = [
                            `[P] ${item.prompt || ''}`,
                            `[M] ${item.model || 'unknown'}`,
                            `[A] ${item.aspectRatio || 'N/A'}`
                        ];
                        if (item.styles && item.styles.length > 0) {
                            infoParts.push(`[S] ${item.styles.join(', ')}`);
                        }
                        // „ÉÜ„Ç≠„Çπ„Éà„ÇíÂå∫Âàá„ÇäÊñáÂ≠ó„ÅßÈÄ£Áµê (HTML„Ç®„Çπ„Ç±„Éº„Éó„ÅØ‰∏çË¶Å„ÄÅinnerHTML„ÅßËß£Èáà„Åï„Çå„Çã)
                        const infoText = infoParts.join(' &nbsp;&nbsp;|&nbsp;&nbsp; ');

                        div.innerHTML = `
                            <img src="${item.base64}" alt="History thumbnail" class="w-full h-auto object-cover">
                            
                            <!-- ‚òÖ Â§âÊõ¥: „Éõ„Éê„ÉºÊôÇ„ÅÆ„Ç™„Éº„Éê„Éº„É¨„Ç§ (‰∏≠Â§Æ„Å´„Éú„Çø„É≥) -->
                            <div class="absolute inset-0 bg-black/70 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center p-2">
                                <button class="text-xs bg-blue-600 hover:bg-blue-700 text-white py-1 px-2 rounded" data-base64="${item.base64.split(',')[1]}" data-prompt="${item.prompt}">
                                    Edit
                                </button>
                            </div>

                            <!-- ‚òÖ ËøΩÂä†: „Éû„Éº„Ç≠„Éº„Ç≥„É≥„ÉÜ„Éä -->
                            <div class="history-info-container">
                                <div class="history-info-text-wrapper">
                                    <span class="history-info-text">${infoText}</span>
                                    <span class="history-info-text">${infoText}</span> <!-- „ÉÜ„Ç≠„Çπ„Éà„Çí2ÂõûÁπ∞„ÇäËøî„Åô -->
                                </div>
                            </div>
                        `;
                        
                        // „É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè (Ê©üËÉΩ3)
                        div.querySelector('img').addEventListener('click', () => showImageInModal(item.base64, item.prompt, item.translatedPrompt, item.base64.split(',')[1]));
                        
                        // History„ÅÆEdit„Éú„Çø„É≥
                        div.querySelector('button').addEventListener('click', (e) => {
                            e.stopPropagation(); // Ë¶™„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà„ÇíÁô∫ÁÅ´„Åï„Åõ„Å™„ÅÑ
                            const base64 = e.currentTarget.dataset.base64;
                            const prompt = e.currentTarget.dataset.prompt;
                            loadUploadedImage(`data:image/png;base64,${base64}`, prompt);
                        });

                        historyContainer.appendChild(div);

                        // ‚òÖ ÊñôÈáëË®àÁÆó
                        if (item.model === 'imagen-3.0-generate') {
                            totalCostUSD += PRICE_IMAGEN_USD;
                        } else if (item.model === 'gemini-2.5-flash-image-preview') {
                            totalCostUSD += PRICE_GEMINI_FLASH_IMAGE_USD;
                        } else {
                            // „É¢„Éá„É´ÊÉÖÂ†±„Åå„Å™„ÅÑÂè§„ÅÑ„Éá„Éº„Çø (‰ªÆ„Å´ImagenÊâ±„ÅÑ)
                            totalCostUSD += PRICE_IMAGEN_USD;
                        }
                    });
                }

                // ‚òÖ Áµ±Ë®àË°®Á§∫„ÇíÊõ¥Êñ∞
                statsTotalImages.textContent = items.length;
                statsCostUsd.textContent = `$${totalCostUSD.toFixed(3)}`; // Â∞èÊï∞ÁÇπ‰ª•‰∏ã3Ê°Å
                statsCostJpy.textContent = `¬•${Math.round(totalCostUSD * USD_JPY_RATE)}`;
            };
        }
        
        function clearOldHistory() {
            if (!db) return;
            const transaction = db.transaction(["images"], "readwrite");
            const objectStore = transaction.objectStore("images");
            objectStore.clear().onsuccess = () => {
                showToast("Old history cleared.", "success");
                loadHistory();
            };
        }

        // --- UI INITIALIZATION ---

        // ‚òÖ Â§âÊõ¥: „Çµ„Ç§„Éâ„Éê„Éº„Éà„Ç∞„É´„É≠„Ç∏„ÉÉ„ÇØ (PC/„Çπ„Éû„ÉõÂÖ±ÈÄö)
        function initSidebar() {
            sidebarToggleButton.addEventListener('click', () => {
                // „Çµ„Ç§„Éâ„Éê„Éº„ÅåÈñã„ÅÑ„Å¶„ÅÑ„Çã„Åã (translate-x-full „Åå *„Å™„ÅÑ* „Åã)
                const isSidebarOpen = !sidebar.classList.contains('-translate-x-full');

                if (isSidebarOpen) {
                    // Èñâ„Åò„Çã
                    sidebar.classList.add('-translate-x-full');
                    sidebar.classList.remove('md:translate-x-0'); // PCÁî®„ÅÆË°®Á§∫„ÇØ„É©„Çπ„ÇÇÂâäÈô§
                    mainContent.classList.remove('md:ml-64'); // PCÁî®„ÅÆ„Éû„Éº„Ç∏„É≥ÂâäÈô§
                } else {
                    // Èñã„Åè
                    sidebar.classList.remove('-translate-x-full');
                    sidebar.classList.add('md:translate-x-0'); // PCÁî®„ÅÆË°®Á§∫„ÇØ„É©„ÇπËøΩÂä†
                    mainContent.classList.add('md:ml-64'); // PCÁî®„ÅÆ„Éû„Éº„Ç∏„É≥ËøΩÂä†
                }
            });
            
            // „Çπ„Éû„ÉõÁî®„ÇØ„É≠„Éº„Ç∫„Éú„Çø„É≥ (Â§âÊõ¥„Å™„Åó)
            closeSidebarBtn.addEventListener('click', () => {
                sidebar.classList.add('-translate-x-full');
            });
        }

        function initStyles() {
            const container = document.getElementById('styles-container');
            STYLES.forEach(style => {
                const div = document.createElement('div');
                div.className = ""; 
                div.innerHTML = `
                    <input type="checkbox" id="style-${style}" value="${style}" class="hidden style-checkbox">
                    <label for="style-${style}" class="cursor-pointer bg-gray-700 text-gray-300 border border-gray-600 rounded-full px-4 py-2 text-sm font-medium hover:bg-gray-600 transition">
                        ${style}
                    </label>
                `;
                container.appendChild(div);
            });
        }

        // --- EVENT LISTENERS ---
        function initListeners() {
            generationForm.addEventListener('submit', handleGenerationSubmit);
            translateButton.addEventListener('click', handleTranslate);
            
            // ‚òÖ ËøΩÂä†: „Éó„É≠„É≥„Éó„Éà„Éú„Çø„É≥„É™„Çπ„Éä„Éº
            promptCopyButton.addEventListener('click', handlePromptCopy);
            promptClearButton.addEventListener('click', handlePromptClear);
            
            modalClose.addEventListener('click', () => imageModal.classList.remove('flex'));
            modalCopy.addEventListener('click', handleModalCopy);
            modalRegenerate.addEventListener('click', handleModalRegenerate);
            modalEdit.addEventListener('click', handleModalEdit); // ‚òÖ ËøΩÂä†
            
            editButton.addEventListener('click', () => toggleEditMode(true)); 
            closeImageButton.addEventListener('click', closeImage); // ‚òÖ ËøΩÂä†
            
            modelSelect.addEventListener('change', () => {
                // ‚òÖ Â§âÊõ¥: Á∑®ÈõÜ„É¢„Éº„Éâ‰∏≠„Å´ Imagen „ÇíÈÅ∏„Çì„Å†„ÇâÁ∑®ÈõÜ„É¢„Éº„ÉâËß£Èô§
                if (modelSelect.value === 'imagen-3.0-generate' && isEditingMode) {
                    toggleEditMode(false);
                }
                // ‚òÖ Â§âÊõ¥: Gemini „ÇíÈÅ∏„Çì„Å†„ÇâÔºàÁîªÂÉè„Åå„ÅÇ„Çå„Å∞ÔºâÁ∑®ÈõÜ„É¢„Éº„ÉâÁßªË°å
                if (modelSelect.value === 'gemini-2.5-flash-image-preview' && currentEditImageBase64) {
                    toggleEditMode(true);
                }
            });
            
            autoRetrySelect.addEventListener('change', () => {
                if(autoRetrySelect.value === '-1') {
                    const customRetry = prompt("Enter number of retries:", "15");
                    if (customRetry && !isNaN(parseInt(customRetry))) {
                        const val = parseInt(customRetry);
                        const newOption = new Option(`${val} Times (Custom)`, val, true, true);
                        autoRetrySelect.add(newOption);
                    } else {
                        autoRetrySelect.value = '0'; // Reset
                    }
                }
            });

            stylesToggleBtn.addEventListener('click', toggleStylesAccordion);
            promptInput.addEventListener('keydown', handlePromptKeydown);

            // ‚òÖ ËøΩÂä†: „Éâ„É©„ÉÉ„Ç∞ÔºÜ„Éâ„É≠„ÉÉ„Éó„É™„Çπ„Éä„Éº
            imageDisplay.addEventListener('dragover', handleDragOver);
            imageDisplay.addEventListener('dragleave', handleDragLeave);
            imageDisplay.addEventListener('drop', handleDrop);

            // ‚òÖ ËøΩÂä†: „Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„É™„Çπ„Éä„Éº
            uploadImageButton.addEventListener('click', () => uploadImageInput.click());
            uploadImageInput.addEventListener('change', handleFileSelect);
        }
        
        // --- CORE LOGIC ---

        function toggleStylesAccordion() {
            stylesContainer.classList.toggle('hidden');
            stylesChevron.classList.toggle('rotate-180');
        }

        function handlePromptKeydown(event) {
            if (isMobile) {
                return; // „É¢„Éê„Ç§„É´„Åß„ÅØÁÑ°Âäπ
            }
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault(); 
                const now = new Date().getTime();

                if (now - lastEnterPress < 500) {
                    handleGenerationSubmit(new Event('submit'));
                    lastEnterPress = 0; 
                } else {
                    lastEnterPress = now;
                    showToast("Press Enter again to send", "info"); 
                    setTimeout(() => {
                        if (lastEnterPress === now) {
                            lastEnterPress = 0;
                        }
                    }, 500); 
                }
            } else if (event.key !== 'Enter') {
                lastEnterPress = 0;
            }
        }

        // ‚òÖ ËøΩÂä†: ÁîªÂÉè„ÇØ„É≠„Éº„Ç∫Âá¶ÁêÜ
        function closeImage() {
            generatedImage.src = "";
            generatedImage.classList.add('hidden');
            placeholder.style.display = 'flex'; // 'flex'„Å´Êàª„Åô
            editButton.classList.add('hidden');
            closeImageButton.classList.add('hidden');
            currentEditImageBase64 = null;
            if (isEditingMode) {
                toggleEditMode(false);
            }
        }

        // ‚òÖ Â§âÊõ¥: Á∑®ÈõÜ„É¢„Éº„Éâ„Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÉºÂà∂Âæ° + „ÉÑ„Éº„É´„Éê„ÉºÂà∂Âæ°
        function toggleEditMode(forceOn) { 
            isEditingMode = forceOn;
            
            if (isEditingMode) {
                if (!currentEditImageBase64) {
                    showToast("No image to edit. Generate or upload an image first.", "warning");
                    isEditingMode = false;
                    return;
                }
                modelSelect.value = 'gemini-2.5-flash-image-preview';
                promptInput.placeholder = "Enter edit instructions (e.g., 'make the sky blue', 'add a hat')...";
                
                // ‚òÖ Â§âÊõ¥: „ÉÑ„Éº„É´„Éê„Éº„ÅÆÈ†ÖÁõÆ„ÇíÂÄãÂà•„Å´Âà∂Âæ°
                optionsToolbar.style.display = 'flex'; // „ÉÑ„Éº„É´„Éê„ÉºËá™‰Ωì„ÅØË°®Á§∫
                modelSelectGroup.style.display = 'none'; // „É¢„Éá„É´ÈÅ∏Êäû„ÅØÈö†„Åô
                autoRetryGroup.style.display = 'none'; // „É™„Éà„É©„Ç§„ÇÇÈö†„Åô
                // ‚òÖ ‰øÆÊ≠£: GeminiÁ∑®ÈõÜ„É¢„Éº„Éâ„Åß„ÅØ„Ç¢„Çπ„Éö„ÇØ„ÉàÊØî„ÅØÈùûË°®Á§∫ (API„Åå„Çµ„Éù„Éº„Éà„Åó„Å¶„ÅÑ„Å™„ÅÑ„Åü„ÇÅ)
                aspectRatioGroup.style.display = 'none'; 
                
                imageDisplay.classList.add('ring-4', 'ring-indigo-500');
                if (!stylesContainer.classList.contains('hidden')) {
                    toggleStylesAccordion();
                }
                editModeIndicator.classList.remove('hidden'); // ‚òÖ „Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÉºË°®Á§∫
            } else {
                modelSelect.value = 'imagen-3.0-generate';
                promptInput.placeholder = "Enter your prompt... (Non-English will be translated)";

                // ‚òÖ Â§âÊõ¥: „ÉÑ„Éº„É´„Éê„Éº„ÅÆÈ†ÖÁõÆ„ÇíÂÖ®„Å¶Ë°®Á§∫
                optionsToolbar.style.display = 'flex';
                modelSelectGroup.style.display = 'block';
                autoRetryGroup.style.display = 'block';
                aspectRatioGroup.style.display = 'block';

                imageDisplay.classList.remove('ring-4', 'ring-indigo-500');
                editModeIndicator.classList.add('hidden'); // ‚òÖ „Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÉºÈùûË°®Á§∫
            }
            // ‚òÖ „Éú„Çø„É≥„Ç¢„Ç§„Ç≥„É≥„ÇíÊõ¥Êñ∞
            setLoading(generateButton, false);
        }

        async function handleTranslate() {
            // ... (Â§âÊõ¥„Å™„Åó)
            const prompt = promptInput.value;
            if (!prompt) {
                showToast("Please enter text to translate", "warning");
                return;
            }
            setLoading(translateButton, true);
            try {
                // ‚òÖ Â§âÊõ¥: ÁøªË®≥„Ç≠„É£„É≥„Çª„É´Áî®„ÅÆ AbortController
                const controller = new AbortController();
                // ÁøªË®≥„Éú„Çø„É≥Ëá™‰Ωì„Çí„Ç≠„É£„É≥„Çª„É´ÂèØËÉΩ„Å´„ÅØ„Åó„Å™„ÅÑ„Åå„ÄÅ‰∏á„Åå‰∏Ä„ÅÆ„Çø„Ç§„É†„Ç¢„Ç¶„ÉàÁî®
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10Áßí„Çø„Ç§„É†„Ç¢„Ç¶„Éà

                const response = await fetchWithRetry('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'translate',
                        prompt: prompt
                    })
                }, 0, controller.signal); // „É™„Éà„É©„Ç§„Å™„Åó„ÄÅsignal„ÅÇ„Çä

                clearTimeout(timeoutId); // „Çø„Ç§„É†„Ç¢„Ç¶„ÉàËß£Èô§

                const data = await response.json();
                if (response.ok) {
                    promptInput.value = data.translatedPrompt;
                    showToast("Translation successful", "success");
                } else {
                    throw new Error(data.error || "Translation failed");
                }
            } catch (error) {
                console.error("Translate error:", error);
                if (error.name !== 'AbortError') {
                    showToast(error.message, "error");
                } else {
                    showToast("Translation timed out.", "error");
                }
            } finally {
                setLoading(translateButton, false);
            }
        }

        // ‚òÖ Â§âÊõ¥: „Ç≠„É£„É≥„Çª„É´Ê©üËÉΩ
        async function handleGenerationSubmit(event) {
            if (event) event.preventDefault(); 
            
            // ‚òÖ „Ç≠„É£„É≥„Çª„É´„É≠„Ç∏„ÉÉ„ÇØ
            if (generationInProgress) {
                if (currentFetchController) {
                    currentFetchController.abort();
                    showToast("Generation cancelled", "info");
                }
                // setLoading, generationInProgress „ÅÆ„É™„Çª„ÉÉ„Éà„ÅØ fetch „ÅÆ finally „ÅßË°å„ÅÜ
                return;
            }

            const prompt = promptInput.value;
            if (!prompt) {
                showToast("Please enter a prompt", "warning");
                return;
            }

            // ‚òÖ Á∑®ÈõÜ„É¢„Éº„Éâ„Åß„Éô„Éº„ÇπÁîªÂÉè„Åå„Å™„ÅÑÂ†¥Âêà„ÅÆ„Ç®„É©„Éº
            if (isEditingMode && !currentEditImageBase64) {
                 showToast("No image loaded for editing. Please upload or generate an image.", "warning");
                 toggleEditMode(false); // Á∑®ÈõÜ„É¢„Éº„Éâ„ÇíËß£Èô§
                 return;
            }

            generationInProgress = true;
            currentFetchController = new AbortController(); // ‚òÖ AbortController „ÇíÊñ∞Ë¶è‰ΩúÊàê
            setLoading(generateButton, true); // ‚òÖ „Ç¢„Ç§„Ç≥„É≥„Çí Stop „Å´Â§âÊõ¥
            loadingAnimation.classList.add('active');
            placeholder.style.display = 'none';
            generatedImage.classList.add('hidden');
            editButton.classList.add('hidden');
            closeImageButton.classList.add('hidden'); // ‚òÖ ÁîüÊàê‰∏≠„ÅØÈùûË°®Á§∫

            const selectedStyles = Array.from(document.querySelectorAll('.style-checkbox:checked')).map(cb => cb.value);
            const model = modelSelect.value; 
            apiKeyCounter++; 
            
            const payload = {
                action: isEditingMode ? 'edit' : 'generate',
                prompt: prompt,
                model: model, 
                keyIndex: apiKeyCounter, 
                aspectRatio: aspectRatioSelect.value, // ‚òÖ Á∑®ÈõÜ„É¢„Éº„Éâ„Åß„ÇÇÈÄÅ‰ø°„Åô„Çã„Åå„ÄÅ„Çµ„Éº„Éê„ÉºÂÅ¥ (generate.js) „ÅßÁÑ°Ë¶ñ„Åï„Çå„Çã
                styles: selectedStyles,
                baseImage: isEditingMode ? currentEditImageBase64 : null
            };

            const retryCount = parseInt(autoRetrySelect.value, 10);

            try {
                const response = await fetchWithRetry('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }, retryCount, currentFetchController.signal); // ‚òÖ signal „ÇíÊ∏°„Åô

                const data = await response.json();

                if (response.ok) {
                    const base64 = `data:image/png;base64,${data.base64}`;
                    generatedImage.src = base64;
                    generatedImage.classList.remove('hidden');
                    
                    currentEditImageBase64 = data.base64; // Save for editing
                    
                    // ‚òÖ Â§âÊõ¥: „É¢„Éá„É´ÊÉÖÂ†±„ÄÅ„Ç¢„Çπ„Éö„ÇØ„ÉàÊØî„ÄÅ„Çπ„Çø„Ç§„É´„ÇíÊ∏°„Åô
                    saveImageToDB(prompt, data.translatedPrompt || prompt, base64, model, aspectRatioSelect.value, selectedStyles); 
                    showToast(isEditingMode ? "Edit successful" : "Generation successful", "success");
                    editButton.classList.remove('hidden');
                    closeImageButton.classList.remove('hidden'); // ‚òÖ Ë°®Á§∫
                    
                    // ‚òÖ Â§âÊõ¥: Á∑®ÈõÜÊàêÂäüÂæå„ÄÅËá™Âãï„ÅßÁ∑®ÈõÜ„É¢„Éº„Éâ„ÇíÁ∂ôÁ∂ö
                    if (!isEditingMode) {
                         // „ÇÇ„ÅóÔºà„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å™„Å©„ÅßÔºâÁ∑®ÈõÜ„É¢„Éº„Éâ„Å´„Å™„Å£„Å¶„ÅÑ„Å™„Åã„Å£„Åü„Çâ„ÄÅ
                         // Á∑®ÈõÜÂèØËÉΩ„Å™„É¢„Éá„É´„ÅßÁîüÊàê„Åó„ÅüÂ†¥Âêà„ÅØÁ∑®ÈõÜ„É¢„Éº„Éâ„Å´ÂÖ•„Çã
                         if (model === 'gemini-2.5-flash-image-preview') {
                            toggleEditMode(true);
                         }
                    }

                    // ‚òÖ ËøΩÂä†: ÁîüÊàêÊàêÂäüÂæå„ÄÅ„Éó„É≠„É≥„Éó„Éà„Çí„ÇØ„É™„Ç¢
                    if (!isEditingMode) { // Á∑®ÈõÜ„É¢„Éº„Éâ„ÅÆÊôÇ„ÅØ„ÇØ„É™„Ç¢„Åó„Å™„ÅÑ
                        promptInput.value = "";
                    }
                    
                } else {
                    throw new Error(data.error || "Generation failed");
                }

            } catch (error) {
                console.error("Generation error:", error);
                if (error.name === 'AbortError') {
                    console.log("Fetch aborted by user.");
                } else {
                    showToast(error.message, "error");
                }
                // ‚òÖ „Ç≠„É£„É≥„Çª„É´ÊôÇ„ÇÑ„Ç®„É©„ÉºÊôÇ„Åß„ÇÇ„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„Å´Êàª„Åï„Å™„ÅÑ (ÂâçÂõû„ÅÆÁîªÂÉè„ÅåÊÆã„Çã„Çà„ÅÜ„Å´„Åô„Çã)
                if (!currentEditImageBase64) {
                    placeholder.style.display = 'flex';
                } else {
                    generatedImage.classList.remove('hidden');
                    editButton.classList.remove('hidden');
                    closeImageButton.classList.remove('hidden');
                }
            } finally {
                setLoading(generateButton, false); // ‚òÖ „Ç¢„Ç§„Ç≥„É≥„ÇíÂÖÉ„Å´Êàª„Åô
                loadingAnimation.classList.remove('active');
                generationInProgress = false; // ‚òÖ „Çπ„ÉÜ„Éº„Éà„Çí„É™„Çª„ÉÉ„Éà
                currentFetchController = null;
            }
        }
        
        // ‚òÖ Â§âÊõ¥: AbortSignal „ÇíÂºïÊï∞„Å´ËøΩÂä†
        async function fetchWithRetry(url, options, retries = 0, signal = null) {
            let attempt = 0;
            const maxRetries = retries < 0 ? 0 : retries; 

            // ‚òÖ signal „Çí options „Å´ËøΩÂä†
            if (signal) {
                options.signal = signal;
            }

            while (attempt <= maxRetries) {
                try {
                    if (attempt > 0) {
                        showToast(`Retrying... (Attempt ${attempt} of ${maxRetries})`, "warning");
                    }
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: `Server error: ${response.status}` }));
                        throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                    }
                    return response; 
                } catch (error) {
                    // ‚òÖ AbortError „ÅØ„É™„Éà„É©„Ç§„Åó„Å™„ÅÑ
                    if (error.name === 'AbortError') {
                        throw error;
                    }
                    console.warn(`Attempt ${attempt} failed:`, error.message);
                    if (attempt === maxRetries) {
                        throw error; 
                    }
                    attempt++;
                    await new Promise(res => setTimeout(res, 1000 * attempt)); 
                }
            }
        }

        // --- ‚òÖ ËøΩÂä†: „Éó„É≠„É≥„Éó„ÉàÂÖ•ÂäõÁî®„Éò„É´„Éë„Éº ---

        function handlePromptCopy() {
            const textToCopy = promptInput.value;
            if (!textToCopy) {
                showToast("Nothing to copy", "info");
                return;
            }
            navigator.clipboard.writeText(textToCopy).then(() => {
                showToast("Prompt copied to clipboard!", "success");
            }).catch(err => {
                console.error('Clipboard copy failed:', err);
                try {
                    // Fallback for insecure contexts (like http or iframes)
                    const textArea = document.createElement("textarea");
                    textArea.value = textToCopy;
                    textArea.style.position = "fixed"; // Prevent scrolling to bottom
                    textArea.style.top = "0";
                    textArea.style.left = "0";
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showToast("Prompt copied to clipboard!", "success");
                } catch (fallbackErr) {
                    console.error('Fallback copy failed:', fallbackErr);
                    showToast("Failed to copy prompt", "error");
                }
            });
        }

        function handlePromptClear() {
            promptInput.value = "";
            showToast("Input cleared", "info");
        }


        // --- MODAL & TOAST functions ---
        
        // ‚òÖ Â§âÊõ¥: base64 (raw) „ÇÇ„Éá„Éº„Çø„Çª„ÉÉ„Éà„Å´‰øùÂ≠ò
        function showImageInModal(base64DataUrl, prompt, translatedPrompt, rawBase64) {
            modalImage.src = base64DataUrl;
            modalPrompt.textContent = translatedPrompt || prompt;
            modalRegenerate.dataset.prompt = prompt;
            modalRegenerate.dataset.translatedPrompt = translatedPrompt;
            modalEdit.dataset.base64 = rawBase64; // ‚òÖ Raw Base64
            modalEdit.dataset.prompt = prompt; // ‚òÖ ÂÖÉ„ÅÆ„Éó„É≠„É≥„Éó„Éà
            imageModal.classList.add('flex');
        }
        
        // ‚òÖ Â§âÊõ¥: „ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Ç≥„Éî„Éº„ÅÆFallback„ÇíÊîπÂñÑ
        function handleModalCopy() {
            const textToCopy = modalPrompt.textContent;
            navigator.clipboard.writeText(textToCopy).then(() => {
                showToast("Prompt copied to clipboard!", "success");
            }).catch(err => {
                console.error('Clipboard copy failed:', err);
                try {
                    const textArea = document.createElement("textarea");
                    textArea.value = textToCopy;
                    textArea.style.position = "fixed";
                    textArea.style.top = "0";
                    textArea.style.left = "0";
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showToast("Prompt copied to clipboard!", "success");
                } catch (fallbackErr) {
                    console.error('Fallback copy failed:', fallbackErr);
                    showToast("Failed to copy prompt", "error");
                }
            });
        }
        
        function handleModalRegenerate() {
            // ... (Â§âÊõ¥„Å™„Åó)
            const prompt = modalRegenerate.dataset.prompt;
            promptInput.value = prompt;
            imageModal.classList.remove('flex');
            if (isEditingMode) {
                toggleEditMode(false);
            }
            handleGenerationSubmit(new Event('submit')); 
        }

        // ‚òÖ ËøΩÂä†: „É¢„Éº„ÉÄ„É´„Åã„Çâ„ÅÆÁ∑®ÈõÜ
        function handleModalEdit() {
            const base64 = modalEdit.dataset.base64;
            const prompt = modalEdit.dataset.prompt;
            loadUploadedImage(`data:image/png;base64,${base64}`, prompt);
            imageModal.classList.remove('flex');
        }

        function showToast(message, type = "success") {
            // ... (Â§âÊõ¥„Å™„Åó)
            toastMessage.textContent = message;
            toast.className = `fixed top-20 right-6 text-white py-2 px-6 rounded-lg shadow-lg transition-all duration-300 opacity-0 -translate-y-10 z-50`; // Reset
            
            if (type === "error") {
                toast.classList.add('bg-red-600');
            } else if (type === "warning") {
                toast.classList.add('bg-yellow-500');
            } else if (type === "info") { 
                toast.classList.add('bg-blue-600');
            } else {
                toast.classList.add('bg-green-600');
            }

            toast.classList.remove('opacity-0', '-translate-y-10');
            toast.classList.add('opacity-100', 'translate-y-0');

            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-y-0');
                toast.classList.add('opacity-0', '-translate-y-10');
            }, 3000); 
        }
        
        // ‚òÖ Â§âÊõ¥: „Ç¢„Ç§„Ç≥„É≥Âàá„ÇäÊõø„Åà (isEditingMode ÂØæÂøú)
        function setLoading(button, isLoading) {
            if (button.id === 'generate-button') {
                const icon = button.querySelector('svg use');
                if (isLoading) {
                    button.disabled = false; // ‚òÖ „Ç≠„É£„É≥„Çª„É´„ÅÆ„Åü„ÇÅ
                    button.classList.add('bg-red-600', 'hover:bg-red-700'); // ‚òÖ ÂÅúÊ≠¢„Éú„Çø„É≥„ÅÆËâ≤
                    button.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                    if (icon) icon.setAttribute('href', '#icon-stop');
                    button.dataset.tooltip = "Cancel Generation";
                } else {
                    button.disabled = false;
                    button.classList.remove('bg-red-600', 'hover:bg-red-700');
                    button.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                    
                    // ‚òÖ Â§âÊõ¥: isEditingMode „Å´Âøú„Åò„Å¶„Ç¢„Ç§„Ç≥„É≥„ÇíÂàá„ÇäÊõø„Åà
                    if (isEditingMode) {
                        if (icon) icon.setAttribute('href', '#icon-edit');
                        button.dataset.tooltip = "Apply Edit";
                    } else {
                        if (icon) icon.setAttribute('href', '#icon-send');
                        button.dataset.tooltip = "Generate";
                    }
                }
            } else {
                // ‰ªñ„ÅÆ„Éú„Çø„É≥ (ÁøªË®≥„Éú„Çø„É≥„Å™„Å©)
                const icon = button.querySelector('svg');
                if (isLoading) {
                    button.disabled = true;
                    if (icon) icon.classList.add('animate-spin'); 
                } else {
                    button.disabled = false;
                    if (icon) icon.classList.remove('animate-spin');
                }
            }
        }

        // --- ‚òÖ ËøΩÂä†: D&D / Upload Handlers ---

        function handleDragOver(event) {
            event.preventDefault();
            if (generationInProgress || isEditingMode) return;
            imageDisplay.classList.add('drag-over');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            imageDisplay.classList.remove('drag-over');
        }

        function handleDrop(event) {
            event.preventDefault();
            imageDisplay.classList.remove('drag-over');
            if (generationInProgress) return;

            const file = event.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                readImageFile(file);
            } else {
                showToast("Please drop an image file (PNG, JPG, etc.)", "warning");
            }
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                readImageFile(file);
            }
            uploadImageInput.value = null; // Âêå„Åò„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åß„Åç„Çã„Çà„ÅÜ„Å´„É™„Çª„ÉÉ„Éà
        }

        function readImageFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                loadUploadedImage(e.target.result);
            };
            reader.onerror = (e) => {
                showToast("Failed to read image file.", "error");
            };
            reader.readAsDataURL(file);
        }

        /**
         * „Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åæ„Åü„ÅØHistory„Åã„ÇâÁîªÂÉè„ÇíË™≠„ÅøËæº„Åø„ÄÅÁ∑®ÈõÜ„É¢„Éº„Éâ„Å´Ë®≠ÂÆö„Åô„Çã
         * @param {string} base64DataUrl (Data URL: "data:image/...")
         * @param {string} [prompt] (History„Åã„ÇâË™≠„ÅøËæº„ÇÄÂ†¥Âêà„ÅÆÊó¢Â≠ò„Éó„É≠„É≥„Éó„Éà)
         */
        function loadUploadedImage(base64DataUrl, prompt = "") {
            generatedImage.src = base64DataUrl;
            generatedImage.classList.remove('hidden');
            placeholder.style.display = 'none';
            
            // "data:image/png;base64," „ÅÆÈÉ®ÂàÜ„ÇíÂâäÈô§
            currentEditImageBase64 = base64DataUrl.split(',')[1]; 
            
            editButton.classList.remove('hidden');
            closeImageButton.classList.remove('hidden');
            
            showToast("Image loaded. Ready to edit.", "info");
            toggleEditMode(true); // Á∑®ÈõÜ„É¢„Éº„Éâ„Å´Ë®≠ÂÆö

            if (prompt) {
                promptInput.value = prompt;
            } else {
                // „Éó„É≠„É≥„Éó„ÉàÂÖ•ÂäõÊ¨Ñ„Çí„ÇØ„É™„Ç¢„Åæ„Åü„ÅØÊåáÁ§∫„ÇíË°®Á§∫
                promptInput.value = ""; // Êñ∞Ë¶è„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÊôÇ„ÅØ„ÇØ„É™„Ç¢
            }
        }

    </script>
</body>
</html>

