# Node.js
node_modules
npm-debug.log
yarn-error.log

# Cloudflare Wrangler (local development)
.wrangler
.dev.vars

# OS specific
.DS_Store
Thumbs.db

# Logs
*.log


---

### 4. Google Apps Script (GAS) の設定（重要！）

これはファイルとして生成するのではなく、**あなた自身がGoogleアカウントで設定する必要がある**ものです。このスクリプトが、Cloudflare Functionから送られてきたデータを受け取り、スプレッドシートとGoogle Driveに保存する役割を果たします。

**手順:**

1.  **Google スプレッドシートの作成:**
    * 新しいスプレッドシートを作成し、名前を付けます（例: `muGen_History`）。
    * 1行目にヘッダー（見出し）を入力します:
        `Timestamp`, `Model`, `Prompt`, `TranslatedPrompt`, `ImageURL`
2.  **Google Drive フォルダの作成:**
    * 画像を保存するためのフォルダをGoogle Driveに作成します（例: `muGen_Images`）。
    * このフォルダのIDをメモしておきます。（URLの `folders/` の後に続く文字列です）。
3.  **GAS スクリプトエディタを開く:**
    * スプレッドシートの「拡張機能」>「Apps Script」を開きます。
4.  **コードの貼り付け:**
    * `Code.gs` の内容をすべて消し、以下のコードを貼り付けます。
    * **重要:** コード内の `YOUR_FOLDER_ID_HERE` を、手順2でメモした実際のフォルダIDに置き換えてください。

```javascript
//
// Google Apps Script (Code.gs)
// This code runs on Google's servers.
//
const SPREADSHEET_ID = SpreadsheetApp.getActiveSpreadsheet().getId();
const SHEET_NAME = SpreadsheetApp.getActiveSpreadsheet().getSheets()[0].getName(); // Use the first sheet
const DRIVE_FOLDER_ID = "YOUR_FOLDER_ID_HERE"; // <-- !!! REPLACE THIS !!!

/**
 * Handles POST requests from the Cloudflare Function.
 */
function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    
    const { prompt, translatedPrompt, base64Data, model } = data;
    
    // 1. Save image to Google Drive
    const folder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
    const decoded = Utilities.base64Decode(base64Data, Utilities.Charset.UTF_8);
    const blob = Utilities.newBlob(decoded, "image/png");
    
    const timestamp = new Date();
    const fileName = `muGen_${timestamp.toISOString().replace(/:/g, '-')}.png`;
    const file = folder.createFile(blob.setName(fileName));
    
    const fileUrl = file.getUrl();
    
    // 2. Save metadata to Spreadsheet
    const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME);
    sheet.appendRow([
      timestamp,
      model,
      prompt,
      translatedPrompt,
      fileUrl
    ]);

    // Return a success response
    return ContentService.createTextOutput(JSON.stringify({ status: "success", url: fileUrl }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    // Log error to Google Cloud Logging
    console.error("GAS Error:", error, e.postData.contents);
    return ContentService.createTextOutput(JSON.stringify({ status: "error", message: error.message }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

5.  **デプロイ (Webアプリとして):**
    * スクリプトエディタの右上にある「デプロイ」ボタンをクリック。
    * 「新しいデプロイ」を選択。
    * 「種類の選択」で「Web アプリ」を選択。
    * 「アクセスできるユーザー」を「**全員**」に設定します。（**重要:** これを設定しないとCloudflareからアクセスできません）。
    * 「デプロイ」をクリックし、許可を求められたら許可します。
    * **生成された「Web アプリの URL」をコピーします。** これが `GAS_WEB_APP_URL` です。

---

### デプロイと設定の手順

1.  **GitHub リポジトリの作成:**
    * GitHubで `muGen` リポジトリを作成します。
    * 上記で生成した3つのファイル（`index.html`, `.gitignore`, `functions/api/generate.js`）を、指定されたフォルダ構成（`muGen/` フォルダ以下）でプッシュします。
2.  **Cloudflare Pages の設定:**
    * Cloudflare Pagesで新しいプロジェクトを作成し、GitHubの `muGen` リポジトリに接続します。
    * ビルド設定は「なし」または「静的サイト」で大丈夫です。
3.  **Cloudflare 環境変数の設定:**
    * Cloudflare Pagesのプロジェクト設定 >「環境変数」で、以下の変数をすべて設定します。
    * `GAS_WEB_APP_URL`: GASのデプロイで取得したWebアプリURL。
    * `GEMINI_API_KEY_01`: あなたのAPIキー (1)
    * `GEMINI_API_KEY_02`: あなたのAPIキー (2)
    * ...
    * `GEMINI_API_KEY_10`: あなたのAPIキー (10)

これで、Cloudflare PagesのURL（例: `mugen.pages.dev`）にアクセスすれば、アプリが動作するはずです。

少し設定が複雑ですが、この構成によって、APIキーを安全に管理しつつ、生成履歴も自動でGoogle Driveとスプレッドシートに保存できる、とても強力なアプリになります。

わからないことがあれば、いつでも聞いてくださいね！
